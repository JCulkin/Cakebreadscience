<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Across Wizard World ‚Äî A Straight Line Odyssey</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        #game-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(15, 52, 96, 0.8);
            border: 3px solid #00d4ff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
            min-height: 60vh;
            display: grid;
            grid-template-columns: 200px 1fr 250px;
            gap: 30px;
            align-items: start;
        }
        h1 {
            color: #ffff00;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.5);
            animation: flicker 3s infinite;
            grid-column: 1 / -1;
        }
        #story {
            flex: 1;
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 1.1em;
            border-left: 4px solid #ff00ff;
            padding-left: 20px;
            color: #fff;
            min-height: 150px;
        }
        #avatar-panel {
            background: rgba(100, 50, 150, 0.3);
            border: 2px solid #ff00ff;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            grid-column: 1;
            grid-row: 2;
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        #avatar-panel h3 {
            color: #ffff00;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #avatar-display {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
        }
        .equip-slot {
            font-size: 0.75em;
            margin: 4px 0;
            color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
            padding: 4px 6px;
            border-radius: 4px;
            word-break: break-word;
        }
        #stats-panel {
            background: rgba(50, 100, 150, 0.3);
            border: 2px solid #00d4ff;
            border-radius: 12px;
            padding: 15px;
            grid-column: 3;
            grid-row: 2;
            height: fit-content;
            position: sticky;
            top: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        #stats-panel h3 {
            color: #ffff00;
            font-size: 0.9em;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-group {
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding-bottom: 12px;
        }
        .stat-group:last-child {
            border-bottom: none;
        }
        .stat-name {
            color: #00d4ff;
            font-size: 0.85em;
            font-weight: bold;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-level {
            color: #ffff00;
            font-weight: bold;
            font-size: 0.9em;
        }
        .stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        .stat-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #ff00ff);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        #inventory-panel {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }
        #inventory-panel h4 {
            color: #ffff00;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .inventory-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 190, 11, 0.5);
            border-radius: 4px;
            padding: 6px 8px;
            margin: 4px 0;
            font-size: 0.8em;
            color: #ffff00;
        }
        #inventory-display {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 6px;
            max-height: 40vh;
            overflow: auto;
            padding-right: 6px;
        }
        #center-column {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
        }
        .choice-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            background: linear-gradient(90deg, #ff006e, #fb5607);
            color: #fff;
            border: 2px solid #ffbe0b;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 200ms;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            text-align: left;
        }
        .choice-button:hover {
            background: linear-gradient(90deg, #ffbe0b, #fb5607);
            transform: translateX(10px);
            box-shadow: 0 0 15px rgba(255, 190, 11, 0.6);
        }
        .choice-button:active {
            transform: translateX(5px);
        }
        #ending-text {
            font-size: 1.2em;
            color: #ffff00;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
        }
        .reset-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-top: 20px;
            background: #008080;
            color: #ffff00;
            border: 2px solid #ffff00;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 200ms;
        }
        .reset-button:hover {
            background: #00d4d4;
            box-shadow: 0 0 15px rgba(0, 212, 212, 0.6);
        }
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; text-shadow: 0 0 20px rgba(255, 255, 0, 0.8); }
        }
        .silly-stat {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: auto;
            background: rgba(255, 0, 255, 0.18);
            border: 2px solid #ff00ff;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.95em;
            color: #ffff00;
            pointer-events: none;
            z-index: 9000;
        }
        a.back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00d4ff;
            text-decoration: none;
            font-weight: bold;
            transition: all 200ms;
        }
        a.back-link:hover {
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
        }
        @media (max-width: 1200px) {
            #game-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            #avatar-panel, #stats-panel {
                grid-column: 1;
                position: relative;
                top: auto;
            }
            #center-column {
                grid-column: 1;
            }
            #stats-panel {
                max-height: none;
            }
        }
        /* Inline notification box shown above the story (click to dismiss) */
        #inline-notifications { margin-bottom: 12px; display:flex; flex-direction:column; gap:8px; }
        .inline-notice { background: rgba(0,0,0,0.9); border: 2px solid #00d4ff; padding: 10px 12px; border-radius:8px; color:#fff; cursor:pointer; }
        .inline-notice small { display:block; color:#9fe6ff; margin-top:6px; font-size:0.8em; }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">‚Üê Back to Arcane Studies</a>
    
    <div id="game-container">
        <h1>üß≠ ACROSS WIZARD WORLD ‚Äî A STRAIGHT LINE ODYSSEY üßô‚Äç‚ôÇÔ∏è</h1>

        <div id="avatar-panel">
            <h3>Avatar</h3>
            <div id="avatar-display">üë§</div>
            <div class="equip-slot" id="hat-slot">Hat: None</div>
            <div class="equip-slot" id="outfit-slot">Outfit: Tattered Rags</div>
            <div class="equip-slot" id="accessory-slot">Accessory: None</div>
            <div id="inventory-compact" style="margin-top:12px;">
                <h4 style="margin-bottom:6px;color:#ffff00;font-size:0.85em;text-transform:uppercase;letter-spacing:1px;">Inventory (compact)</h4>
                <div id="inventory-compact-display" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
            </div>
            <button id="restart-button" class="reset-button" style="margin-top:10px;">Restart Run</button>
        </div>

        <div id="center-column">
            <div id="story"></div>
            <div id="choices"></div>
            <div id="ending-text"></div>
        </div>

        <div id="stats-panel">
            <h3>Skills</h3>
            <button id="training-button" class="choice-button" style="margin-bottom:12px;">üèãÔ∏è Training Grounds</button>
            <div id="skills-container"></div>
        </div>
    </div>

    <div class="silly-stat" id="silly-stat">Silliness Level: 1%</div>

    <script>
        const gameState = {
            scene: 0,
            silliness: 1,
            overallLevel: 1,
            choices: [],
            skills: {
                "Arcane Mechanics": 1,
                "Alchemical Theory": 1,
                "Life Force Study": 1,
                "Numerical Harmony": 1,
                "Linguistic Arts": 1,
            },
            unlockedSkills: [
                "Arcane Mechanics",
                "Alchemical Theory",
                "Life Force Study",
                "Numerical Harmony",
                "Linguistic Arts"
            ],
            skillMatrix: {},
            itemMatrix: {},
            inventory: ["Worn Quill Pen"],
            avatar: {
                hair: "Brown",
                hat: "None",
                outfit: "Tattered Rags",
                accessory: "None",
                role: null
            },
            questsCompleted: 0
        };

        // define the five core skills that are tracked permanently
        const coreSkills = [
            "Arcane Mechanics",
            "Alchemical Theory",
            "Life Force Study",
            "Numerical Harmony",
            "Linguistic Arts"
        ];

        // All available skills (unlocked through quests)
        const allSkills = {
            "Arcane Mechanics": "Physics",
            "Alchemical Theory": "Chemistry",
            "Life Force Study": "Biology",
            "Numerical Harmony": "Maths",
            "Linguistic Arts": "English",
            "Automatons & Logic": "Computer Science",
            "Temporal Chronicles": "History",
            "Cartography & Navigation": "Geography",
            "Trade & Commerce": "Economics",
            "Mercantile Mastery": "Business Studies",
            "Aesthetic Crafting": "Art & Design",
            "Harmonic Resonance": "Music",
            "Theatrical Expression": "Drama",
            "Literary Mastery": "Literature",
            "Polyglot Studies": "Languages",
            "Ecological Balance": "Environmental Science",
            "Social Dynamics": "Sociology",
            "Mind Theory": "Psychology"
        };

        // Short single-word labels for UI display (fallbacks used if missing)
        const skillShort = {
            "Arcane Mechanics": "Mechanics",
            "Alchemical Theory": "Alchemy",
            "Life Force Study": "Biology",
            "Numerical Harmony": "Maths",
            "Linguistic Arts": "Language",
            "Automatons & Logic": "Logic",
            "Temporal Chronicles": "History",
            "Cartography & Navigation": "Navigation",
            "Trade & Commerce": "Trade",
            "Mercantile Mastery": "Business",
            "Aesthetic Crafting": "Craft",
            "Harmonic Resonance": "Music",
            "Theatrical Expression": "Drama",
            "Literary Mastery": "Literature",
            "Polyglot Studies": "Languages",
            "Ecological Balance": "Ecology",
            "Social Dynamics": "Society",
            "Mind Theory": "Psychology"
        };

        // Five most common basic items
        const basicItems = ["Candle", "Rope", "Glue", "Stick", "Green Bottle"];
        
        // Large pool of weird unique items
        const weirdItems = [
            "Bug", "Unidentified Pile", "Suspicious Custard", "Wise Yeast", "Half a Bubble",
            "Phantom Teacup", "Singing Horseshoe", "Moonbeam Lens", "Baffin's Button",
            "Scribbled Map Fragment", "Velvet Pocketwatch", "Soapbox Gauntlet", "Lantern of Mild Regret", "Corked Star Bottle",
            "Compass of Questionable Accuracy", "Moth-Eaten Cloak", "Golden Cheese Token", "Coral Whistle", "Dancing Spoon",
            "Leather-bound Almanac", "Sturdy Knot", "Rusty Cog", "Polished Pebble", "Cracked Hourglass", "Tiny Sextant",
            "Notebook of Half-Thoughts", "Glass Eye of the Admiral", "Bottle of Yesterday", "Fisherman's Locket", "Scented Rope",
            "Weathered Badge", "Patchwork Gloves", "Meteorite Shard", "Ship's Whisper (jar)", "Wind-caught Ribbon",
            "Pocket Telescope", "Murmuring Coin", "Philosopher's Chew Toy", "Invisible Ink Vial", "Knot of Holding",
            "Ceramic Fox Pin", "Miniature Anchor", "Lively Caper Cap", "Mirror of Small Truths", "Feathered Ledger", "Worn Map Case",
            "Perfumed Pebble", "Tiny Brass Key", "Seafarer's Broth Token", "Tarnished Medal", "Lucky Nail", "Crimson Crumb",
            "Folding Garden Spade", "Silvered Straw", "Harmonious Pebble", "Patch of Soft Moss", "Button of Remembrance",
            "Pigeon Feather Quill", "Stargazer's Chip", "Mysterious Coin", "Pocketbread Voucher", "Threadbare Glove",
            "Clockwork Beetle", "Glow-in-the-Dark Pebble", "Rumpled Poem Scroll", "Cerulean Shell", "Ambered Seed",
            "Brass Compass", "Glowing Scroll", "Therapeutic Scrolls", "Carved Statue Key", "Torn Drill Notes",
            "Smoky Flask", "Herbal Bundle"
        ];
        
        // Level names (1-9)
        const levelNames = ["Novice", "Apprentice", "Journeyman", "Adept", "Master", "Luminary", "Sage", "Archmage", "Omniscient"];



        function showTopNotification(msg){
            try{
                const el = document.createElement('div');
                el.style.position = 'fixed';
                el.style.left = '50%';
                el.style.transform = 'translateX(-50%)';
                el.style.top = '12px';
                el.style.background = 'rgba(0,0,0,0.85)';
                el.style.color = '#fff';
                el.style.padding = '10px 16px';
                el.style.border = '2px solid #00d4ff';
                el.style.borderRadius = '8px';
                el.style.zIndex = 12000;
                el.style.fontFamily = 'Courier New, monospace';
                el.textContent = msg;
                document.body.appendChild(el);
                setTimeout(()=>{ el.style.transition='opacity 400ms'; el.style.opacity='0'; setTimeout(()=>el.remove(),420); }, 2800);
            }catch(e){}
        }

        function unlockSkill(skillName) {
            // only allow unlocking of core skills (we keep system to five skills)
            if (!coreSkills.includes(skillName)) {
                showTopNotification('Not tracked: ' + skillName);
                return;
            }
            if (!gameState.unlockedSkills.includes(skillName)) {
                gameState.unlockedSkills.push(skillName);
            }
            if (!gameState.skills[skillName]) gameState.skills[skillName] = 1;
            showTopNotification('New skill unlocked: ' + skillName);
            savePersistentState();
            updateStatsDisplay();
        }

        function upgradeSkill(skillName) {
            // only allow upgrades to core skills
            if (!coreSkills.includes(skillName)) return;
            const oldLevel = gameState.skills[skillName] || 0;
            const newLevel = Math.min(9, oldLevel + 1);
            gameState.skills[skillName] = newLevel;
            // also update overall level as average of core skills
            const avgLevel = Math.ceil(coreSkills.reduce((sum, s) => sum + (gameState.skills[s] || 1), 0) / coreSkills.length);
            gameState.overallLevel = Math.max(1, Math.min(9, avgLevel));
            // log to skillMatrix
            if(!gameState.skillMatrix) gameState.skillMatrix = {};
            if(!gameState.skillMatrix[skillName]) gameState.skillMatrix[skillName] = [];
            gameState.skillMatrix[skillName].push({ ts: Date.now(), old: oldLevel, new: newLevel, reason: 'upgrade' });
            showTopNotification('Skill increased: ' + skillName + ' ‚Üí ' + newLevel);
            savePersistentState();
            updateStatsDisplay();
        }

        function upgradeAllCore() {
            coreSkills.forEach(skill => {
                upgradeSkill(skill);
            });
            showTopNotification('All core skills increased!');
        }

        function addInventoryItem(item, source = 'quest') {
            if(!gameState.itemMatrix) gameState.itemMatrix = {};
            // prevent duplicates in the persistent item matrix
            if(gameState.itemMatrix[item]){
                showTopNotification('Already discovered: ' + item);
                return;
            }
            // record in the persistent matrix (never removed)
            gameState.itemMatrix[item] = { firstAcquired: Date.now(), source };
            // also keep quick discovery mapping for legacy UI
            if(!gameState.discovered) gameState.discovered = {};
            gameState.discovered[item] = true;
            // add to current inventory so the player can equip/use it
            gameState.inventory.push(item);
            showTopNotification('New discovery: ' + item);
            savePersistentState();
            updateInventoryDisplay();
        }

        function populatePeriodicInventory() {
            // Give the player the 5 basic items
            basicItems.forEach(el=>{
                if(!gameState.itemMatrix) gameState.itemMatrix = {};
                if(!gameState.itemMatrix[el]){
                    gameState.itemMatrix[el] = { firstAcquired: Date.now(), source: 'basic' };
                    gameState.inventory.push(el);
                }
            });
            showTopNotification('Your inventory now contains 5 basic items.');
            savePersistentState();
            updateInventoryDisplay();
        }

        function showRoleSelector(){
            const existing = document.getElementById('role-select-overlay');
            if(existing) return;
            const overlay = document.createElement('div');
            overlay.id = 'role-select-overlay';
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.right = '0';
            overlay.style.bottom = '0';
            overlay.style.background = 'rgba(0,0,0,0.75)';
            overlay.style.zIndex = 12000;
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';

            const box = document.createElement('div');
            box.style.background = '#071330';
            box.style.border = '2px solid #00d4ff';
            box.style.padding = '24px';
            box.style.borderRadius = '12px';
            box.style.color = '#fff';
            box.style.maxWidth = '700px';
            box.style.textAlign = 'center';

            box.innerHTML = `<h2 style="color:#ffdd57;margin-bottom:8px">Choose your beginning</h2><p style="margin-bottom:12px">Will you begin as a veteran Jedi Wizard or a curious Young Padawan?</p>`;

            const btnJedi = document.createElement('button');
            btnJedi.className = 'choice-button';
            btnJedi.textContent = 'ü™Ñ Jedi Wizard ‚Äî experienced, slightly mysterious';
            btnJedi.style.margin = '8px';
            btnJedi.onclick = () => {
                gameState.avatar.role = 'Jedi Wizard';
                // grant stronger starting skills (log via upgradeSkill)
                coreSkills.forEach(skill => { upgradeSkill(skill); upgradeSkill(skill); });
                populatePeriodicInventory();
                showTopNotification('You begin as a Jedi Wizard. Skills boosted!');
                document.body.removeChild(overlay);
                updateStatsDisplay();
            };

            const btnPad = document.createElement('button');
            btnPad.className = 'choice-button';
            btnPad.textContent = 'üßë‚Äçüéì Young Padawan ‚Äî eager, lower starting skills';
            btnPad.style.margin = '8px';
            btnPad.onclick = () => {
                gameState.avatar.role = 'Young Padawan';
                // small boost (log via upgradeSkill)
                coreSkills.forEach(skill => { upgradeSkill(skill); });
                // keep quill pen but also add basic items for fun
                gameState.inventory = ['Worn Quill Pen', ...basicItems.slice()];
                savePersistentState();
                updateInventoryDisplay();
                showTopNotification('You begin as a Young Padawan. Keep learning!');
                document.body.removeChild(overlay);
                updateStatsDisplay();
            };

            box.appendChild(btnJedi);
            box.appendChild(btnPad);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
        }

        function savePersistentState(){
            try{
                const toSave = {
                    // persist matrices only; do not persist active runtime skills/inventory
                    skillMatrix: gameState.skillMatrix || {},
                    itemMatrix: gameState.itemMatrix || {},
                    // keep a light record of avatar and unlocked skills for UX continuity
                    unlockedSkills: gameState.unlockedSkills,
                    avatar: { role: gameState.avatar && gameState.avatar.role ? gameState.avatar.role : null }
                };
                localStorage.setItem('ridiculous_voyage_state', JSON.stringify(toSave));
            }catch(e){console.error('save error',e);}            
        }

        function loadPersistentState(){
            try{
                const raw = localStorage.getItem('ridiculous_voyage_state');
                if(!raw) return;
                const s = JSON.parse(raw);
                // Only restore persistent matrices and light UI state. Do NOT overwrite
                // active runtime skills or inventory so page reloads start fresh.
                if(s.unlockedSkills) gameState.unlockedSkills = Array.from(new Set([...(gameState.unlockedSkills||[]), ...s.unlockedSkills]));
                if(s.skillMatrix) {
                    gameState.skillMatrix = Object.assign({}, gameState.skillMatrix || {}, s.skillMatrix);
                    coreSkills.forEach(k=>{ if(!gameState.skillMatrix[k]) gameState.skillMatrix[k]=[]; });
                }
                if(s.itemMatrix){
                    gameState.itemMatrix = Object.assign({}, gameState.itemMatrix || {}, s.itemMatrix);
                }
                if(s.avatar && s.avatar.role) {
                    // keep only the saved role as a hint; we'll still prompt on fresh runs
                    gameState.avatar.role = s.avatar.role;
                }
            }catch(e){console.error('load error',e);}            
        }

        function updateStatsDisplay() {
            const container = document.getElementById('skills-container');
            container.innerHTML = '';
            
            // Show overall level at top
            const overallDiv = document.createElement('div');
            overallDiv.className = 'stat-group';
            const overallLevel = gameState.overallLevel || 1;
            const overallLevelName = levelNames[Math.max(0, Math.min(8, overallLevel - 1))];
            overallDiv.innerHTML = `
                <div class="stat-name" title="Overall Level">
                    <span>Overall</span>
                    <span class="stat-level">${overallLevel} (${overallLevelName})</span>
                </div>
                <div class="stat-bar">
                    <div class="stat-fill" style="width: ${(overallLevel / 9) * 100}%"></div>
                </div>
            `;
            container.appendChild(overallDiv);
            
            // Add divider
            const divider = document.createElement('div');
            divider.style.margin = '8px 0';
            divider.style.borderBottom = '1px solid rgba(0, 212, 255, 0.5)';
            container.appendChild(divider);
            
            // Show each skill
            gameState.unlockedSkills.forEach(skill => {
                const level = gameState.skills[skill] || 1;
                const percent = (level / 9) * 100;
                const div = document.createElement('div');
                div.className = 'stat-group';
                const label = skillShort[skill] || skill.split(' ').slice(-1)[0] || skill;
                div.innerHTML = `
                    <div class="stat-name" title="${skill}">
                        <span>${label}</span>
                        <span class="stat-level">${level}</span>
                    </div>
                    <div class="stat-bar">
                        <div class="stat-fill" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateInventoryDisplay() {
            const container = document.getElementById('inventory-display');
            const compact = document.getElementById('inventory-compact-display');
            if(container) container.innerHTML = '';
            if(compact) compact.innerHTML = '';
            gameState.inventory.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'inventory-item';
                btn.title = item;
                btn.onclick = () => { showEquipMenu(item); };
                const icon = document.createElement('span');
                icon.className = 'item-icon';
                icon.style.fontSize = '1.1em';
                icon.style.marginRight = '8px';
                icon.textContent = getItemIcon(item);
                const name = document.createElement('span');
                name.className = 'item-name';
                name.style.fontSize = '0.8em';
                name.style.display = 'inline-block';
                name.style.maxWidth = '220px';
                name.style.whiteSpace = 'nowrap';
                name.style.overflow = 'hidden';
                name.style.textOverflow = 'ellipsis';
                name.textContent = item;
                btn.appendChild(icon);
                btn.appendChild(name);
                if(container) container.appendChild(btn);

                // compact badge
                if(compact){
                    const c = document.createElement('button');
                    c.className = 'inventory-item';
                    c.style.padding = '6px';
                    c.style.minWidth = '56px';
                    c.title = item;
                    c.onclick = () => { showEquipMenu(item); };
                    const ci = document.createElement('div'); ci.style.fontSize='0.9em'; ci.textContent = getItemIcon(item);
                    const cn = document.createElement('div'); cn.style.fontSize='0.6em'; cn.style.color='#ffd'; cn.style.maxWidth='80px'; cn.style.whiteSpace='nowrap'; cn.style.overflow='hidden'; cn.style.textOverflow='ellipsis'; cn.textContent = item;
                    c.appendChild(ci); c.appendChild(cn);
                    compact.appendChild(c);
                }
            });
            updateAvatarDisplay();
            savePersistentState();
        }

        function updateAvatarDisplay(){
            const a = document.getElementById('avatar-display');
            if(!a) return;
            // compose small emoji representation from hat/outfit/accessory
            const hat = gameState.avatar.hat || 'None';
            const outfit = gameState.avatar.outfit || 'Tattered Rags';
            const accessory = gameState.avatar.accessory || 'None';
            const hatEmoji = hat === 'None' ? 'üß¢' : (hat.toLowerCase().includes('crown') ? 'üëë' : 'üé©');
            const outfitEmoji = outfit.toLowerCase().includes('rag') ? 'üß•' : 'üëó';
            const accEmoji = accessory === 'None' ? '' : '‚ú®';
            a.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;gap:6px"><div style="font-size:2.2em">${hatEmoji} ${outfitEmoji} ${accEmoji}</div></div>`;

            // update textual equip slots
            const hatSlot = document.getElementById('hat-slot');
            const outfitSlot = document.getElementById('outfit-slot');
            const accessorySlot = document.getElementById('accessory-slot');
            if(hatSlot) { hatSlot.textContent = 'Hat: ' + hat; hatSlot.onclick = ()=> unequipItem('hat'); hatSlot.title = 'Click to unequip'; }
            if(outfitSlot) { outfitSlot.textContent = 'Outfit: ' + outfit; outfitSlot.onclick = ()=> unequipItem('outfit'); outfitSlot.title = 'Click to unequip'; }
            if(accessorySlot) { accessorySlot.textContent = 'Accessory: ' + accessory; accessorySlot.onclick = ()=> unequipItem('accessory'); accessorySlot.title = 'Click to unequip'; }
        }

        function showEquipMenu(item){
            const existing = document.getElementById('equip-overlay');
            if(existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'equip-overlay';
            overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0';
            overlay.style.background='rgba(0,0,0,0.7)'; overlay.style.zIndex=13000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';

            const box = document.createElement('div');
            box.style.background='#071330'; box.style.border='2px solid #00d4ff'; box.style.padding='18px'; box.style.borderRadius='10px'; box.style.color='#fff'; box.style.minWidth='320px';
            const title = document.createElement('div'); title.style.marginBottom='8px'; title.innerHTML = `<strong>${item}</strong>`;
            const info = document.createElement('div'); info.style.marginBottom='12px'; info.textContent = 'Equip to:';

            const btnHat = document.createElement('button'); btnHat.className='choice-button'; btnHat.textContent='Equip as Hat'; btnHat.onclick = ()=>{ equipItem('hat', item); document.body.removeChild(overlay); };
            const btnOut = document.createElement('button'); btnOut.className='choice-button'; btnOut.textContent='Equip as Outfit'; btnOut.onclick = ()=>{ equipItem('outfit', item); document.body.removeChild(overlay); };
            const btnAcc = document.createElement('button'); btnAcc.className='choice-button'; btnAcc.textContent='Equip as Accessory'; btnAcc.onclick = ()=>{ equipItem('accessory', item); document.body.removeChild(overlay); };
            const btnCancel = document.createElement('button'); btnCancel.className='reset-button'; btnCancel.textContent='Cancel'; btnCancel.onclick = ()=>{ document.body.removeChild(overlay); };

            box.appendChild(title); box.appendChild(info); box.appendChild(btnHat); box.appendChild(btnOut); box.appendChild(btnAcc); box.appendChild(btnCancel);
            overlay.appendChild(box); document.body.appendChild(overlay);
        }

        function getItemIcon(item){
            // Mapping for basic items
            const basicMap = {
                'Candle':'üïØÔ∏è', 'Rope':'ü™¢', 'Glue':'üß¥', 'Stick':'ü™µ', 'Green Bottle':'üü¢',
                'Bug':'üêõ', 'Unidentified Pile':'üì¶', 'Suspicious Custard':'üçÆ', 'Wise Yeast':'ü¶†', 
                'Half a Bubble':'ü´ß', 'Worn Quill Pen':'‚úíÔ∏è', 'Glowing Scroll':'üìú', 'Therapeutic Scrolls':'üìú', 
                'Carved Statue Key':'üóùÔ∏è', 'Torn Drill Notes':'üìù','Smoky Flask':'‚öóÔ∏è','Herbal Bundle':'üåø',
                'Phantom Teacup':'‚òï', 'Singing Horseshoe':'üê¥', 'Moonbeam Lens':'üî≠', 'Baffin\'s Button':'üîò',
                'Pocket Telescope':'üî≠', 'Lantern of Mild Regret':'üèÆ', 'Leather-bound Almanac':'üìñ',
                'Compass of Questionable Accuracy':'üß≠'
            };
            if(basicMap[item]) return basicMap[item];
            // fallback for items without specific icons
            return '‚óªÔ∏è';
        }

        function awardQuestItem(preferredName){
            if(!gameState.itemMatrix) gameState.itemMatrix = {};
            // try preferred name first
            if(preferredName && !gameState.itemMatrix[preferredName]){
                addInventoryItem(preferredName, 'quest');
                return preferredName;
            }
            // pick a random unused weirdItems entry
            const available = weirdItems.filter(i => !gameState.itemMatrix[i]);
            if(available.length === 0){
                // fallback: create a unique ephemeral token
                const gen = 'Ephemeral Token ' + Date.now();
                addInventoryItem(gen, 'generated');
                return gen;
            }
            const pick = available[Math.floor(Math.random() * available.length)];
            addInventoryItem(pick, 'quest');
            return pick;
        }

        function equipItem(slot, item){
            // remove first occurrence of item from inventory
            const idx = gameState.inventory.indexOf(item);
            if(idx !== -1) gameState.inventory.splice(idx,1);
            // return previous equipped item to inventory
            const prev = gameState.avatar[slot];
            if(prev && prev !== 'None') gameState.inventory.push(prev);
            gameState.avatar[slot] = item;
            showTopNotification('Equipped ' + item + ' ‚Üí ' + slot);
            savePersistentState(); updateInventoryDisplay(); updateAvatarDisplay(); updateDiscoveryMeter();
        }

        function unequipItem(slot){
            const prev = gameState.avatar[slot];
            if(!prev || prev === 'None') { showTopNotification('Nothing to unequip.'); return; }
            gameState.inventory.push(prev);
            gameState.avatar[slot] = 'None';
            showTopNotification('Unequipped ' + prev + ' from ' + slot);
            savePersistentState(); updateInventoryDisplay(); updateAvatarDisplay(); updateDiscoveryMeter();
        }

        function restartRun(){
            // Reset the ephemeral run state but preserve persistent matrices (skills, itemMatrix)
            gameState.scene = 0;
            gameState.silliness = 1;
            // Reset equipped items and active runtime progression (skills + overall level)
            gameState.avatar.hat = 'None';
            gameState.avatar.outfit = 'Tattered Rags';
            gameState.avatar.accessory = 'None';
            // clear role to allow re-selection
            gameState.avatar.role = null;
            // Reset active skill levels to defaults (do NOT wipe persistent skillMatrix)
            coreSkills.forEach(k => { gameState.skills[k] = 1; });
            gameState.overallLevel = 1;
            // Reset current inventory to starter item (do not auto-populate from persistent itemMatrix)
            gameState.inventory = ['Worn Quill Pen'];
            savePersistentState();
            updateInventoryDisplay();
            updateAvatarDisplay();
            updateStatsDisplay();
            displayScene(0);
            // prompt for role selection again
            showRoleSelector();
            showTopNotification('Run restarted. Persistent progress preserved.');
        }

        const scenes = [
            {
                text: `You stand at the edge of Wizard World. The mission ‚Äî as any decent, mildly baffled guidebook would put it ‚Äî is beautifully simple and spectacularly unwise: walk in a perfectly straight line from here to the Other Side.

If you are a Young Padawan, this is your solemn vow. If you are a Jedi Wizard, this is your solemn duty to intervene (gently, of course), because in a land where circles are suspicious and compass needles hum, straight lines are a health hazard. A margin note in the guidebook reads: 'Do not attempt without supervision. Bring a towel.'`,
                choices: [
                    { text: "‚û°Ô∏è Attempt to walk in a straight line (Padawan ambition)", next: 1, onChoose: () => { if(gameState.avatar.role==='Young Padawan'){ upgradeSkill('Numerical Harmony'); awardQuestItem('Pocket Sundial'); } else { showTopNotification('Only a Padawan charges at straight lines with such optimism.'); } } },
                    { text: "üõë Intervene benevolently to prevent the straight line (Wizard's duty)", next: 8, onChoose: () => { if(gameState.avatar.role==='Jedi Wizard'){ upgradeSkill('Arcane Mechanics'); awardQuestItem('Lantern of Mild Regret'); } else { showTopNotification('You hesitate. Perhaps you are both?'); } } },
                    { text: "üìñ Read the snarky margin notes in the guidebook", next: 15, onChoose: () => { awardQuestItem('Notebook of Half-Thoughts'); upgradeSkill('Linguistic Arts'); } }
                ]
            },
            {
                text: "The Council hands you a scroll. It's 40 feet long and mostly contains typos. Apparently, a mysterious substance called 'Glorp' has appeared in the Rain Wilds. It's described as: 'wet, yet somehow also dry. Hot, but also cold. It tastes like colors taste. Please investigate.'\n\nYou have three options:",
                choices: [
                    { text: "ü§î Consult the Oracle - she speaks in riddles and also screams a lot", next: 2 },
                    { text: "üöÇ Take a train up the river - wait, do trains exist here? Probably not.", next: 3 },
                    { text: "üíé Sell all your possessions for wizardwood - because that's totally sensible", next: 9 }
                ]
            },
            {
                text: "You find the Oracle sitting in a cave, knitting what appears to be a sock for a giant squid. She looks at you with ancient, knowing eyes.\n\n'The Glorp,' she says mysteriously, 'is neither here nor there. It exists in the space between thoughts. Also, I think you left your keys at home.'\n\nWait, she's right. You did leave your keys at home. How did she‚Äîactually, you don't have a home anymore. You sold it.",
                choices: [
                    { text: "üé≠ Ask if the Glorp is sentient and can be reasoned with", next: 4, onChoose: () => { unlockSkill("Automatons & Logic"); } },
                    { text: "üìñ Ask her to explain in haiku form instead", next: 5, onChoose: () => { unlockSkill("Literary Mastery"); } },
                    { text: "üß† Realize this is getting too confusing and take a nap", next: 16 }
                ]
            },
            {
                text: "You attempt to take a boat up the river, but the acid river immediately disintegrates your shoes. Your SHOES! The river then politely asks you to leave. Yes, the river can talk. It sounds like a middle manager named Derek.\n\n'Look,' Derek the Acid River says, 'I got enough problems. Yesterday someone tried to throw a salad in me. A SALAD.'",
                choices: [
                    { text: "ü§ù Befriend Derek and ask about the Glorp situation", next: 6 },
                    { text: "‚öîÔ∏è Challenge Derek to combat - rivers can't fight. Right?", next: 10, requiredSkill: { name: 'Arcane Mechanics', level: 3 } },
                    { text: "üéµ Compose a song about Derek's pain", next: 11 }
                ]
            },
            {
                text: "The Oracle's eyes glow with ancient power. 'Very well. The Glorp is the spirit of commerce that ate a wizard and now regrets it. It must be fed seventeen types of cheese and one really good joke.'\n\nYou ask: 'What's a good joke?'\n\nShe responds: 'I don't know. I'm 800 years old. I only remember sad things.'",
                choices: [
                    { text: "üßÄ Gather 17 cheese wheels - this seems doable!", next: 7 },
                    { text: "üòÇ Spend three weeks writing the perfect joke", next: 12 },
                    { text: "üöÄ Give up and try to fly to the moon instead", next: 17 }
                ]
            },
            {
                text: "You attempt to write a haiku about the Glorp. It comes out as:\n\n'Wet and also dry,\nColors taste like it tastes taste,\nI should go to bed.'\n\nThe Oracle nods approvingly and then spontaneously turns into a flock of pigeons. The pigeons steal your hat. You have no recourse.",
                choices: [
                    { text: "üê¶ Follow the pigeons - they probably know something", next: 13 },
                    { text: "üß¢ Accept your fate as a hatless wanderer", next: 18 },
                    { text: "üí∞ Offer the pigeons money for your hat back", next: 19 }
                ]
            },
            {
                text: "You befriend Derek the Acid River and learn he's actually quite lonely. 'Everyone avoids me because I'm made of acid,' he complains. 'My last friend just... dissolved.'\n\nTogether, you devise a plan: the Glorp is Derek's ex-roommate from college. They had a falling out over the thermostat. Yes, the Glorp had strong opinions about the thermostat.",
                choices: [
                    { text: "üí¨ Mediate between Derek and the Glorp - couples therapy!", next: 14, onChoose: () => { unlockSkill("Mind Theory"); awardQuestItem("Therapeutic Scrolls"); } },
                    { text: "üé™ Throw a party to get them to reconcile", next: 20 },
                    { text: "üèÉ Nope, leave Derek to solve his own problems", next: 21 }
                ]
            },
            {
                text: "You successfully gather 17 wheels of cheese. The final wheel is made of pure gold (it doesn't taste like cheese but looks impressive). You now have enough cheese to feed a small army, or one very confused Glorp.",
                choices: [
                    { text: "üéØ Find the Glorp and offer the cheese peacefully", next: 22 },
                    { text: "üßÄ Eat all the cheese yourself out of stress", next: 23 },
                    { text: "ü§π Use the cheese to create a distracting cheese fort", next: 24 }
                ]
            },
            {
                text: "You flee to the mountains and find a wizard named Theodor who is approximately 2,000 years old and mostly just complains about young people. 'Back in MY day,' he mutters, 'we didn't have Glorp. We had REAL problems. Like dragons. Giant dragons with tax returns.'\n\nYou ask him to help. He refuses, but offers to sell you a self-help book he wrote: 'Finding Your Inner Glorp.'",
                choices: [
                    { text: "üìö Buy the book and read it cover to cover", next: 25 },
                    { text: "üí∏ Negotiate a discount", next: 26 },
                    { text: "ü™® Throw a rock at him and run", next: 27 }
                ]
            },
            {
                text: "You sell everything for wizardwood. EVERYTHING. Your ship, your dignity, your favorite mug. You now have a pile of wizardwood the size of a small house. It's beautiful but completely useless.\n\nA traveling merchant looks at it and says, 'Yeah, that's about $3 worth of actual value. The REST is just vibes.'",
                choices: [
                    { text: "üò§ Carve the wizardwood into a statue of yourself", next: 28 },
                    { text: "üèóÔ∏è Build a wooden fortress of regret", next: 29 },
                    { text: "üî• Set it all on fire - maybe wizardwood smells nice when burned?", next: 30 }
                ]
            },
            {
                text: "You challenge Derek the Acid River to combat. Derek, ever the middle manager, simply blinks at you.\n\n'Sir,' he says calmly, 'I am a river. I am literally everywhere. You cannot defeat me. Also, I'm calling HR about this assault.'\n\nHR is apparently a talking catfish named Sebastian.",
                choices: [
                    { text: "üê± Negotiate with HR catfish Sebastian", next: 31 },
                    { text: "‚öîÔ∏è Fight both Derek AND Sebastian", next: 32 },
                    { text: "üìã File a countersuit for emotional damages", next: 33 }
                ]
            },
            {
                text: "You spend three weeks composing the perfect joke. The joke is:\n\n'Why did the Glorp go to therapy? Because it had commitment issues with the thermostat!'\n\nIt's not very funny. But you tell it with such confidence that a nearby bird dies. The Oracle gives you a thumbs up from wherever she went as a pigeon.",
                choices: [
                    { text: "üé§ Perform this joke to the Glorp directly", next: 34, requiredSkill: { name: 'Linguistic Arts', level: 2 } },
                    { text: "üåü Enter it in a comedy competition", next: 35 },
                    { text: "üìù Accept that comedy isn't your strength", next: 36 }
                ]
            },
            {
                text: "You compose a haiku about Derek, and it's actually quite touching:\n\n'Middle manager,\nAcid coursing through your veins,\nYou deserve great care.'\n\nDerek the River cries. Acid tears mix with more acid, which is confusing chemically. He's deeply moved though.",
                choices: [
                    { text: "üíù Offer to be Derek's best friend", next: 37 },
                    { text: "üöÄ Use this emotional moment to escape upriver", next: 38 },
                    { text: "üìñ Publish a poetry collection about Derek", next: 39 }
                ]
            },
            {
                text: "You follow the pigeons through the countryside. They lead you to a massive monument made of... hats. Hundreds of hats. Thousands. It's a hat pyramid. The pigeons screech triumphantly. They've been stealing hats for 60 years.\n\nAt the top is YOUR hat. Also, it's wearing a tiny crown.",
                choices: [
                    { text: "üëë Climb the hat pyramid and retrieve your hat", next: 40, requiredSkill: { name: 'Numerical Harmony', level: 2 } },
                    { text: "ü§Ø Realize you've been inducted into the Pigeon Hat Cult", next: 41 },
                    { text: "üì∑ Take a selfie with the hat pyramid", next: 42 }
                ]
            },
            {
                text: "You arrange a mediation session between Derek and the Glorp. It's incredibly awkward.\n\nGlorp: 'You ALWAYS had the thermostat at 68 degrees!'\nDerek: 'It was a COMFORTABLE temperature!'\nYou: 'What if... what if we just... accept that temperature is relative?'\n\nThey both stare at you like you've solved world peace.",
                choices: [
                    { text: "üíç Suggest they remarry each other", next: 43 },
                    { text: "üéâ Declare yourself the Hero of Reconciliation", next: 44 },
                    { text: "üèÉ Leave before they argue again", next: 45 }
                ]
            },
            {
                text: "You eat all 17 cheese wheels in one sitting. Your stomach protests. Actually, your stomach stages a full mutiny. You spend the next three days in places best left unmentioned.\n\nBut here's the twist: the cheese wheels are magical. You burp out small clouds of colored smoke that smell like ancient prophecies. You are now a prophet, but only through involuntary burping.",
                choices: [
                    { text: "üîÆ Start a prophecy business based on your burps", next: 46 },
                    { text: "üò∑ See a doctor about this condition", next: 47 },
                    { text: "üåç Travel the world spreading burp-based wisdom", next: 48 }
                ]
            },
            {
                text: "You decide to give up and attempt to fly to the moon. You fashion a cape out of sail cloth and climb to the highest mountain.\n\nYou jump.\n\nWhat happens next depends entirely on how many people are watching. (Three people are watching, so gravity gets embarrassed and makes you fall slower than normal. You land in a lake of yogurt.)",
                choices: [
                    { text: "ü•õ Accept the yogurt lake as your new home", next: 49 },
                    { text: "üåô Try jumping again, this time toward the actual moon", next: 50 },
                    { text: "üéØ Admit defeat and return to Bingtown", next: 51 }
                ]
            },
            {
                text: "You accept your fate as a hatless wanderer. Without a hat, you feel exposed. Vulnerable. But also... free.\n\nYou begin a new life as a traveling bard, telling the story of how you lost your hat to mystical pigeons. People find this oddly compelling. You become somewhat famous. You're known as 'That Bald Guy With Stories.'\n\nYou are content, mostly.",
                choices: [
                    { text: "üìö ENDING: Write a memoir about your hatless adventures", next: -1 },
                    { text: "üé≠ ENDING: Become a professional storyteller", next: -2 },
                    { text: "üè† ENDING: Settle down and live quietly", next: -3 }
                ]
            },
            {
                text: "You offer the pigeons money. They take it. Then they steal your shoes too. The lesson here is unclear.\n\nBut wait! Your hat falls out of the sky and lands perfectly on your head. You don't know why. Physics is not reliable here.",
                choices: [
                    { text: "ü§î Accept that you'll never understand this world", next: 52 },
                    { text: "üé™ Join the pigeons permanently", next: 53 },
                    { text: "üíº Report this to someone official", next: 54 }
                ]
            },
            {
                text: "You throw a party in Derek's honor. The party is bizarre because Derek is a RIVER. Other traders attend. Someone brings a live octopus. Someone else brings a contraption that plays the same song on repeat.\n\nDerek and the Glorp show up. They're still feuding. The party becomes increasingly chaotic. Someone's shoes dissolve. The song gets faster. It's simultaneously the best and worst party ever.",
                choices: [
                    { text: "üéä ENDING: Legendary party goes down in history", next: -4 },
                    { text: "üí• ENDING: Party destroys Bingtown", next: -5 },
                    { text: "üèÉ ENDING: Escape the party chaos", next: -6 }
                ]
            },
            {
                text: "You nope right out of Derek's drama and return to your ship. The SS Bewilderment is exactly where you left it‚Äîstill not awake. You've accepted that it will never quicken. Maybe that's fine. Maybe a silent ship is a gift.\n\nYou sail away from all of this mess. The Glorp, Derek, the thermostat drama‚Äînone of it matters anymore.",
                choices: [
                    { text: "‚õµ ENDING: Sail into the sunset forever", next: -7 },
                    { text: "üåä ENDING: Find a new crew and a new purpose", next: -8 },
                    { text: "üò¥ ENDING: Live peacefully until your ship finally talks", next: -9 }
                ]
            },
            {
                text: "You find the Glorp. It's... a sentient blob of confusion shaped like a question mark. You offer it cheese.\n\nThe Glorp eats all of it and immediately starts sobbing. 'I don't know what I am,' it wails. 'I don't know if I even exist.'\n\nYou tell it: 'Neither do I, buddy. Neither do I.'\n\nThis is the most honest moment of your life.",
                choices: [
                    { text: "ü§ù ENDING: Become lifelong friends with the Glorp", next: -10 },
                    { text: "üè• ENDING: Open a therapy center for confused creatures", next: -11 },
                    { text: "üé® ENDING: Write an art piece about existential confusion", next: -12 }
                ]
            },
            {
                text: "You eat all the cheese while questioning your life choices. By the time you're finished, you're covered in cheese dust and you smell like a dairy farm. People keep approaching you thinking they can trade their goods.\n\nThey cannot. You have no goods. You have only cheese and regret.",
                choices: [
                    { text: "üßÄ ENDING: Open a failing cheese shop", next: -13 },
                    { text: "üö™ ENDING: Hide in a cave forever", next: -14 },
                    { text: "üå≤ ENDING: Become a cheese hermit in the woods", next: -15 }
                ]
            },
            {
                text: "You build a cheese fort. It's actually magnificent. The architect in you emerges. You create towers, ramparts, a moat of melted cheese (which may have been a mistake). But it stands! It's a work of art!\n\nUnfortunately, a week later, it starts to smell. And then it attracts VERY determined mice. You are besieged by rodents.",
                choices: [
                    { text: "üßÄ ENDING: Become the Cheese Fort's eternal guardian", next: -16 },
                    { text: "üê≠ ENDING: Join the mice and abandon human society", next: -17 },
                    { text: "üî• ENDING: Burn down the fort and start over", next: -18 }
                ]
            },
            {
                text: "You buy Theodor's self-help book. It's 400 pages of complaints. Not a single helpful piece of advice. The final page just says 'Good luck, kid. You'll need it.'\n\nBut somehow, this is exactly what you needed to hear.",
                choices: [
                    { text: "üìö ENDING: The book changes your life somehow", next: -19 },
                    { text: "ü§∑ ENDING: Accept that life is just Theodor complaining", next: -20 },
                    { text: "‚ú® ENDING: Start giving the book to other confused people", next: -21 }
                ]
            },
            {
                text: "You try to negotiate with Theodor. He's stubborn. He wants more money. You have no money. He suggests you solve the Glorp situation and come back with payment.\n\n'Also,' he adds, 'if you die out there, you won't need to pay me. So really, this is a win-win.'",
                choices: [
                    { text: "üéØ ENDING: Resolve to solve this and return rich", next: -22 },
                    { text: "üò§ ENDING: Curse Theodor and leave", next: -23 },
                    { text: "üíÄ ENDING: Die immediately to prove him right", next: -24 }
                ]
            },
            {
                text: "You throw a rock at a 2,000-year-old wizard. He is deeply unimpressed. The rock bounces off him harmlessly. He doesn't even acknowledge it.\n\nYou run. You run very fast. Behind you, you hear him muttering: 'Kids these days. Always throwing rocks. Back in MY day, we used BOULDERS.'",
                choices: [
                    { text: "‚õ∞Ô∏è ENDING: Never stop running", next: -25 },
                    { text: "üè† ENDING: Find a safe village far away", next: -26 },
                    { text: "ü§ê ENDING: Learn to keep your mouth shut around wizards", next: -27 }
                ]
            },
            {
                text: "You carve an entire statue of yourself from the wizardwood. It's 30 feet tall. It looks exactly like you, but angrier. You name it 'Baffin the Regretful.' It becomes a landmark that tourists visit.\n\n'Is that really you?' they ask.\n\n'In spirit, yes,' you reply, unsure if you're joking.",
                choices: [
                    { text: "üëë Become famous because of your statue", next: -28, onChoose: () => { unlockSkill("Aesthetic Crafting"); awardQuestItem("Carved Statue Key"); } },
                    { text: "üò¢ Resent the statue forever", next: -29 },
                    { text: "üé® Carve more statues - it's your calling now", next: -30, onChoose: () => { unlockSkill("Aesthetic Crafting"); upgradeSkill("Aesthetic Crafting"); } }
                ]
            },
            {
                text: "You build a fortress out of wizardwood. It's beautiful and utterly impractical. It can't keep anyone out because it's made of wood. A stiff breeze nearly destroys the west wall.\n\nYou live in this regrettable fortress, surrounded by your regrettable life choices, watching birds use your towers as perches.",
                choices: [
                    { text: "üè∞ ENDING: Become the Fortress Hermit", next: -31 },
                    { text: "üöÄ ENDING: Launch yourself into the sky from the fortress walls", next: -32 },
                    { text: "üå≤ ENDING: Let nature slowly reclaim the fortress", next: -33 }
                ]
            },
            {
                text: "You set the wizardwood on fire. It smells like pine, regret, and broken dreams. Also, it burns for WEEKS. Your entire region is engulfed in smoke. The whole Bingtown Council is very upset.\n\nBut here's the thing: wizardwood ash is apparently extremely valuable. You've accidentally become rich. Through arson.",
                choices: [
                    { text: "üí∞ ENDING: Become accidentally wealthy and paranoid", next: -34 },
                    { text: "‚öñÔ∏è ENDING: Get arrested but become a legend", next: -35 },
                    { text: "üèÉ ENDING: Take the money and disappear", next: -36 }
                ]
            },
            {
                text: "You sit down with HR catfish Sebastian. He's very professional about the whole situation. He has a clipboard. He's taking notes.\n\n'Sir,' he says, 'I'm going to be honest. Derek is right. You assaulted a river. That's... unprecedented in my 50 years of HR work.'\n\nYou apologize. It's awkward. Everyone is uncomfortable.",
                choices: [
                    { text: "üòî ENDING: Undergo mandatory river sensitivity training", next: -37 },
                    { text: "üìã ENDING: Become HR's new assistant", next: -38 },
                    { text: "üê± ENDING: Bond with Sebastian over the absurdity", next: -39 }
                ]
            },
            {
                text: "You fight Derek AND Sebastian. Derek dissolves you slightly. Sebastian whips you with his whiskers. It's the shortest battle of your life‚Äîabout 4 seconds.\n\nYou wake up in a hospital made of clouds. Apparently death is confusing here.",
                choices: [
                    { text: "‚òÅÔ∏è ENDING: Become a cloud ghost", next: -40 },
                    { text: "üíÄ ENDING: Accept your demise with dignity", next: -41 },
                    { text: "üëº ENDING: Work as a cloud hospital orderly", next: -42 }
                ]
            },
            {
                text: "You file a lawsuit against a river. The judge is a very tired tortoise who has heard worse. Derek hires a shark lawyer (literally a shark). Your lawyer is a hermit crab named Gerald. Gerald is not equipped for this.\n\nYou lose spectacularly. You now owe Derek emotional damages.",
                choices: [
                    { text: "üí≥ ENDING: Spend your life paying Derek", next: -43 },
                    { text: "üìú ENDING: Set a legal precedent for river rights", next: -44 },
                    { text: "üò≠ ENDING: Cry in a tavern about the injustice", next: -45 }
                ]
            },
            {
                text: "You tell your joke to the Glorp. The Glorp laughs. It's not a good laugh. It's the laugh of something that doesn't understand the concept of humor but is trying very hard.\n\n'Yes,' the Glorp says, 'joke. Very. Joke. Ha. I am laughing internally, yes.'",
                choices: [
                    { text: "üòÑ ENDING: Become a comedian to sentient blobs", next: -46 },
                    { text: "ü§ê ENDING: Never tell a joke again", next: -47 },
                    { text: "üé≠ ENDING: Open a theater for non-human audiences", next: -48 }
                ]
            },
            {
                text: "You enter your joke in a regional comedy competition. You don't win. But someone from the audience comes up to you afterward and says, 'That was so bad it was almost profound.'\n\nYou're not sure if this is a compliment. You decide it is.",
                choices: [
                    { text: "üèÖ ENDING: Become a beloved bad comedian", next: -49 },
                    { text: "üé™ ENDING: Start a comedy troupe of terrible jokes", next: -50 },
                    { text: "üåü ENDING: Leave comedy and start a yodeling career", next: -51 }
                ]
            },
            {
                text: "You accept that comedy isn't your strength. You return to sailing. You become a ship captain who tells jokes to fish. The fish don't laugh, but they don't leave either. You consider this a moral victory.",
                choices: [
                    { text: "üêü ENDING: Become friends with the local fish", next: -52 },
                    { text: "‚õµ ENDING: Sail away and forget about comedy forever", next: -53 },
                    { text: "üéµ ENDING: Switch to music instead", next: -54 }
                ]
            },
            {
                text: "You dedicate your life to being Derek's best friend. You visit him every day. You bring him gifts (very carefully, so they don't dissolve). Derek slowly opens up. You learn that he was actually a businessman once, before becoming a river.\n\n'Good times,' he muses. 'Bad benefits, though.'",
                choices: [
                    { text: "üë´ ENDING: Grow old together as river-and-friend duo", next: -55 },
                    { text: "üíº ENDING: Help Derek start a river consulting business", next: -56 },
                    { text: "üìñ ENDING: Write a book about your friendship", next: -57 }
                ]
            },
            {
                text: "You use your emotional moment with Derek to escape upriver. The river, touched by your poem, allows you safe passage. You float upriver and finally reach the source of the Glorp.\n\nIt's just... a confused swamp thing sitting in a cave, wondering why it exists. You've found the answer to the entire quest, but you're not sure what to DO with it.",
                choices: [
                    { text: "üí≠ ENDING: Become a philosopher about existence", next: -58 },
                    { text: "üéØ ENDING: Tell everyone the Glorp is just confused", next: -59 },
                    { text: "ü§´ ENDING: Keep the secret forever", next: -60 }
                ]
            },
            {
                text: "You publish a poetry collection called 'Odes to Derek: A River's Lament.' It becomes surprisingly popular. Book clubs form. Literary critics analyze your metaphors. You become a respected poet.\n\nDerek thinks it's funny. He reads passages aloud to other rivers. They don't get it, but they appreciate the effort.",
                choices: [
                    { text: "üìö ENDING: Win a major literary award", next: -61 },
                    { text: "üé§ ENDING: Go on a poetry tour", next: -62 },
                    { text: "üòä ENDING: Just enjoy the simple pleasure of being read", next: -63 }
                ]
            },
            {
                text: "You climb the hat pyramid. It's incredibly dangerous. Hats keep falling on your head, which is actually helpful for the climb. At the top, you grab your hat with the tiny crown.\n\nThe pigeons screech in celebration. You are now officially part of the Pigeon Hat Collective, a secret society dedicated to hat theft and hat art.",
                choices: [
                    { text: "üëë ENDING: Rise through the ranks of the Pigeon Collective", next: -64 },
                    { text: "üé® ENDING: Become a hat sculptor", next: -65 },
                    { text: "üê¶ ENDING: Transform into a pigeon yourself", next: -66 }
                ]
            },
            {
                text: "You've been inducted into the Pigeon Hat Cult. They welcome you with a ceremony involving 200 pigeons flying in formation while making sounds that might be either singing or screaming‚Äîit's unclear.\n\nYou are given a robe made entirely of stolen hats. It's heavy and doesn't breathe well, but it's an honor.",
                choices: [
                    { text: "üê¶ ENDING: Dedicate your life to the Cult", next: -67 },
                    { text: "üé© ENDING: Become their hat procurement specialist", next: -68 },
                    { text: "ü§™ ENDING: Descend into absolute pigeon madness", next: -69 }
                ]
            },
            {
                text: "You take a selfie with the hat pyramid. Your phone (somehow you have a phone) somehow uploads it to a fantasy social media site called 'ScrollTok.' It goes viral.\n\nYou become famous as 'Hat Pyramid Person.' Your life is never the same. People recognize you everywhere. It's both a blessing and a curse.",
                choices: [
                    { text: "üì± ENDING: Become a viral influencer", next: -70 },
                    { text: "üèñÔ∏è ENDING: Use your fame to escape to a quiet island", next: -71 },
                    { text: "üò§ ENDING: Resent social media forever", next: -72 }
                ]
            },
            {
                text: "You suggest Derek and Glorp remarry each other. They look at you like you've suggested they solve world hunger through interpretive dance.\n\n'We're not even the same TYPE of being!' Glorp protests.\n\n'We can work through it,' you insist, bringing up the couples therapy pamphlet you somehow have.",
                choices: [
                    { text: "üíç ENDING: They remarry, somehow it works", next: -73 },
                    { text: "üò§ ENDING: They refuse and you become the villain", next: -74 },
                    { text: "üéâ ENDING: They agree to try dating", next: -75 }
                ]
            },
            {
                text: "You declare yourself the Hero of Reconciliation and have a statue built in your honor. But then the statue accidentally falls on Derek and causes significant emotional damage. You are no longer a hero. You are, in fact, the villain.",
                choices: [
                    { text: "üíî ENDING: Live with eternal guilt", next: -76 },
                    { text: "üèÉ ENDING: Flee the country immediately", next: -77 },
                    { text: "‚öñÔ∏è ENDING: Face justice in river court", next: -78 }
                ]
            },
            {
                text: "You leave Derek and Glorp to figure things out themselves. As you sail away, you can hear them arguing about the thermostat in the distance. Some problems aren't yours to solve.\n\nYou find peace in this acceptance.",
                choices: [
                    { text: "‚òÆÔ∏è ENDING: Find inner peace through non-interference", next: -79 },
                    { text: "‚õµ ENDING: Sail toward new adventures", next: -80 },
                    { text: "üßò ENDING: Become a zen river-monk hybrid", next: -81 }
                ]
            },
            {
                text: "Your burp prophecies become legendary. People travel from across the realm to hear your predictions. You establish the Church of the Sacred Burp. Your followers are mostly confused but committed.\n\nA prophet is born. From your stomach.",
                choices: [
                    { text: "üîÆ ENDING: Become a religious figure of dubious legitimacy", next: -82 },
                    { text: "üí∏ ENDING: Become wealthy from prophecy sales", next: -83 },
                    { text: "üò∑ ENDING: Suffer from eternal indigestion", next: -84 }
                ]
            },
            {
                text: "A doctor examines you thoroughly. His conclusion: 'I have no idea what's happening. This is the most confusing condition I've ever seen. Also, don't eat that much cheese ever again.'\n\nYou are healthy, in that sense, but forever changed.",
                choices: [
                    { text: "üòê ENDING: Accept your strange new biology", next: -85 },
                    { text: "üî¨ ENDING: Become a medical mystery", next: -86 },
                    { text: "üåç ENDING: Travel to share your condition with scientists", next: -87 }
                ]
            },
            {
                text: "You become a traveling burp prophet. You visit villages and deliver cryptic prophecies through involuntary gastrointestinal events. It's undignified but surprisingly effective.\n\nPeople make decisions based on your burps. A kingdom is saved because you burped at the right moment. History is shaped by your stomach.",
                choices: [
                    { text: "üåü ENDING: Accidentally change the course of history", next: -88 },
                    { text: "üòÖ ENDING: Live with the absurdity of your power", next: -89 },
                    { text: "üé™ ENDING: Become a traveling carnival attraction", next: -90 }
                ]
            },
            {
                text: "You land in a lake of yogurt. It's still warm. Still fresh. You wade to shore and realize this is actually amazing. You establish yourself as the Yogurt Lake's first resident. You name it Lake Baffin. People think you're insane.\n\nYou don't care. Your lake is delicious.",
                choices: [
                    { text: "ü•õ ENDING: Live luxuriously in your yogurt paradise", next: -91 },
                    { text: "üç® ENDING: Open a yogurt restaurant by the lake", next: -92 },
                    { text: "üåä ENDING: Establish a yogurt-based economy", next: -93 }
                ]
            },
            {
                text: "You try jumping toward the actual moon again. You've learned from your mistakes. This time you angle yourself more carefully.\n\nYou get about three feet higher before gravity remembers you exist. You land in a different lake. This one tastes like regret. It tastes like regret and raspberries.",
                choices: [
                    { text: "üåô ENDING: Keep trying to reach the moon", next: -94 },
                    { text: "ü´ê ENDING: Start a raspberry preserve business", next: -95 },
                    { text: "üò¢ ENDING: Accept that you're not meant for the stars", next: -96 }
                ]
            },
            {
                text: "You return to Bingtown, defeated and humiliated. The Council asks what happened. You tell them: 'I found the Glorp, I learned about Derek, and I realized nothing matters as much as good intentions.'\n\nThey're not satisfied with this answer. But you've made peace with it.",
                choices: [
                    { text: "üè† ENDING: Retire peacefully from public service", next: -97 },
                    { text: "üìö ENDING: Write a memoir nobody reads", next: -98 },
                    { text: "üò¥ ENDING: Accept obscurity with grace", next: -99 }
                ]
            },
            {
                text: "You accept that you'll never understand this world. You stop trying to make sense of rivers, Glorps, and sentient blobs. Life becomes much simpler.\n\nYou eventually die. Nobody remembers you. But for a brief moment, you were happy.",
                choices: [
                    { text: "‚≠ê ENDING: Find peace in insignificance", next: -100 }
                ]
            },
            {
                text: "You join the pigeons. You don't become a pigeon, but you live with them. You help them steal hats. Your human perspective actually helps them organize better. Together, you create the most efficient hat-stealing operation the realm has ever seen.",
                choices: [
                    { text: "üê¶ ENDING: Become a legendary pigeon accomplice", next: -101 }
                ]
            },
            {
                text: "You report this to the Bingtown Council. They listen carefully. Then they ask, 'Have you considered therapy?'\n\nYou have not. You begin therapy. It's more helpful than expected.",
                choices: [
                    { text: "üõãÔ∏è ENDING: Actually get your life together through therapy", next: -102 }
                ]
            }
        ];

        const endings = {
            "-1": "üìñ You write a memoir called 'The Hatless Years: A Journey of Loss and Self-Discovery.' It sells exactly 3 copies. But they're meaningful copies.",
            "-2": "üé§ Your storytelling becomes so legendary that people mistake your stories for actual history. You've accidentally become a mythmaker.",
            "-3": "üè† You settle in a quiet village and live out your days in peace. Nobody remembers you. You're okay with this.",
            "-4": "üéä The party becomes legendary. Historians will later argue about whether it actually happened or if everyone hallucinated it together.",
            "-5": "üí• Your party destroys approximately 40% of Bingtown. You are wanted for war crimes involving excessive celebration.",
            "-6": "üèÉ You escape the party and start a new life in a cave. You become the Hermit of the Abandoned Party.",
            "-7": "‚õµ You sail until you fall off the edge of the world. Turns out the world is flat here. You're disappointed.",
            "-8": "üåä You gather a crew of misfits and become a legendary captain. Your ship, the SS Bewilderment, never does wake up. That's okay.",
            "-9": "üò¥ You live peacefully for another 40 years. Your ship finally talks when you're on your deathbed. Its first words: 'You could have been more interesting.'",
            "-10": "ü§ù You and the Glorp become best friends. Together, you open a restaurant specializing in confused cuisine. It's surprisingly popular.",
            "-11": "üè• You open 'The Confused Creatures Therapy Center.' Business is good. Derek becomes your assistant therapist.",
            "-12": "üé® Your art installation 'Existential Glorp' becomes famous. Critics describe it as 'confusing but profound.' It's just you and the Glorp existing together.",
            "-13": "üßÄ Your cheese shop fails within a year. You have too much cheese and no customers. You become the Cheese Hermit.",
            "-14": "üö™ You disappear into a cave with your remaining cheese. People occasionally find wheels of it left outside. You're like the Cheese Santa.",
            "-15": "üå≤ You live in the woods. The forest becomes 40% cheese. Woodland creatures are confused but well-fed.",
            "-16": "üßÄ You spend the next 30 years protecting your cheese fort from nature. It's a losing battle, but an honorable one.",
            "-17": "üê≠ You become the Rat King. Your crown is made of cheese. You're actually quite content.",
            "-18": "üî• You burn down the fort. From the ashes, a new cheese fort rises. The cycle continues eternally.",
            "-19": "üìö Theodor's book somehow contains the exact advice you needed to hear without explicitly saying anything useful.",
            "-20": "ü§∑ You accept that all of life is just various wizards complaining about young people.",
            "-21": "‚ú® You give the book to everyone you meet. It becomes a cult classic. Theodor is confused but pleased.",
            "-22": "üéØ You do eventually solve the Glorp situation. You return wealthy. Theodor is shocked. Also still complaining.",
            "-23": "üò§ You curse Theodor. He finds this mildly amusing. He's 2000 years old. Your curse is adorable to him.",
            "-24": "üíÄ You die. Theodor was right. He's still not impressed.",
            "-25": "‚õ∞Ô∏è You run until you reach the ocean. You build a boat and sail away forever. The wizard never catches you.",
            "-26": "üè† You find a quiet village where nobody asks questions. You live there for the rest of your life. It's nice.",
            "-27": "ü§ê You learn that silence is golden, especially around wizards with centuries of power.",
            "-28": "üëë Your statue becomes a major tourist attraction. You make money from merchandise. You're famous but nobody knows your actual name.",
            "-29": "üò¢ You spend your life looking at the statue, resenting the angry wooden version of yourself.",
            "-30": "üé® You become obsessed with carving statues. Your entire region becomes a forest of wooden Baffins. It's unsettling.",
            "-31": "üè∞ You become the Wizardwood Fortress Hermit. Travelers visit hoping you're wise. You're mostly just confused.",
            "-32": "üöÄ You launch yourself off the fortress walls. You float. Nobody knows why. You're free.",
            "-33": "üå≤ Nature reclaims the fortress over time. You live peacefully as it becomes overgrown. It's beautiful in a sad way.",
            "-34": "üí∞ You're wealthy and paranoid. You assume everyone is after your wizardwood ash. You're probably right.",
            "-35": "‚öñÔ∏è You become a legendary criminal who accidentally became a millionaire. Ballads are sung about you.",
            "-36": "üèÉ You disappear with your fortune. Sometimes people claim to see you. You're a legend and a ghost story.",
            "-37": "üòî You attend mandatory river sensitivity training. It's awkward but you become a better person. Derek forgives you.",
            "-38": "üìã You become the new HR assistant and are excellent at it. Gerald the hermit crab trains you. You find it fulfilling.",
            "-39": "üê± You and Sebastian bond over the absolute absurdity of everything. You become best friends. He's actually very funny.",
            "-40": "‚òÅÔ∏è You become a cloud ghost. It's peaceful. Sometimes you rain on people who were rude to you. Petty satisfaction.",
            "-41": "üíÄ You accept death with dignity. The cloud hospital is better than you expected. You work there forever.",
            "-42": "üëº You become an orderly in a cloud hospital. It's not glamorous but it's honest work. You're content.",
            "-43": "üí≥ You spend the next 50 years paying Derek emotional damages. It's actually a good relationship. Friends who pay each other.",
            "-44": "üìú Your case establishes that rivers have legal rights. You become a legal legend for the worst reasons possible.",
            "-45": "üò≠ You live in a tavern and tell drunk people about your legal case. They feel sorry for you. You get free drinks.",
            "-46": "üòÑ You become a comedian who only performs for sentient blobs. Your niche audience is oddly loyal.",
            "-47": "ü§ê You never tell another joke again. You become a silent monk. The irony is delicious.",
            "-48": "üé≠ Your theater becomes famous for strange non-human audiences. Critics say it's 'avant-garde.'",
            "-49": "üèÖ You become beloved despite being a terrible comedian. People love how bad you are. Success through failure.",
            "-50": "üé™ Your comedy troupe of bad jokes becomes world-famous. You've accidentally revolutionized comedy.",
            "-51": "üåü You switch to yodeling. You're moderately better at this. It's an improvement.",
            "-52": "üêü You and the fish develop a surprising friendship. The fish don't laugh, but they visit you regularly.",
            "-53": "‚õµ You sail away and eventually forget you ever told jokes. It's liberating.",
            "-54": "üéµ You become a traveling musician. Your songs are about nothing. They're weirdly popular.",
            "-55": "üë´ You and Derek grow old together. He's still a river. You're still confused. It works.",
            "-56": "üíº 'Derek's River Consulting' becomes a successful business. He consults on water-related matters. You handle the paperwork.",
            "-57": "üìñ 'Derek and Me: A River Love Story' becomes a bestseller. You're moderately embarrassed.",
            "-58": "üí≠ You become a wandering philosopher pondering existence. Your answers are usually 'I don't know either.'",
            "-59": "üéØ You tell everyone the Glorp is just confused. Most accept this. Some start therapy for the Glorp.",
            "-60": "ü§´ You keep the secret forever. It becomes a burden, but also a gift. You know something nobody else knows.",
            "-61": "üìö You win the Realm Literary Award for Poetry. Your acceptance speech is mostly about rivers.",
            "-62": "üé§ You go on a poetry tour. Every city has at least one river enthusiast who comes to listen. It's niche but devoted.",
            "-63": "üòä You simply enjoy knowing your words have been read. No fame, no fortune. Just poetry.",
            "-64": "üëë You become the High Pigeon of the Hat Collective. You wear 47 hats at once. You're living your best life.",
            "-65": "üé® You become famous for hat sculpture. Your work is displayed in galleries. People don't understand it, but they respect it.",
            "-66": "üê¶ You transform into a pigeon. You're not sure how. You're surprisingly okay with it.",
            "-67": "üê¶ You dedicate yourself entirely to the Cult of Hats. You live in the pyramid. You are home.",
            "-68": "üé© As their hat procurement specialist, you become the most successful hat thief in the realm. You're legendary.",
            "-69": "ü§™ You descend into complete pigeon madness. You speak only in pigeon sounds. You are happy.",
            "-70": "üì± You become a viral influencer with millions of followers. Your life is chaos. You regret this.",
            "-71": "üèñÔ∏è You use your fame to buy an island. You live in peace, free from fans. It's perfect.",
            "-72": "üò§ You become a staunch critic of social media. Nobody listens because they find you on social media.",
            "-73": "üíç Derek and Glorp remarry. The wedding is underwater and also in an acid river. It's beautiful and dangerous.",
            "-74": "üò§ They refuse reconciliation and team up against you. You become the villain in their story.",
            "-75": "üéâ They agree to try dating. It's awkward. After a week, they decide they're better as acquaintances. Everyone's fine with this.",
            "-76": "üíî You live with eternal guilt about the statue. You write apology letters to Derek that never reach him.",
            "-77": "üèÉ You flee to a distant land. You assume a new identity. You're free but paranoid.",
            "-78": "‚öñÔ∏è River court finds you guilty. Your punishment is being permanently soaked. It's worse than it sounds.",
            "-79": "‚òÆÔ∏è You find peace knowing not all problems are yours to solve. It's liberating.",
            "-80": "‚õµ You sail toward new adventures. Each one is weirder than the last.",
            "-81": "üßò You become a hybrid river-monk. You meditate in the water. The water meditates with you.",
            "-82": "üîÆ The Church of the Sacred Burp has 10,000 followers. Nobody's quite sure what they believe in.",
            "-83": "üí∏ You become wealthy beyond measure. Your stomach is famous. You're conflicted about this.",
            "-84": "üò∑ Your stomach rebels. You live with eternal indigestion. It's a small price for prophecy.",
            "-85": "üòê You accept being a living magical mystery. You try not to think about it too hard.",
            "-86": "üî¨ Scientists travel from all corners of the realm to study you. You become a medical phenomenon.",
            "-87": "üåç You travel everywhere with your condition on display. You're a living, breathing, burping freak show.",
            "-88": "üåü A kingdom is saved because you burped at the right moment during a war council. History books will never explain this.",
            "-89": "üòÖ You live with the absurdity of having power through your digestive system. It's ridiculous. You're okay with it.",
            "-90": "üé™ You become a carnival attraction. 'See the Prophetic Burper!' Your life is weird but well-paid.",
            "-91": "ü•õ You live in pure yogurt luxury. You're slightly lactose intolerant, but you ignore this. Worth it.",
            "-92": "üç® Your yogurt restaurant becomes famous. Everyone wants to try the yogurt from the lake. It tastes like destiny.",
            "-93": "üåä You establish a yogurt-based economy. Currency is measured in yogurt containers. You're wealthy.",
            "-94": "üåô You spend the rest of your life jumping. You never reach the moon, but you get higher each time.",
            "-95": "ü´ê You become famous for your raspberry preserves. They taste like dreams. People pay premium prices.",
            "-96": "üò¢ You accept that you're bound to earth. You become a farmer. It's peaceful.",
            "-97": "üè† You retire peacefully. Your ship, the SS Bewilderment, eventually wakes up to find you gone. It's sad.",
            "-98": "üìö You write a memoir. It's published. 47 people read it. You consider this success.",
            "-99": "üò¥ You die peacefully, unknown, and content. Sometimes that's enough.",
            "-100": "‚≠ê In the end, you found peace in the chaos. It's beautiful.",
            "-101": "üê¶ You become a legend among pigeons. Hundreds of years later, pigeons still talk about you. You're immortal in bird culture.",
            "-102": "üõãÔ∏è Therapy actually works. You fix your life. It's not exciting, but it's honest. You're satisfied."
        };

        // extra training endings
        endings["-200"] = "üèãÔ∏è You complete the Trial of Mechanics and return wiser. One skill ascends and you keep your new knowledge.";
        endings["-201"] = "ÔøΩ potion You become an Adept of Alchemy; small explosions are now part of your daily routine.";
        endings["-202"] = "üåø You train with a hermit biologist and your Life Force Study improves significantly.";

        function showTrainingMenu(){
            const existing = document.getElementById('training-overlay');
            if(existing) return;
            const overlay = document.createElement('div'); overlay.id='training-overlay'; overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.right='0'; overlay.style.bottom='0'; overlay.style.background='rgba(0,0,0,0.8)'; overlay.style.zIndex=14000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
            const box = document.createElement('div'); box.style.background='#071330'; box.style.border='2px solid #00d4ff'; box.style.padding='20px'; box.style.borderRadius='12px'; box.style.color='#fff'; box.style.maxWidth='720px';

            box.innerHTML = `<h2 style="color:#ffdd57">Training Grounds</h2><p>Choose a discipline to practice. Each choice increases a specific skill and opens further options.</p>`;

            const mech = document.createElement('button'); mech.className='choice-button'; mech.textContent='üîß Practice Arcane Mechanics (Physics) ‚Äî Technical drills';
            mech.onclick = ()=>{ upgradeSkill('Arcane Mechanics'); awardQuestItem('Torn Drill Notes'); showTopNotification('You practiced Mechanics.'); box.innerHTML = `<p>You can now take a harder trial or return.</p>`; const hard = document.createElement('button'); hard.className='choice-button'; hard.textContent='Attempt the Trial of Mechanics'; hard.onclick=()=>{ upgradeSkill('Arcane Mechanics'); savePersistentState(); document.body.removeChild(overlay); displayScene(0); showTopNotification('Trial completed.'); displayScene(-200); }; box.appendChild(hard); const ret = document.createElement('button'); ret.className='reset-button'; ret.textContent='Return'; ret.onclick=()=>{ document.body.removeChild(overlay); displayScene(0); }; box.appendChild(ret); };

            const alch = document.createElement('button'); alch.className='choice-button'; alch.textContent='‚öóÔ∏è Practice Alchemical Theory (Chemistry) ‚Äî Mix reagents';
            alch.onclick = ()=>{ upgradeSkill('Alchemical Theory'); awardQuestItem('Smoky Flask'); showTopNotification('You practiced Alchemy.'); box.innerHTML = `<p>You feel ready for an experiment or to return.</p>`; const exp = document.createElement('button'); exp.className='choice-button'; exp.textContent='Run a risky experiment'; exp.onclick=()=>{ upgradeSkill('Alchemical Theory'); savePersistentState(); document.body.removeChild(overlay); displayScene(-201); }; box.appendChild(exp); const ret2 = document.createElement('button'); ret2.className='reset-button'; ret2.textContent='Return'; ret2.onclick=()=>{ document.body.removeChild(overlay); displayScene(0); }; box.appendChild(ret2); };

            const bio = document.createElement('button'); bio.className='choice-button'; bio.textContent='üå± Practice Life Force Study (Biology) ‚Äî Care for a strange plant';
            bio.onclick = ()=>{ upgradeSkill('Life Force Study'); awardQuestItem('Herbal Bundle'); showTopNotification('You studied life forces.'); box.innerHTML = `<p>A hermit offers deeper mentorship or you can leave.</p>`; const mentor = document.createElement('button'); mentor.className='choice-button'; mentor.textContent='Accept mentorship'; mentor.onclick=()=>{ upgradeSkill('Life Force Study'); savePersistentState(); document.body.removeChild(overlay); displayScene(-202); }; box.appendChild(mentor); const ret3 = document.createElement('button'); ret3.className='reset-button'; ret3.textContent='Leave'; ret3.onclick=()=>{ document.body.removeChild(overlay); displayScene(0); }; box.appendChild(ret3); };

            const cancel = document.createElement('button'); cancel.className='reset-button'; cancel.textContent='Cancel'; cancel.onclick=()=>{ document.body.removeChild(overlay); };

            box.appendChild(mech); box.appendChild(alch); box.appendChild(bio); box.appendChild(cancel);
            overlay.appendChild(box); document.body.appendChild(overlay);
        }

        function updateSilliness() {
            // Legacy: replaced by discovery meter; keep hook for compatibility
            updateDiscoveryMeter();
        }

        function updateDiscoveryMeter(){
            // count discovered unique items across all playthroughs
            const discovered = gameState.discovered ? Object.keys(gameState.discovered).length : 0;
            // define total possible 'pieces' (approximate set)
            const totalPieces = Math.max(8, Object.keys(allSkills).length); // simple baseline
            const percent = Math.min(100, Math.round((discovered / totalPieces) * 100));
            // show only numbers (no label)
            const el = document.getElementById('silly-stat');
            if(el) el.textContent = `${discovered}/${totalPieces} (${percent}%)`;
        }

        function displayScene(sceneIndex) {
            if (sceneIndex < 0) {
                // Ending
                // persist progress so replay keeps skills/inventory/discoveries
                savePersistentState();
                document.getElementById('story').innerHTML = '';
                document.getElementById('choices').innerHTML = '';
                document.getElementById('ending-text').innerHTML = endings[sceneIndex] || 'THE END';
                const resetBtn = document.createElement('button');
                resetBtn.className = 'reset-button';
                resetBtn.textContent = 'Start Over';
                resetBtn.onclick = () => {
                    // do NOT reset skill levels (they persist permanently)
                    gameState.scene = 0;
                    gameState.silliness = 1;
                    // keep skills and skillMatrix intact ‚Äî only reset scene and UI
                    displayScene(0);
                };
                document.getElementById('choices').appendChild(resetBtn);
                return;
            }

            const scene = scenes[sceneIndex];
            document.getElementById('story').textContent = scene.text;
            document.getElementById('ending-text').innerHTML = '';
            
            const choicesDiv = document.getElementById('choices');
            choicesDiv.innerHTML = '';
            
            scene.choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'choice-button';
                btn.textContent = choice.text;
                // gating by requiredSkill: { name: 'Numerical Harmony', level: 3 }
                let disabled = false;
                if(choice.requiredSkill){
                    const req = choice.requiredSkill;
                    const have = gameState.skills[req.name] || 0;
                    if(have < req.level) disabled = true;
                    btn.textContent += `  (requires ${req.name} L${req.level})`;
                    if(disabled) btn.style.opacity = '0.45';
                }

                btn.onclick = () => {
                    if(disabled){
                        showTopNotification('You lack the required skill level. Play again to improve.');
                        return;
                    }

                    // First choice grants skill upgrade
                    if (gameState.scene === 0 && choice.next === 1) {
                        upgradeAllCore();
                        awardQuestItem("Glowing Scroll");
                    }

                    // Execute any choice-specific callback
                    if (choice.onChoose) {
                        try{ choice.onChoose(); }catch(e){console.error(e);}
                    }

                    gameState.scene = choice.next;
                    updateDiscoveryMeter();
                    displayScene(choice.next);
                };
                choicesDiv.appendChild(btn);
            });

            updateDiscoveryMeter();
            updateStatsDisplay();
            updateInventoryDisplay();
        }

        // restore persistent progress (skills, discoveries, inventory)
        loadPersistentState();
        // ensure matrices exist but reset active runtime skills/inventory on page load
        if(!gameState.skillMatrix) gameState.skillMatrix = {};
        coreSkills.forEach(k=>{ gameState.skills[k]=1; if(!gameState.skillMatrix[k]) gameState.skillMatrix[k]=[]; if(!gameState.unlockedSkills.includes(k)) gameState.unlockedSkills.push(k); });
        gameState.overallLevel = 1;
        // Reset runtime inventory to starter item so page loads 'fresh'
        gameState.inventory = ['Worn Quill Pen'];
        // Force role re-selection on fresh load
        gameState.avatar.role = null;
        updateStatsDisplay();
        updateInventoryDisplay();
        displayScene(0);
        updateDiscoveryMeter();
        // If player has no chosen role (fresh start), prompt for role and populate inventory
        if(!gameState.avatar || !gameState.avatar.role){
            showRoleSelector();
        }
        // wire training button and restart
        const tbtn = document.getElementById('training-button');
        if(tbtn) tbtn.onclick = showTrainingMenu;
        const rbtn = document.getElementById('restart-button');
        if(rbtn) rbtn.onclick = restartRun;
    </script>
</body>
</html>
