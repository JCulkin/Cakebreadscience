<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jump Triangles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a0026 0%, #2d0052 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .nav-links {
            margin-bottom: 10px;
        }

        .nav-links a {
            color: #00ffff;
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 5px;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 0 5px;
            display: inline-block;
        }

        .nav-links a:hover {
            background: rgba(0, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #ff00ff;
        }

        p {
            opacity: 0.8;
        }

        #sketch-container {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(20, 0, 40, 0.8);
            border: 2px solid #ff00ff;
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
            margin-bottom: 20px;
        }

        button {
            padding: 15px 30px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 24px;
            color: white;
            background-color: #ff0000;
            box-shadow: 0 4px 0 #990000;
            transition: background-color 0.1s;
        }

        button:hover {
            background-color: #cc0000;
        }

        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: #ff0000;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            border: 2px solid #ff0000;
            display: none;
        }

        .error h2 {
            margin-bottom: 10px;
        }

        .error button {
            background-color: #0066cc;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-links">
            <a href="../index.html">‚Üê Home</a>
            <a href="../highscores.html">üèÜ High Scores</a>
        </div>
        <h1>Jump Triangles</h1>
        <p>Double-jump your way through the obstacles!</p>
    </header>

    <div id="sketch-container"></div>

    <div id="error" class="error" style="display: none;">
        <h2>‚ö†Ô∏è GAME OVER</h2>
        <p id="error-message">Something went wrong!</p>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCuVPaA6drzbiSexez5cXct2SbQMb68kd4",
            authDomain: "elevenstudents-76f31.firebaseapp.com",
            databaseURL: "https://elevenstudents-76f31-default-rtdb.firebaseio.com",
            projectId: "elevenstudents-76f31",
            storageBucket: "elevenstudents-76f31.appspot.com",
            messagingSenderId: "431199775636",
            appId: "1:431199775636:web:4bd24fabc5b9fe84b70d63"
        };

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // --- GLOBAL VARIABLES AND CONSTANTS ---
        let gameState = 'PLAY';
        const GROUND_Y = 400;
        const PLAYER_SIZE = 40;

        // --- PHYSICS ---
        const GRAVITY = 0.8;      
        const JUMP_STRENGTH = -15;
        const MAX_JUMPS = 2;

        let score = 0;
        let speed = 8;

        let player;
        let obstacles = [];
        let restartButton;


        // --- PLAYER CLASS ---
        class Player {
          constructor() {
            this.x = 100;
            this.y = GROUND_Y - PLAYER_SIZE;
            this.velY = 0;
            this.jumpCount = MAX_JUMPS;
            this.rotation = 0;
          }

          update() {
            this.velY += GRAVITY;
            this.y += this.velY;

            if (this.y >= GROUND_Y - PLAYER_SIZE) {
              this.y = GROUND_Y - PLAYER_SIZE;
              this.velY = 0;
              this.jumpCount = MAX_JUMPS;
            }
           
            this.rotation = map(this.y, GROUND_Y - PLAYER_SIZE, 100, 0, PI/2);
          }

          jump() {
            if (this.jumpCount > 0) {
              this.velY = JUMP_STRENGTH;
              this.jumpCount--;
            }
          }

          show() {
            push();
            translate(this.x + PLAYER_SIZE / 2, this.y + PLAYER_SIZE / 2);
            rotate(this.rotation);
           
            if (this.jumpCount === 1 && this.y < GROUND_Y - PLAYER_SIZE) {
                fill(255, 200, 0);
            } else {
                fill(255, 165, 0);
            }
           
            noStroke();
            rectMode(CENTER);
            square(0, 0, PLAYER_SIZE);
            pop();
          }
         
          getBounds() {
            return {
              x: this.x,
              y: this.y,
              w: PLAYER_SIZE,
              h: PLAYER_SIZE
            };
          }
        }


        // --- OBSTACLE CLASS ---
        class Obstacle {
          constructor(x, heightType = 'SINGLE') {
            this.x = x;
            this.y = GROUND_Y;
           
            if (heightType === 'TALL') {
              this.size = 120; // Colossal double-jump required obstacle
              this.color = color(0, 150, 0);
            } else {
              this.size = 60; // Very tall standard spike
              this.color = color(0, 0, 0);
            }
            this.heightType = heightType;
          }

          update() {
            this.x -= speed;
          }

          show() {
            fill(this.color);
            stroke(255);
            strokeWeight(1);
           
            triangle(
              this.x, this.y,
              this.x + this.size, this.y,
              this.x + this.size / 2, this.y - this.size
            );
          }
         
          checkCollision(player) {
            let p = player.getBounds();
           
            if (p.y + p.h > this.y - this.size) {
              if (p.x + p.w > this.x && p.x < this.x + this.size) {
                return true;
              }
            }
            return false;
          }
         
          isOffScreen() {
            return this.x + this.size < 0;
          }
        }


        // --- SETUP AND DRAW FUNCTIONS ---

        function setup() {
          let canvas = createCanvas(800, 500);
          canvas.parent('sketch-container');
          frameRate(60);
         
          restartButton = createButton('RESTART');
          restartButton.mousePressed(resetGame);
          restartButton.hide();
         
          resetGame();
        }

        function draw() {
          background(60, 0, 80);
          drawGrid();
         
          if (gameState === 'PLAY') {
            player.update();
            handleObstacles();
           
            drawGround();
            for (let obs of obstacles) {
              obs.update();
              obs.show();
             
              if (obs.checkCollision(player)) {
                gameOver();
              }
            }
            player.show();
           
            score++;
            displayScore();
           
          } else if (gameState === 'OVER') {
            drawGround();
            drawGameOver();
          }
        }


        // --- INPUT AND GAME FLOW ---

        function mousePressed() {
          if (gameState === 'PLAY') {
            player.jump();
          }
        }

        function keyPressed() {
          if (gameState === 'PLAY' && key === ' ') {
            player.jump();
            return false;
          }
        }

        function gameOver() {
          gameState = 'OVER';
          noLoop();
          restartButton.show();
          
          let finalScore = floor(score / 10);
          checkHighScore(finalScore);
        }

        function resetGame() {
          gameState = 'PLAY';
          score = 0;
          obstacles = [];
          player = new Player();
          restartButton.hide();
          loop();
        }


        // --- OBSTACLE GENERATION AND DRAWING HELPERS ---

        function handleObstacles() {
          obstacles = obstacles.filter(obs => !obs.isOffScreen());
         
          if (obstacles.length === 0 || (width - obstacles[obstacles.length - 1].x) > random(250, 450)) {
           
            let nextX = width + random(100, 300);
           
            let obstacleType = random() < 0.25 ? 'TALL' : 'SINGLE';
           
            if (obstacleType === 'TALL') {
                obstacles.push(new Obstacle(nextX, 'TALL'));
            } else {
                let numSpikes = floor(random(1, 3));
                for (let i = 0; i < numSpikes; i++) {
                  obstacles.push(new Obstacle(nextX + (i * 65), 'SINGLE'));
                }
            }
          }
        }

        function drawGround() {
          fill(0, 200, 0);
          noStroke();
          rect(0, GROUND_Y, width, height - GROUND_Y);
        }

        function drawGrid() {
          stroke(100, 0, 150);
          strokeWeight(1);
         
          for (let i = 0; i < height; i += 50) {
            line(0, i, width, i);
          }
          for (let i = 0; i < width; i += 50) {
            line(i, 0, i, height);
          }
        }

        function displayScore() {
          fill(255);
          textSize(32);
          textAlign(LEFT);
          text('Score: ' + floor(score / 10), 20, 40);
         
          fill(52, 211, 235);
          textSize(18);
          textAlign(RIGHT);
          text('Jumps: ' + player.jumpCount, width - 20, 40);
        }

        function drawGameOver() {
          fill(255, 0, 0);
          textSize(64);
          textAlign(CENTER);
          text('GAME OVER', width / 2, height / 2 - 30);
          textSize(32);
          text('Final Score: ' + floor(score / 10), width / 2, height / 2 + 30);
        }

        // --- HIGH SCORES ---

        // High score functions
        function loadHighScores(callback) {
            if (!database) {
                callback([]);
                return;
            }
            
            const scoresRef = database.ref('jumpTrianglesHighScores');
            scoresRef.once('value')
                .then((snapshot) => {
                    const scores = snapshot.val();
                    if (scores && Array.isArray(scores)) {
                        callback(scores);
                    } else {
                        callback([]);
                    }
                })
                .catch((error) => {
                    console.error('Error loading high scores:', error);
                    callback([]);
                });
        }
        
        function saveHighScores(scores) {
            if (!database) {
                console.error('Firebase not initialized');
                return;
            }
            
            const scoresRef = database.ref('jumpTrianglesHighScores');
            scoresRef.set(scores)
                .then(() => {
                    console.log('High scores saved successfully');
                })
                .catch((error) => {
                    console.error('Error saving high scores:', error);
                });
        }
        
        function isTopTenScore(score, callback) {
            loadHighScores((highScores) => {
                const qualifies = highScores.length < 10 || score > highScores[highScores.length - 1].score;
                callback(qualifies);
            });
        }
        
        function addHighScore(name, score) {
            loadHighScores((highScores) => {
                highScores.push({
                    name: name,
                    score: score,
                    date: new Date().toISOString()
                });
                
                highScores.sort((a, b) => b.score - a.score);
                const top10 = highScores.slice(0, 10);
                saveHighScores(top10);
                
                const rank = top10.findIndex(entry => entry.score === score && entry.name === name) + 1;
                alert(`üèÜ Congratulations ${name}!\nYou ranked #${rank} with ${score} points!\n\nView the leaderboard to see all high scores!`);
            });
        }
        
        function checkHighScore(finalScore) {
            isTopTenScore(finalScore, (qualifies) => {
                if (qualifies && finalScore > 0) {
                    let playerName = prompt('üéâ You made the Top 10! Enter your name:');
                    
                    if (playerName) {
                        playerName = playerName.trim();
                        if (playerName.length === 0) {
                            playerName = 'Anonymous';
                        }
                        if (playerName.length > 20) {
                            playerName = playerName.substring(0, 20);
                        }
                        
                        addHighScore(playerName, finalScore);
                    }
                }
            });
        }
    </script>

</body>
</html>