<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar System Game | Elevenstudents(best)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            min-height: 100vh;
            color: white;
            overflow: auto; /* allow scrolling to see full expanded canvas */
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px #ff00ff, 0 0 40px #00ffff;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #ff00ff, 0 0 40px #00ffff; }
            to { text-shadow: 0 0 30px #00ffff, 0 0 60px #ff00ff; }
        }

        .back-link {
            color: #00ffff;
            text-decoration: none;
            opacity: 0.8;
            transition: opacity 0.3s;
            display: inline-block;
            margin-bottom: 10px;
        }

        .back-link:hover {
            opacity: 1;
        }

        .content {
            display: block;
            margin-bottom: 20px;
        }

        .canvas-container {
            background: #000;
            border-radius: 16px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #ff00ff;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
            height: auto;
            position: relative;
        }

        .info-panel {
            background: rgba(20, 0, 40, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            max-height: 600px;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }

        .info-section p, .info-section ul {
            opacity: 0.9;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .info-section ul {
            list-style-position: inside;
            margin-top: 10px;
        }

        .controls {
            background: rgba(0, 0, 0, 0.5);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85em;
            border: 1px solid #ff00ff;
            margin-bottom: 15px;
        }

        .controls div {
            margin-bottom: 6px;
        }

        .key {
            display: inline-block;
            background: rgba(255, 0, 255, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 5px;
            border: 1px solid #ff00ff;
        }

        .tag {
            display: inline-block;
            background: rgba(0, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 6px;
            margin-top: 5px;
            border: 1px solid #00ffff;
        }

        .version {
            color: #ff00ff;
            font-weight: bold;
            text-shadow: 0 0 5px #ff00ff;
        }

        .chaos-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: #ffff00;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            z-index: 1000;
            border: 2px solid #ffff00;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .score-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid #00ff00;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff;
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: #ff0000;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            border: 2px solid #ff0000;
        }

        @media (max-width: 1100px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="../index.html" class="back-link">‚Üê Back to Gallery</a>
            <a href="../highscores.html" class="back-link" style="margin-left: 20px;">üèÜ High Scores</a>
            <h1>Solar System Game</h1>
            <p>üöÄ Navigate space and collect crystals!</p>
        </header>

        <div class="content">
            <div class="canvas-container" id="sketch-container">
                <div class="loading" id="loading">Loading...</div>
            </div>
        </div>

        <div class="back-links">
            <a href="../index.html" class="back-link">‚Üê Back to Home</a>
            <a href="../highscores.html" class="back-link">üèÜ High Scores</a>
        </div>

        <div id="error" class="error" style="display: none;">
            <h2>‚ö†Ô∏è GAME OVER</h2>
            <p id="error-message">Something went wrong!</p>
            <button onclick="location.reload()">Play Again</button>
        </div>

        <div id="status" class="status">Initializing...</div>
    </div>

    <script>
        // Firebase Configuration - LIVE VALUES
        const firebaseConfig = {
            apiKey: "AIzaSyARP2uokd2lPxXcpPwII3MfK6b_NzSmeO8",
            authDomain: "elevenstudents-76f31.firebaseapp.com",
            databaseURL: "https://elevenstudents-76f31-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "elevenstudents-76f31",
            storageBucket: "elevenstudents-76f31.firebasestorage.app",
            messagingSenderId: "692298982954",
            appId: "1:692298982954:web:987f73aec7d26d03f8c553",
            measurementId: "G-6TN07BNZD0"
        };

        // Firebase not used

        // Game state variables
        const HIGH_SCORES_KEY = 'solarSystemHighScores';
        let gameOver = false;
        let player; // Earth
        let planets = []; // Other planets (enemies)
        let asteroidFragments = []; // Collectibles
        let projectiles = []; // Earth's defense projectiles
        let particles = [];
        let stars = [];
        let canvasWidth = 800;
        let canvasHeight = 600;
        let revealedGasGiants = false;
        let ammo = 50; // Mass IS the score
        let maxAmmo = 999;
        let sunSize = 30; // Sun starts small
        let sunGrowthRate = 0.15; // Sun grows over time (faster!)
        let gameTime = 0;
        let earthInOrbit = true; // Earth starts locked in orbit at distance 180
        let earthOrbitAngle = 0;
        let earthOrbitDistance = 180; // Earth's natural orbit
        let earthOrbitSpeed = 0.006;
        let jupiterUpgradeUnlocked = false;
        let outerSpaceWarning = false;
        let controlsFlashTimer = 300; // Show controls for 5 seconds at start
        let controlsFlashShown = false; // Only show controls once per page load
        let damageFlashTimer = 0; // Flash red border when taking damage
        
        // Planet definitions (including all outer planets)
        const planetDefs = {
            mercury: { name: 'Mercury', size: 8, color: [168, 168, 168], orbitDistance: 80, speed: 0.015 },
            venus: { name: 'Venus', size: 12, color: [255, 200, 80], orbitDistance: 130, speed: 0.01 },
            mars: { name: 'Mars', size: 10, color: [200, 100, 80], orbitDistance: 190, speed: 0.008 },
            jupiter: { name: 'Jupiter', size: 35, color: [200, 140, 80], orbitDistance: 290, speed: 0.004 },
            saturn: { name: 'Saturn', size: 28, color: [220, 180, 100], orbitDistance: 350, speed: 0.003 },
            uranus: { name: 'Uranus', size: 20, color: [100, 180, 200], orbitDistance: 410, speed: 0.002 },
            neptune: { name: 'Neptune', size: 20, color: [50, 100, 200], orbitDistance: 460, speed: 0.0015 },
            pluto: { name: 'Pluto', size: 6, color: [180, 160, 140], orbitDistance: 500, speed: 0.001 }
        };
        
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log(message);
        }

        function setup() {
            try {
                updateStatus("Creating canvas...");
                let canvas = createCanvas(canvasWidth, canvasHeight);
                canvas.parent('sketch-container');
                
                updateStatus("Initializing game objects...");
                
                // Create player as Earth (starting at Earth's orbital distance)
                player = {
                    x: canvasWidth / 2 + 180, // Start at Earth's orbit distance (180px from sun)
                    y: canvasHeight / 2,
                    size: 14,
                    speed: 6,
                    color: [100, 150, 255],
                    health: 100,
                    maxHealth: 100,
                    shield: 50,
                    maxShield: 50
                };
                
                // Initialize inner planets as enemies (Mercury, Venus, Mars)
                initPlanets();
                
                // Create asteroid fragments to collect
                spawnAsteroidFragments(7);
                
                // Create stars background
                for(let i = 0; i < 150; i++) {
                    stars.push({
                        x: random(canvasWidth),
                        y: random(canvasHeight),
                        size: random(1, 3),
                        brightness: random(100, 255)
                    });
                }
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                updateStatus("Click to shoot! WASD to move. Destroy a planet to break free from orbit!");
                
            } catch (error) {
                showError("Setup failed: " + error.message);
            }
        }
        
        function expandCanvas() {
            canvasWidth = min(canvasWidth + 200, 1400);
            canvasHeight = min(canvasHeight + 150, 1000);
            resizeCanvas(canvasWidth, canvasHeight);
            
            // Add more stars for expanded view
            for(let i = 0; i < 50; i++) {
                stars.push({
                    x: random(canvasWidth),
                    y: random(canvasHeight),
                    size: random(1, 3),
                    brightness: random(100, 255)
                });
            }
        }
        
        function checkJupiterUpgrade() {
            // Check if all non-Jupiter planets are defeated
            let hasJupiter = planets.some(p => p.key === 'jupiter');
            let nonJupiterPlanets = planets.filter(p => p.key !== 'jupiter');
            // Only activate if Jupiter exists and ALL other planets are dead
            if(hasJupiter && nonJupiterPlanets.length === 0 && !jupiterUpgradeUnlocked) {
                jupiterUpgradeUnlocked = true;
                updateStatus("‚ö° JUPITER KILLER UPGRADE! Triple damage vs Jupiter!");
                ammo += 100; // Bonus mass
            }
        }
        
        function initPlanets() {
            planets = [];
            const innerPlanets = ['mercury', 'venus', 'mars'];
            
            for(let key of innerPlanets) {
                let def = planetDefs[key];
                let health = 40 + def.size * 2;
                if(key === 'jupiter') health = 300; // Jupiter is very tough
                
                planets.push({
                    key: key,
                    name: def.name,
                    x: canvasWidth / 2,
                    y: canvasHeight / 2,
                    size: def.size,
                    color: def.color,
                    orbitDistance: def.orbitDistance,
                    speed: def.speed,
                    angle: random(TWO_PI),
                    shootCooldown: 0,
                    health: health
                });
            }
        }
        
        function spawnAsteroidFragments(count) {
            const padding = 60;
            for(let i = 0; i < count; i++) {
                asteroidFragments.push({
                    x: random(padding, canvasWidth - padding),
                    y: random(padding, canvasHeight - padding),
                    size: 8,
                    value: 10,
                    collected: false,
                    pulse: random(TWO_PI)
                });
            }
        }

        function draw() {
            if(gameOver) {
                drawGameOver();
                return;
            }
            
            // Increment game time
            gameTime++;
            if(damageFlashTimer > 0) damageFlashTimer--;
            
            // Grow the sun (becoming a red giant)
            sunSize += sunGrowthRate;
            
            // Check if sun has touched player (instant death)
            let distToSun = dist(player.x, player.y, canvasWidth / 2, canvasHeight / 2);
            if(distToSun < sunSize / 2 + player.size / 2) {
                gameOver = true;
                showGameOver("‚òÄÔ∏è Incinerated by the Sun!");
                return;
            }
            
            // Take damage if near the sun (proximity damage)
            let sunProximityDanger = sunSize / 2 + 80; // Damage zone extends 80px beyond sun
            if(distToSun < sunProximityDanger) {
                let proximityDamage = 0.3 + (1 - (distToSun / sunProximityDanger)) * 0.5; // More damage closer to sun
                player.health -= proximityDamage;
                registerDamage();
                if(player.health <= 0) {
                    gameOver = true;
                    showGameOver("üî• Burned by solar radiation!");
                    return;
                }
            }
            
            // Clear background
            background(5, 5, 20);
            
            // Draw background sun and orbits
            drawSunAndOrbits();
            
            // Draw stars
            drawStars();
            
            // Draw asteroid fragments
            drawAsteroidFragments();
            
            // Draw planets
            drawPlanets();
            
            // Draw projectiles
            drawProjectiles();
            
            // Draw player
            drawPlayer();
            
            // Draw particles
            drawParticles();
            
            // Update game
            updateGame();
            
            // Flash damage border if recently hit
            drawDamageOverlay();

            // Draw UI overlay
            drawUI();
        }
        
        function drawSunAndOrbits() {
            push();
            
            // Draw expanding sun (turning red as it grows)
            noStroke();
            // Sun reddens over time and size
            let redShift = min((sunSize / 220) + (gameTime / 20000), 1);
            fill(255, 200 - redShift * 100, 0, 80);
            ellipse(canvasWidth / 2, canvasHeight / 2, sunSize * 2.5);
            fill(255, 150 - redShift * 50, 0, 120);
            ellipse(canvasWidth / 2, canvasHeight / 2, sunSize * 1.8);
            fill(255, 200 - redShift * 150, 0);
            ellipse(canvasWidth / 2, canvasHeight / 2, sunSize);
            
            // Draw orbit lines for visible planets
            stroke(100, 150, 200, 40);
            strokeWeight(1);
            for(let planet of planets) {
                noFill();
                ellipse(canvasWidth / 2, canvasHeight / 2, planet.orbitDistance * 2);
            }
            
            // Draw gas giant orbits if revealed
            if(revealedGasGiants) {
                for(let key of ['jupiter', 'saturn', 'uranus', 'neptune', 'pluto']) {
                    let def = planetDefs[key];
                    stroke(150, 100, 200, 30);
                    noFill();
                    ellipse(canvasWidth / 2, canvasHeight / 2, def.orbitDistance * 2);
                }
            }
            
            // Draw Earth's orbit line only while locked
            if(earthInOrbit) {
                stroke(100, 255, 100, 80);
                strokeWeight(2);
                noFill();
                ellipse(canvasWidth / 2, canvasHeight / 2, earthOrbitDistance * 2);
            }
            
            pop();
        }

        function drawStars() {
            push();
            for(let star of stars) {
                stroke(star.brightness);
                strokeWeight(star.size);
                point(star.x, star.y);
            }
            pop();
        }
        
        function drawAsteroidFragments() {
            for(let i = asteroidFragments.length - 1; i >= 0; i--) {
                let frag = asteroidFragments[i];
                
                if(!frag.collected) {
                    push();
                    translate(frag.x, frag.y);
                    
                    let pulse = sin(frag.pulse + frameCount * 0.05) * 0.3 + 0.7;
                    fill(200, 150, 100, 200 * pulse);
                    noStroke();
                    
                    // Asteroid fragment
                    rotate(frameCount * 0.02);
                    beginShape();
                    for(let j = 0; j < 5; j++) {
                        let angle = TWO_PI / 5 * j + random(-0.3, 0.3);
                        let r = frag.size * (0.7 + pulse * 0.3);
                        let x = cos(angle) * r;
                        let y = sin(angle) * r;
                        vertex(x, y);
                    }
                    endShape(CLOSE);
                    
                    pop();
                    
                    frag.pulse += 0.1;
                    
                    // Check collection
                    let d = dist(player.x, player.y, frag.x, frag.y);
                    if(d < player.size + frag.size + 10) {
                        frag.collected = true;
                        ammo = min(maxAmmo, ammo + 15); // Ammo IS the score
                        player.shield = min(player.maxShield, player.shield + 5);
                        
                        // Particles
                        for(let j = 0; j < 8; j++) {
                            particles.push({
                                x: frag.x,
                                y: frag.y,
                                vx: random(-3, 3),
                                vy: random(-3, 3),
                                life: 255,
                                color: [200, 150, 100]
                            });
                        }
                    }
                }
            }
        }
        
        function drawPlanets() {
            let planetsDefeated = 0;
            
            for(let planet of planets) {
                if(planet.health <= 0) {
                    planetsDefeated++;
                    
                    // Check if Jupiter was defeated - WIN!
                    if(planet.key === 'jupiter') {
                        gameOver = true;
                        showGameOver("üéâ VICTORY! You defeated Jupiter and saved Earth!");
                        return;
                    }
                    
                    // First planet defeated = Earth breaks free!
                    if(earthInOrbit) {
                        earthInOrbit = false;
                        updateStatus("üåç Earth breaks free from orbit!");
                    }
                    
                    // Spawn particles
                    for(let j = 0; j < 15; j++) {
                        particles.push({
                            x: planet.x,
                            y: planet.y,
                            vx: random(-5, 5),
                            vy: random(-5, 5),
                            life: 255,
                            color: planet.color
                        });
                    }
                }
            }
            
            // Remove defeated planets
            let oldPlanetCount = planets.length;
            planets = planets.filter(p => p.health > 0);
            let newPlanetCount = planets.length;
            
            if(newPlanetCount < oldPlanetCount) {
                ammo += (oldPlanetCount - newPlanetCount) * 25; // Bonus mass (half previous)
                
                // Check Jupiter upgrade
                checkJupiterUpgrade();
                
                // Check for gas giants unlock
                if(!revealedGasGiants && newPlanetCount === 0) {
                    revealedGasGiants = true;
                    expandCanvas(); // Expand the screen!
                    updateStatus("ü™ê Outer Planets Revealed! Screen Expanded!");
                    
                    // Add all outer planets
                    for(let key of ['jupiter', 'saturn', 'uranus', 'neptune', 'pluto']) {
                        let def = planetDefs[key];
                        let health = 80 + def.size * 2;
                        if(key === 'jupiter') health = 300; // Jupiter is very tough
                        
                        planets.push({
                            key: key,
                            name: def.name,
                            x: canvasWidth / 2,
                            y: canvasHeight / 2,
                            size: def.size,
                            color: def.color,
                            orbitDistance: def.orbitDistance,
                            speed: def.speed,
                            angle: random(TWO_PI),
                            shootCooldown: random(100, 200),
                            health: health
                        });
                    }
                }
            }
            
            // Draw remaining planets
            for(let planet of planets) {
                // Update orbit position
                planet.angle += planet.speed;
                planet.x = canvasWidth / 2 + cos(planet.angle) * planet.orbitDistance;
                planet.y = canvasHeight / 2 + sin(planet.angle) * planet.orbitDistance;
                
                // Check if planet touches the sun (instant death)
                let distToSun = dist(planet.x, planet.y, canvasWidth / 2, canvasHeight / 2);
                if(distToSun < sunSize / 2 + planet.size / 2) {
                    planet.health = 0; // Instant death
                    updateStatus("‚òÄÔ∏è " + planet.key.toUpperCase() + " consumed by the sun!");
                }
                
                // Draw planet with realistic features
                push();
                translate(planet.x, planet.y);
                
                // Draw planet body
                fill(planet.color[0], planet.color[1], planet.color[2]);
                noStroke();
                ellipse(0, 0, planet.size);
                
                // Add realistic features
                if(planet.key === 'saturn') {
                    // Saturn's rings
                    stroke(220, 200, 150, 180);
                    strokeWeight(3);
                    noFill();
                    ellipse(0, 0, planet.size * 1.8, planet.size * 0.6);
                    ellipse(0, 0, planet.size * 1.5, planet.size * 0.5);
                } else if(planet.key === 'jupiter') {
                    // Jupiter's red spot
                    fill(200, 80, 60);
                    noStroke();
                    ellipse(planet.size * 0.2, 0, planet.size * 0.3);
                    // Jupiter's bands
                    stroke(180, 120, 60, 100);
                    strokeWeight(2);
                    line(-planet.size/2, -planet.size/4, planet.size/2, -planet.size/4);
                    line(-planet.size/2, planet.size/4, planet.size/2, planet.size/4);
                } else if(planet.key === 'mars') {
                    // Mars polar ice cap
                    fill(255, 255, 255, 200);
                    noStroke();
                    ellipse(0, -planet.size/3, planet.size/4);
                } else if(planet.key === 'venus') {
                    // Venus clouds
                    stroke(255, 220, 120, 100);
                    strokeWeight(1);
                    noFill();
                    ellipse(0, 0, planet.size * 0.8);
                } else if(planet.key === 'uranus') {
                    // Uranus tilt and faint rings
                    stroke(120, 200, 220, 80);
                    strokeWeight(1);
                    noFill();
                    ellipse(0, 0, planet.size * 1.3, planet.size * 0.4);
                } else if(planet.key === 'neptune') {
                    // Neptune's dark spot
                    fill(30, 60, 150);
                    noStroke();
                    ellipse(-planet.size * 0.2, planet.size * 0.1, planet.size * 0.25);
                } else if(planet.key === 'pluto') {
                    // Pluto's heart-shaped region
                    fill(220, 200, 180);
                    noStroke();
                    ellipse(planet.size * 0.15, 0, planet.size * 0.4, planet.size * 0.35);
                }
                
                // Health indicator
                if(planet.health < (planet.key === 'jupiter' ? 100 : planet.size * 2.5)) {
                    stroke(255, 0, 0, 150);
                    strokeWeight(2);
                    noFill();
                    ellipse(0, 0, planet.size + 6);
                }
                
                pop();
                
                // Shoot projectiles at player
                planet.shootCooldown--;
                if(planet.shootCooldown <= 0) {
                    let dx = player.x - planet.x;
                    let dy = player.y - planet.y;
                    let dist = sqrt(dx * dx + dy * dy);
                    if(dist < 400) {
                        let angle = atan2(dy, dx);
                        projectiles.push({
                            x: planet.x,
                            y: planet.y,
                            vx: cos(angle) * 3,
                            vy: sin(angle) * 3,
                            size: 5,
                            fromPlayer: false,
                            damage: 20,
                            life: 120,
                            source: planet.key
                        });
                        planet.shootCooldown = 80;
                    }
                }
            }
        }
        
        function drawProjectiles() {
            for(let i = projectiles.length - 1; i >= 0; i--) {
                let proj = projectiles[i];
                
                proj.x += proj.vx;
                proj.y += proj.vy;
                proj.life--;
                
                push();
                if(proj.fromPlayer) {
                    fill(255, 200, 0, proj.life * 2);
                } else {
                    fill(255, 0, 100, proj.life * 2);
                }
                noStroke();
                ellipse(proj.x, proj.y, proj.size);
                pop();
                
                // Off screen
                if(proj.x < 0 || proj.x > width || proj.y < 0 || proj.y > height || proj.life <= 0) {
                    projectiles.splice(i, 1);
                    continue;
                }
                
                // Check collisions
                if(proj.fromPlayer) {
                    // Check collision with planets
                    for(let planet of planets) {
                        let d = dist(proj.x, proj.y, planet.x, planet.y);
                        if(d < planet.size / 2 + proj.size) {
                            // Jupiter is immune until upgrade
                            if(planet.key === 'jupiter' && !jupiterUpgradeUnlocked) {
                                projectiles.splice(i, 1);
                                break;
                            }

                            let damage = proj.damage;
                            // Jupiter upgrade: triple damage to Jupiter
                            if(jupiterUpgradeUnlocked && planet.key === 'jupiter') {
                                damage *= 3;
                            }
                            planet.health -= damage;
                            projectiles.splice(i, 1);
                            
                            // Impact particles
                            for(let j = 0; j < 5; j++) {
                                particles.push({
                                    x: proj.x,
                                    y: proj.y,
                                    vx: random(-3, 3),
                                    vy: random(-3, 3),
                                    life: 150,
                                    color: [255, 200, 0]
                                });
                            }
                            break;
                        }
                    }
                } else {
                    // Check collision with player
                    let d = dist(proj.x, proj.y, player.x, player.y);
                    if(d < player.size + proj.size) {
                        if(proj.source === 'jupiter') {
                            player.health = 0;
                        }
                        if(player.shield > 0) {
                            player.shield -= proj.damage;
                        } else {
                            player.health -= proj.damage;
                        }
                        registerDamage();
                        projectiles.splice(i, 1);
                        
                        // Damage particles
                        for(let j = 0; j < 5; j++) {
                            particles.push({
                                x: proj.x,
                                y: proj.y,
                                vx: random(-4, 4),
                                vy: random(-4, 4),
                                life: 150,
                                color: [255, 0, 100]
                            });
                        }
                        
                        if(player.health <= 0) {
                            gameOver = true;
                            showGameOver("üí• Earth Destroyed!");
                        }
                    }
                }
            }
        }

        function drawPlayer() {
            // If Earth is in orbit, update its position
            if(earthInOrbit) {
                earthOrbitAngle += earthOrbitSpeed;
                player.x = canvasWidth / 2 + cos(earthOrbitAngle) * earthOrbitDistance;
                player.y = canvasHeight / 2 + sin(earthOrbitAngle) * earthOrbitDistance;
            }
            
            push();
            translate(player.x, player.y);
            
            // Shield glow
            if(player.shield > 0) {
                fill(0, 255, 255, 50);
                noStroke();
                ellipse(0, 0, player.size + 20);
            }
            
            // Planet Earth
            fill(player.color[0], player.color[1], player.color[2]);
            noStroke();
            ellipse(0, 0, player.size);
            
            // Continents (more realistic)
            fill(100, 200, 100);
            ellipse(-3, -2, 5, 4);
            ellipse(3, 3, 4, 3);
            ellipse(-2, 4, 3, 2);
            
            // Clouds
            fill(255, 255, 255, 120);
            ellipse(2, -3, 3, 2);
            ellipse(-4, 1, 2, 1);
            
            // Atmosphere
            stroke(100, 200, 255, 100);
            strokeWeight(1);
            noFill();
            ellipse(0, 0, player.size + 4);
            
            pop();
        }
        
        function drawParticles() {
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.1;
                p.life -= 5;
                
                push();
                fill(p.color[0], p.color[1], p.color[2], p.life);
                noStroke();
                ellipse(p.x, p.y, p.life / 50);
                pop();
                
                if(p.life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        function updateGame() {
            // Handle player movement (only when not in orbit)
            if(!earthInOrbit) {
                if(keyIsDown(LEFT_ARROW) || keyIsDown(65)) { // A key
                    player.x -= player.speed;
                }
                if(keyIsDown(RIGHT_ARROW) || keyIsDown(68)) { // D key
                    player.x += player.speed;
                }
                if(keyIsDown(UP_ARROW) || keyIsDown(87)) { // W key
                    player.y -= player.speed;
                }
                if(keyIsDown(DOWN_ARROW) || keyIsDown(83)) { // S key
                    player.y += player.speed;
                }
                
                // Keep player in bounds
                player.x = constrain(player.x, player.size, canvasWidth - player.size);
                player.y = constrain(player.y, player.size, canvasHeight - player.size);
            }
            
            // Regenerate shield slowly
            if(player.shield < player.maxShield) {
                player.shield += 0.05;
            }
            
            // Regenerate mass very slowly
            if(ammo < maxAmmo) {
                ammo += 0.01;
            }
        }

        function registerDamage() {
            damageFlashTimer = 20; // frames of red border
        }

        function drawDamageOverlay() {
            if(damageFlashTimer > 0) {
                push();
                noFill();
                stroke(255, 0, 0, 180);
                strokeWeight(12);
                rect(0, 0, canvasWidth, canvasHeight);
                pop();
            }
        }
        
        function drawUI() {
            fill(255);
            textSize(16);
            textAlign(LEFT);
            
            let healthPercent = int((player.health / player.maxHealth) * 100);
            let shieldPercent = int((player.shield / player.maxShield) * 100);
            
            text("Earth Health: " + healthPercent + "%", 10, 80);
            text("Atmosphere: " + shieldPercent + "%", 10, 100);
            text("Mass: " + int(ammo), 10, 120);
            
            if(earthInOrbit) {
                fill(255, 200, 0);
                text("üîí LOCKED IN ORBIT - Destroy a planet to break free!", 10, 30);
            }
            
            if(jupiterUpgradeUnlocked) {
                fill(0, 255, 255);
                text("‚ö° JUPITER KILLER ACTIVE", 10, earthInOrbit ? 50 : 30);
            }
            
            // Flash controls once at start
            if(!controlsFlashShown && controlsFlashTimer > 0) {
                controlsFlashTimer--;
                let alpha = controlsFlashTimer > 240 ? 255 : (controlsFlashTimer % 60) * 4;
                fill(0, 255, 255, alpha);
                textSize(32);
                textAlign(CENTER);
                text("‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è WASD to Move", canvasWidth / 2, canvasHeight / 2 - 40);
                text("üñ±Ô∏è Click to Shoot", canvasWidth / 2, canvasHeight / 2 + 20);
                textAlign(LEFT);
                if(controlsFlashTimer <= 0) controlsFlashShown = true;
            }
            
        }

        function showGameOver(reason) {
            let finalScore = int(ammo);
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = (reason || 'Game Over!') + ' Final Mass: ' + finalScore;
        }

        function showError(message) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function mousePressed() {
            if(gameOver) {
                return false;
            }
            
            // Shoot towards mouse with ammo check
            if(ammo >= 5) {
                let dx = mouseX - player.x;
                let dy = mouseY - player.y;
                let angle = atan2(dy, dx);
                
                for(let i = 0; i < 3; i++) {
                    let spreadAngle = angle + random(-0.2, 0.2);
                    projectiles.push({
                        x: player.x,
                        y: player.y,
                        vx: cos(spreadAngle) * 6,
                        vy: sin(spreadAngle) * 6,
                        size: 4,
                        fromPlayer: true,
                        damage: 15,
                        life: 100
                    });
                }
                
                ammo -= 5;
                
                return false;
            } else {
                updateStatus("Out of ammo! Collect asteroids!");
            }
        }

        function keyPressed() {
            if(gameOver) {
                if(key === ' ') {
                    location.reload();
                }
                return false;
            }
            
            // Reset
            if(key === 'r' || key === 'R') {
                location.reload();
            }
            
            return false;
        }
    </script>
</body>
</html>