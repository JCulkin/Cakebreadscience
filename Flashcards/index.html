<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevenstudents Flashcards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            max-width: 800px;
            width: 90%;
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            padding: 36px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.2);
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            color: #667eea;
        }

        .login-screen, .deck-selector, .study-screen {
            display: none;
        }

        .login-screen.active, .deck-selector.active, .study-screen.active {
            display: block;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin: 10px 0;
            font-weight: bold;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-google {
            background: #4285f4;
            border-radius: 12px;
            padding: 14px 30px;
        }

        .btn-google:hover {
            background: #357ae8;
        }

        .deck-list {
            margin: 20px 0;
        }

        .deck-item {
            background: #f8f9fb;
            padding: 18px 22px;
            margin: 8px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid #eef0f4;
            border-left: 5px solid #bdc3c7;
        }

        .deck-item:hover {
            background: #f0f2f8;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .deck-item.deck-biology { border-left-color: #27ae60; }
        .deck-item.deck-biology:hover { border-color: #27ae60; border-left-color: #27ae60; }
        .deck-item.deck-chemistry { border-left-color: #e74c3c; }
        .deck-item.deck-chemistry:hover { border-color: #e74c3c; border-left-color: #e74c3c; }
        .deck-item.deck-physics { border-left-color: #f39c12; }
        .deck-item.deck-physics:hover { border-color: #f39c12; border-left-color: #f39c12; }
        .deck-item.deck-physics-eqns { border-left-color: #f39c12; }
        .deck-item.deck-physics-eqns:hover { border-color: #f39c12; border-left-color: #f39c12; }

        .deck-item h3 {
            color: #444;
            margin-bottom: 0;
            font-size: 1.05em;
        }

        .deck-item p {
            color: #666;
            font-size: 0.9em;
        }

        .study-more-btn {
            font-size: 0.75em;
            color: #667eea;
            background: rgba(102, 126, 234, 0.08);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            padding: 3px 10px;
            cursor: pointer;
            margin-top: 3px;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .study-more-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .flashcard {
            background: white;
            border-radius: 16px;
            padding: 50px 36px;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            line-height: 1.6;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 2px solid #eef0f4;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .flashcard:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .flashcard.flipped {
            background: #fafbfd;
            border-color: #667eea;
        }

        .rating-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .rating-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .rating-btn-1 {
            background: #ff6b6b;
            color: white;
        }

        .rating-btn-2 {
            background: #ffd93d;
            color: #333;
        }

        .rating-btn-3 {
            background: #6bcf7f;
            color: white;
        }

        .rating-btn-4 {
            background: #4dabf7;
            color: white;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fb;
            border-radius: 12px;
            border: 1px solid #eef0f4;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .hint {
            text-align: center;
            color: #bbb;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .card img {
            max-width: 100%;
            height: auto;
            max-height: 500px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .user-info {
            text-align: center;
            margin-bottom: 5px;
            font-size: 0.8em;
            color: #aaa;
        }

        .back-btn {
            background: transparent;
            color: #667eea;
            border: none;
            padding: 8px 0;
            font-size: 0.95em;
            width: auto;
            margin-bottom: 10px;
            box-shadow: none;
        }

        .back-btn:hover {
            background: transparent;
            color: #5568d3;
            transform: none;
            box-shadow: none;
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }

        .progress-bar-container {
            display: flex;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75em;
            font-weight: bold;
            transition: all 0.3s;
            overflow: hidden;
            white-space: nowrap;
        }

        .progress-unseen {
            background: #95a5a6;
        }

        .progress-learning {
            background: #ffd93d;
            color: #333;
        }

        .progress-mastered {
            background: #6bcf7f;
        }

        .top-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 15px;
        }

        .top-btn {
            background: rgba(102, 126, 234, 0.1);
            border: none;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .top-btn:hover {
            background: #667eea;
            color: white;
        }

        .settings-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .settings-panel {
            background: white;
            padding: 36px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            position: relative;
        }

        .settings-panel h2 {
            margin-top: 0;
            color: #333;
            margin-bottom: 30px;
        }

        .setting-item {
            margin-bottom: 25px;
        }

        .setting-item label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        .setting-item input[type="number"] {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #eef0f4;
            border-radius: 10px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .setting-item input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .reset-button {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: #e74c3c;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.25s ease;
        }

        .reset-button:hover {
            background: #e74c3c;
            color: white;
        }

        .settings-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .settings-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.25s ease;
        }

        .save-settings {
            background: #667eea;
            color: white;
        }

        .save-settings:hover {
            background: #5568d3;
        }

        .cancel-settings {
            background: #f0f1f3;
            color: #666;
        }

        .cancel-settings:hover {
            background: #e2e3e5;
        }

        .setting-description {
            font-size: 0.85em;
            color: #777;
            margin-top: 5px;
        }

        .badges-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .badge-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75em;
            font-weight: 600;
            border: 2px solid;
            background: white;
            cursor: default;
            position: relative;
        }

        .badge-chip .badge-icon {
            font-size: 1.1em;
        }

        .badge-chip.badge-bronze { border-color: #cd7f32; color: #cd7f32; }
        .badge-chip.badge-silver { border-color: #a0a0a0; color: #808080; }
        .badge-chip.badge-gold { border-color: #daa520; color: #b8860b; background: #fffdf0; }

        .badge-chip:hover .badge-tooltip {
            display: block;
        }

        .badge-tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 10;
            font-weight: 400;
        }

        .badge-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .users-table th {
            text-align: left;
            padding: 10px 8px;
            border-bottom: 2px solid #eef0f4;
            color: #888;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .users-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f1f3;
            color: #444;
        }

        .users-table tr:last-child td {
            border-bottom: none;
        }

        .user-badges-cell {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .mini-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            border: 1.5px solid;
        }

        .mini-badge.badge-bronze { border-color: #cd7f32; color: #cd7f32; }
        .mini-badge.badge-silver { border-color: #a0a0a0; color: #808080; }
        .mini-badge.badge-gold { border-color: #daa520; color: #b8860b; }

        /* Pet House */
        .pet-house {
            position: fixed;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            width: 180px;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 10px 12px 12px;
            text-align: center;
            display: none;
            z-index: 50;
            overflow: hidden;
        }

        .pet-house.visible { display: block; }

        .pet-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 6px;
            font-size: 0.7em;
            color: #888;
        }
        .pet-stats .stat-val { font-weight: 700; font-size: 1.3em; color: #667eea; display: block; }
        .pet-stats .stat-val.streak-color { color: #f39c12; }

        .pet-room {
            position: relative;
            border-radius: 12px;
            padding: 6px 4px 2px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: background 0.4s ease;
        }

        .pet-room .deco { position: absolute; z-index: 4; width: 30px; height: 38px; }
        .pet-room .deco-left { left: 4px; bottom: 6px; }
        .pet-room .deco-right { right: 4px; bottom: 6px; }
        .pet-room .deco svg { width: 100%; height: 100%; }

        .pet-room .pet-roof {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 28px;
            z-index: 5;
            pointer-events: none;
        }
        .pet-room .pet-roof svg { width: 100%; height: 100%; }

        .pet-room .floor-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 24px;
            z-index: 1;
            pointer-events: none;
        }
        .pet-room .floor-overlay svg { width: 100%; height: 100%; }

        .blob-shadow {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 10px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.12) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 2;
        }

        .pet-house .pet-stage-name {
            font-size: 0.75em;
            font-weight: 700;
            color: #667eea;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pet-house .pet-label {
            font-size: 0.65em;
            color: #aaa;
            margin-top: 1px;
        }

        .pet-btns {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            justify-content: center;
        }

        .pet-btn {
            background: rgba(102, 126, 234, 0.1);
            border: none;
            color: #667eea;
            padding: 5px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.72em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .pet-btn:hover { background: #667eea; color: white; }

        .pet-btn.feed-btn { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .pet-btn.feed-btn:hover { background: #e74c3c; color: white; }
        .pet-btn.feed-btn.fed { background: rgba(39, 174, 96, 0.1); color: #27ae60; pointer-events: none; }

        .hungry-indicator {
            display: none;
            font-size: 1.2em;
            animation: hungryPulse 1.5s ease-in-out infinite;
            position: absolute;
            top: 8px;
            right: 8px;
        }
        .pet-house.blob-hungry .hungry-indicator { display: block; }

        @keyframes hungryPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.15); opacity: 1; }
        }

        .pet-svg-wrap {
            animation: petBounce 2.5s ease-in-out infinite;
            position: relative;
            z-index: 3;
        }

        @keyframes petBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .pet-svg-wrap .eyes {
            animation: petBlink 4s ease-in-out infinite;
        }

        @keyframes petBlink {
            0%, 42%, 46%, 100% { transform: scaleY(1); }
            44% { transform: scaleY(0.05); }
        }

        /* Mood: happy mouth shown by default, sad mouth hidden */
        .mouth-sad { display: none; }
        .pet-house.blob-hungry .mouth-happy { display: none; }
        .pet-house.blob-hungry .mouth-sad { display: block; }

        /* Feed animation */
        .feed-float {
            position: absolute;
            font-size: 1.5em;
            z-index: 10;
            animation: feedFloat 1s ease-out forwards;
            pointer-events: none;
        }

        @keyframes feedFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(0.5); opacity: 0; }
        }

        /* Accessory tier effects */
        .acc-group { display: none; }
        .acc-group.active { display: block; }
        .acc-group.tier-bronze { opacity: 0.85; }
        .acc-group.tier-silver { opacity: 1; }
        .acc-group.tier-gold { opacity: 1; filter: drop-shadow(0 0 3px rgba(218, 165, 32, 0.6)); }

        /* Stage groups */
        .pet-stage { display: none; }
        .pet-stage.active { display: block; }
        .pet-stage.stage-master.active { filter: drop-shadow(0 0 6px rgba(102, 126, 234, 0.5)); }

        /* House floor styles */
        .pet-room.floor-grass { background: linear-gradient(to top, #8bc97e 0%, #b5e4a8 20%, #d4f5d0 35%, transparent 55%); }
        .pet-room.floor-wood { background: linear-gradient(to top, #b8875a 0%, #d4a574 15%, #e8cfa8 30%, transparent 50%); }

        /* House background styles */
        .pet-room.bg-clouds { background: linear-gradient(180deg, #c5e3f6 0%, #e8f4fd 40%, #f0f8ff 100%); }
        .pet-room.bg-stars { background: linear-gradient(180deg, #1a1a3e 0%, #2d2d5e 50%, #3d3d6e 100%); }
        .pet-room.bg-night { background: linear-gradient(180deg, #0a0e2a 0%, #0c1445 30%, #1a237e 70%, #283593 100%); }

        /* Background animated elements */
        .pet-room .bg-cloud {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            z-index: 0;
            pointer-events: none;
        }
        .pet-room.bg-clouds .bg-cloud { opacity: 0.5; animation: cloudDrift linear infinite; }

        @keyframes cloudDrift {
            0% { transform: translateX(-25px); }
            100% { transform: translateX(185px); }
        }

        .pet-room .bg-star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            z-index: 0;
            pointer-events: none;
        }
        .pet-room.bg-stars .bg-star,
        .pet-room.bg-night .bg-star { opacity: 1; animation: twinkle ease-in-out infinite; }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.4); }
        }

        .pet-room .bg-moon {
            position: absolute;
            top: 6px;
            right: 10px;
            z-index: 0;
            opacity: 0;
            pointer-events: none;
        }
        .pet-room.bg-night .bg-moon { opacity: 1; }

        /* Master sparkles */
        .pet-room .sparkle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #ffd93d;
            border-radius: 50%;
            opacity: 0;
            z-index: 6;
            pointer-events: none;
        }
        .pet-room.show-sparkles .sparkle {
            animation: sparkleFloat 2.5s ease-in-out infinite;
        }

        @keyframes sparkleFloat {
            0% { opacity: 0; transform: translateY(0) scale(0); }
            20% { opacity: 1; transform: translateY(-6px) scale(1); }
            80% { opacity: 0.6; transform: translateY(-30px) scale(0.8); }
            100% { opacity: 0; transform: translateY(-38px) scale(0); }
        }

        /* Combined floor + background */
        .pet-room.floor-grass.bg-clouds { background: linear-gradient(to top, #8bc97e 0%, #b5e4a8 18%, #d4f5d0 30%, #e8f4fd 55%, #c5e3f6 100%); }
        .pet-room.floor-grass.bg-stars { background: linear-gradient(to top, #5a8a50 0%, #6b9960 15%, #4a6a40 30%, #2d2d5e 55%, #1a1a3e 100%); }
        .pet-room.floor-grass.bg-night { background: linear-gradient(to top, #3a5a30 0%, #4a6a40 15%, #2a4a20 30%, #1a237e 55%, #0a0e2a 100%); }
        .pet-room.floor-wood.bg-clouds { background: linear-gradient(to top, #b8875a 0%, #d4a574 15%, #e8cfa8 28%, #e8f4fd 50%, #c5e3f6 100%); }
        .pet-room.floor-wood.bg-stars { background: linear-gradient(to top, #8a6545 0%, #a07050 15%, #7a5535 28%, #2d2d5e 50%, #1a1a3e 100%); }
        .pet-room.floor-wood.bg-night { background: linear-gradient(to top, #6a4535 0%, #7a5040 15%, #5a3525 28%, #1a237e 50%, #0a0e2a 100%); }

        /* Store modal */
        .store-tabs { display: flex; gap: 4px; margin-bottom: 16px; }
        .store-tab {
            flex: 1;
            padding: 8px;
            border: 2px solid #eef0f4;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            color: #888;
            transition: all 0.2s;
            text-align: center;
        }
        .store-tab.active { border-color: #667eea; color: #667eea; background: rgba(102, 126, 234, 0.05); }

        .store-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .store-item {
            border: 2px solid #eef0f4;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            transition: all 0.2s;
        }
        .store-item:hover { border-color: #667eea; }
        .store-item .item-emoji { font-size: 1.8em; }
        .store-item .item-name { font-size: 0.8em; font-weight: 600; color: #444; margin: 4px 0 2px; }
        .store-item .item-cost { font-size: 0.75em; color: #667eea; font-weight: 700; }

        .store-item .buy-btn {
            margin-top: 6px;
            padding: 4px 14px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .store-item .buy-btn:hover { background: #5568d3; }
        .store-item .buy-btn:disabled { background: #ccc; cursor: not-allowed; }
        .store-item .buy-btn.owned { background: #27ae60; }

        .store-item .equip-btn {
            margin-top: 6px;
            padding: 4px 14px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .store-item .equip-btn:hover { background: #667eea; color: white; }
        .store-item .equip-btn.equipped { background: #667eea; color: white; }

        .store-balance {
            text-align: center;
            margin-bottom: 14px;
            font-size: 1.1em;
            color: #667eea;
            font-weight: 700;
        }

        .inv-food-count { font-size: 0.7em; color: #888; }

        @media (max-width: 1100px) {
            .pet-house { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen active">
            <div class="card">
                <h1>üéì Elevenstudents Flashcards</h1>
                <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em; color: #666;">
                    Master IGCSE Science with spaced repetition
                </p>
                <button class="btn btn-google" onclick="loginWithGoogle()">
                    Sign in with Google
                </button>
            </div>
        </div>

        <!-- Deck Selector -->
        <div class="deck-selector">
            <div class="card">
                <div class="top-buttons">
                    <a href="../index.html" class="top-btn" style="text-decoration: none; margin-right: auto;">‚Üê Home</a>
                    <button class="top-btn" onclick="openGuide()">üìñ Guide</button>
                    <button class="top-btn" onclick="openUsers()">üë• Users</button>
                    <button class="top-btn" onclick="openProgress()">üìä Progress</button>
                    <button class="top-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
                </div>
                <div class="user-info" id="userInfo"></div>
                <div class="badges-row" id="badgesRow"></div>
                <div id="totalDueToday" style="text-align: center; margin-bottom: 20px; display: none;">
                    <div style="font-size: 3em; font-weight: bold; color: #667eea; line-height: 1;" id="totalDueCount">0</div>
                    <div style="font-size: 0.95em; color: #888;">cards due today</div>
                    <div style="font-size: 0.85em; color: #aaa; margin-top: 4px;" id="totalDueTime"></div>
                </div>
                <div class="deck-list" id="deckList">
                    <div class="loading">Loading decks...</div>
                </div>
            </div>
        </div>

        <!-- Pet House -->
        <div class="pet-house" id="petHouse">
            <span class="hungry-indicator">üçΩÔ∏è</span>
            <div class="pet-stats">
                <div><span class="stat-val" id="petPoints">0</span>pts</div>
                <div><span class="stat-val streak-color" id="petStreak">0</span>streak</div>
            </div>
            <div class="pet-room" id="petRoom">
                <div class="pet-roof" id="petRoof"></div>

                <!-- Background elements (clouds, stars, moon) -->
                <div class="bg-cloud" style="width:32px;height:14px;top:10px;left:-18px;animation-duration:16s;"></div>
                <div class="bg-cloud" style="width:24px;height:10px;top:24px;left:-10px;animation-duration:22s;animation-delay:5s;"></div>
                <div class="bg-cloud" style="width:28px;height:12px;top:6px;left:-24px;animation-duration:19s;animation-delay:10s;"></div>
                <div class="bg-cloud" style="width:20px;height:8px;top:34px;left:-12px;animation-duration:25s;animation-delay:2s;"></div>

                <div class="bg-star" style="top:8px;left:15%;animation-duration:2.2s;animation-delay:0s;"></div>
                <div class="bg-star" style="top:18px;left:75%;animation-duration:1.8s;animation-delay:0.8s;"></div>
                <div class="bg-star" style="top:32px;left:40%;animation-duration:2.5s;animation-delay:1.4s;"></div>
                <div class="bg-star" style="top:12px;left:55%;animation-duration:2.0s;animation-delay:0.3s;"></div>
                <div class="bg-star" style="top:38px;left:20%;animation-duration:2.8s;animation-delay:1.0s;"></div>
                <div class="bg-star" style="top:6px;left:85%;animation-duration:2.3s;animation-delay:1.8s;"></div>
                <div class="bg-star" style="top:26px;left:10%;animation-duration:1.9s;animation-delay:0.5s;"></div>
                <div class="bg-star" style="top:15px;left:65%;animation-duration:2.6s;animation-delay:2.0s;"></div>

                <svg class="bg-moon" width="16" height="16" viewBox="0 0 18 18">
                    <circle cx="9" cy="9" r="7" fill="#ffeaa7" />
                    <circle cx="12" cy="7" r="6" fill="#0c1445" />
                </svg>

                <!-- Sparkles for master stage -->
                <div class="sparkle" style="top:30%;left:20%;animation-delay:0s;"></div>
                <div class="sparkle" style="top:25%;left:75%;animation-delay:0.8s;"></div>
                <div class="sparkle" style="top:50%;left:15%;animation-delay:1.6s;"></div>
                <div class="sparkle" style="top:45%;left:80%;animation-delay:0.4s;"></div>

                <div class="deco deco-left" id="petDecoLeft"></div>
                <div class="deco deco-right" id="petDecoRight"></div>

                <div class="blob-shadow"></div>

                <div class="floor-overlay" id="floorOverlay"></div>

            <div class="pet-svg-wrap">
                <svg viewBox="0 0 120 140" width="120" height="140" xmlns="http://www.w3.org/2000/svg">
                    <!-- Stage 1: Egg -->
                    <g class="pet-stage stage-egg">
                        <ellipse cx="60" cy="80" rx="28" ry="36" fill="#667eea" />
                        <ellipse cx="60" cy="85" rx="22" ry="28" fill="#8b9ff5" />
                        <!-- Crack -->
                        <polyline points="42,68 48,58 55,66 60,54 66,64 72,56 78,68" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                        <!-- Eyes peeking through crack -->
                        <g class="eyes" style="transform-origin: 60px 62px;">
                            <circle cx="52" cy="62" r="3.5" fill="white" />
                            <circle cx="68" cy="62" r="3.5" fill="white" />
                            <circle cx="53" cy="62" r="2" fill="#333" />
                            <circle cx="69" cy="62" r="2" fill="#333" />
                            <circle cx="54" cy="61" r="0.8" fill="white" />
                            <circle cx="70" cy="61" r="0.8" fill="white" />
                        </g>
                    </g>

                    <!-- Stage 2: Hatchling -->
                    <g class="pet-stage stage-hatchling">
                        <!-- Body -->
                        <ellipse cx="60" cy="90" rx="26" ry="30" fill="#667eea" />
                        <ellipse cx="60" cy="94" rx="20" ry="22" fill="#8b9ff5" />
                        <!-- Eyes -->
                        <g class="eyes" style="transform-origin: 60px 80px;">
                            <circle cx="50" cy="80" r="6" fill="white" />
                            <circle cx="70" cy="80" r="6" fill="white" />
                            <circle cx="52" cy="80" r="3.5" fill="#333" />
                            <circle cx="72" cy="80" r="3.5" fill="#333" />
                            <circle cx="53.5" cy="78.5" r="1.2" fill="white" />
                            <circle cx="73.5" cy="78.5" r="1.2" fill="white" />
                        </g>
                        <!-- Blush -->
                        <ellipse cx="42" cy="88" rx="5" ry="3" fill="rgba(255,150,150,0.4)" />
                        <ellipse cx="78" cy="88" rx="5" ry="3" fill="rgba(255,150,150,0.4)" />
                    </g>

                    <!-- Stage 3: Junior -->
                    <g class="pet-stage stage-junior">
                        <!-- Body -->
                        <ellipse cx="60" cy="88" rx="30" ry="34" fill="#667eea" />
                        <ellipse cx="60" cy="93" rx="23" ry="24" fill="#8b9ff5" />
                        <!-- Arm nubs -->
                        <ellipse cx="32" cy="85" rx="8" ry="5" fill="#667eea" transform="rotate(-20,32,85)" />
                        <ellipse cx="88" cy="85" rx="8" ry="5" fill="#667eea" transform="rotate(20,88,85)" />
                        <!-- Eyes -->
                        <g class="eyes" style="transform-origin: 60px 76px;">
                            <circle cx="48" cy="76" r="7" fill="white" />
                            <circle cx="72" cy="76" r="7" fill="white" />
                            <circle cx="50" cy="76" r="4" fill="#333" />
                            <circle cx="74" cy="76" r="4" fill="#333" />
                            <circle cx="51.5" cy="74.5" r="1.5" fill="white" />
                            <circle cx="75.5" cy="74.5" r="1.5" fill="white" />
                        </g>
                        <!-- Mouth -->
                        <path class="mouth-happy" d="M54,90 Q60,96 66,90" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" />
                        <path class="mouth-sad" d="M54,94 Q60,89 66,94" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" />
                        <!-- Blush -->
                        <ellipse cx="38" cy="86" rx="5" ry="3" fill="rgba(255,150,150,0.35)" />
                        <ellipse cx="82" cy="86" rx="5" ry="3" fill="rgba(255,150,150,0.35)" />
                    </g>

                    <!-- Stage 4: Teen -->
                    <g class="pet-stage stage-teen">
                        <!-- Body -->
                        <ellipse cx="60" cy="85" rx="32" ry="38" fill="#667eea" />
                        <ellipse cx="60" cy="91" rx="24" ry="26" fill="#8b9ff5" />
                        <!-- Arms -->
                        <ellipse cx="28" cy="80" rx="10" ry="6" fill="#667eea" transform="rotate(-15,28,80)" />
                        <ellipse cx="92" cy="80" rx="10" ry="6" fill="#667eea" transform="rotate(15,92,80)" />
                        <!-- Antennae -->
                        <line x1="50" y1="50" x2="42" y2="36" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <circle cx="42" cy="34" r="4" fill="#8b9ff5" />
                        <line x1="70" y1="50" x2="78" y2="36" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <circle cx="78" cy="34" r="4" fill="#8b9ff5" />
                        <!-- Eyes -->
                        <g class="eyes" style="transform-origin: 60px 72px;">
                            <circle cx="47" cy="72" r="8" fill="white" />
                            <circle cx="73" cy="72" r="8" fill="white" />
                            <circle cx="49" cy="72" r="4.5" fill="#333" />
                            <circle cx="75" cy="72" r="4.5" fill="#333" />
                            <circle cx="51" cy="70" r="1.8" fill="white" />
                            <circle cx="77" cy="70" r="1.8" fill="white" />
                        </g>
                        <!-- Smile -->
                        <path class="mouth-happy" d="M50,88 Q60,96 70,88" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <path class="mouth-sad" d="M50,94 Q60,87 70,94" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <!-- Feet nubs -->
                        <ellipse cx="48" cy="120" rx="8" ry="4" fill="#5568d3" />
                        <ellipse cx="72" cy="120" rx="8" ry="4" fill="#5568d3" />
                    </g>

                    <!-- Stage 5: Adult -->
                    <g class="pet-stage stage-adult">
                        <!-- Body -->
                        <ellipse cx="60" cy="82" rx="34" ry="40" fill="#667eea" />
                        <ellipse cx="60" cy="89" rx="26" ry="28" fill="#8b9ff5" />
                        <!-- Arms -->
                        <path d="M26,75 Q18,70 16,78" stroke="#667eea" stroke-width="8" fill="none" stroke-linecap="round" />
                        <path d="M94,75 Q102,70 104,78" stroke="#667eea" stroke-width="8" fill="none" stroke-linecap="round" />
                        <!-- Antennae -->
                        <line x1="48" y1="45" x2="38" y2="28" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <circle cx="38" cy="26" r="5" fill="#ffd93d" />
                        <line x1="72" y1="45" x2="82" y2="28" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <circle cx="82" cy="26" r="5" fill="#ffd93d" />
                        <!-- Eyes -->
                        <g class="eyes" style="transform-origin: 60px 68px;">
                            <circle cx="45" cy="68" r="9" fill="white" />
                            <circle cx="75" cy="68" r="9" fill="white" />
                            <circle cx="48" cy="68" r="5" fill="#333" />
                            <circle cx="78" cy="68" r="5" fill="#333" />
                            <circle cx="50" cy="66" r="2" fill="white" />
                            <circle cx="80" cy="66" r="2" fill="white" />
                        </g>
                        <!-- Happy smile -->
                        <path class="mouth-happy" d="M48,86 Q60,97 72,86" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <path class="mouth-sad" d="M48,94 Q60,85 72,94" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <!-- Feet -->
                        <ellipse cx="46" cy="120" rx="10" ry="5" fill="#5568d3" />
                        <ellipse cx="74" cy="120" rx="10" ry="5" fill="#5568d3" />
                    </g>

                    <!-- Stage 6: Master -->
                    <g class="pet-stage stage-master">
                        <!-- Body -->
                        <ellipse cx="60" cy="82" rx="34" ry="40" fill="#667eea" />
                        <ellipse cx="60" cy="89" rx="26" ry="28" fill="#a0b4ff" />
                        <!-- Arms -->
                        <path d="M26,75 Q16,68 14,78" stroke="#667eea" stroke-width="8" fill="none" stroke-linecap="round" />
                        <path d="M94,75 Q104,68 106,78" stroke="#667eea" stroke-width="8" fill="none" stroke-linecap="round" />
                        <!-- Crown-like antennae -->
                        <line x1="48" y1="45" x2="36" y2="24" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <polygon points="36,24 31,14 36,18 36,10 40,18 41,14 36,24" fill="#ffd93d" />
                        <line x1="72" y1="45" x2="84" y2="24" stroke="#667eea" stroke-width="3" stroke-linecap="round" />
                        <polygon points="84,24 79,14 84,18 84,10 88,18 89,14 84,24" fill="#ffd93d" />
                        <!-- Sparkle star on top -->
                        <polygon points="60,8 62,14 68,14 63,18 65,24 60,20 55,24 57,18 52,14 58,14" fill="#ffd93d" />
                        <!-- Eyes -->
                        <g class="eyes" style="transform-origin: 60px 68px;">
                            <circle cx="45" cy="68" r="9" fill="white" />
                            <circle cx="75" cy="68" r="9" fill="white" />
                            <circle cx="48" cy="68" r="5" fill="#4a5bbf" />
                            <circle cx="78" cy="68" r="5" fill="#4a5bbf" />
                            <circle cx="50" cy="66" r="2" fill="white" />
                            <circle cx="80" cy="66" r="2" fill="white" />
                        </g>
                        <!-- Big smile -->
                        <path class="mouth-happy" d="M46,86 Q60,100 74,86" fill="rgba(255,255,255,0.3)" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <path class="mouth-sad" d="M48,96 Q60,86 72,96" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" />
                        <!-- Feet -->
                        <ellipse cx="46" cy="120" rx="10" ry="5" fill="#5568d3" />
                        <ellipse cx="74" cy="120" rx="10" ry="5" fill="#5568d3" />
                    </g>

                    <!-- === ACCESSORIES === -->

                    <!-- Book (First Steps) - improved with spine + pages -->
                    <g class="acc-group" data-badge="first-steps">
                        <rect x="93" y="86" width="4" height="22" rx="1" fill="#cd7f32" class="acc-main-fill" />
                        <rect x="97" y="86" width="13" height="22" rx="1.5" fill="#cd7f32" opacity="0.85" class="acc-main-fill" />
                        <rect x="96" y="87.5" width="12" height="19" rx="1" fill="#ffeaa7" />
                        <line x1="98" y1="91" x2="106" y2="91" stroke="#cd7f32" stroke-width="0.6" opacity="0.4" class="acc-detail-stroke" />
                        <line x1="98" y1="94" x2="106" y2="94" stroke="#cd7f32" stroke-width="0.6" opacity="0.4" class="acc-detail-stroke" />
                        <line x1="98" y1="97" x2="104" y2="97" stroke="#cd7f32" stroke-width="0.6" opacity="0.4" class="acc-detail-stroke" />
                        <line x1="98" y1="100" x2="105" y2="100" stroke="#cd7f32" stroke-width="0.6" opacity="0.4" class="acc-detail-stroke" />
                    </g>

                    <!-- Graduation Cap (Scholar) -->
                    <g class="acc-group" data-badge="scholar">
                        <polygon points="60,32 35,44 60,52 85,44" fill="#333" class="acc-main-fill" />
                        <rect x="55" y="28" width="10" height="6" rx="1" fill="#333" class="acc-main-fill" />
                        <line x1="82" y1="44" x2="82" y2="56" stroke="#cd7f32" stroke-width="1.5" class="acc-detail-stroke" />
                        <circle cx="82" cy="57" r="2" fill="#cd7f32" class="acc-detail-fill" />
                    </g>

                    <!-- Leaf/Sprout (Biologist) -->
                    <g class="acc-group" data-badge="biologist">
                        <line x1="60" y1="48" x2="60" y2="32" stroke="#27ae60" stroke-width="2.5" class="acc-detail-stroke" />
                        <ellipse cx="54" cy="30" rx="8" ry="5" fill="#27ae60" transform="rotate(-30,54,30)" class="acc-main-fill" />
                        <ellipse cx="67" cy="32" rx="7" ry="4" fill="#2ecc71" transform="rotate(25,67,32)" />
                    </g>

                    <!-- Goggles (Chemist) -->
                    <g class="acc-group" data-badge="chemist">
                        <ellipse cx="46" cy="60" rx="11" ry="9" fill="none" stroke="#cd7f32" stroke-width="2.5" class="acc-main-stroke" />
                        <ellipse cx="74" cy="60" rx="11" ry="9" fill="none" stroke="#cd7f32" stroke-width="2.5" class="acc-main-stroke" />
                        <line x1="57" y1="60" x2="63" y2="60" stroke="#cd7f32" stroke-width="2" class="acc-main-stroke" />
                        <ellipse cx="46" cy="60" rx="9" ry="7" fill="rgba(135,206,250,0.3)" />
                        <ellipse cx="74" cy="60" rx="9" ry="7" fill="rgba(135,206,250,0.3)" />
                    </g>

                    <!-- Lightning Bolt (Physicist) -->
                    <g class="acc-group" data-badge="physicist">
                        <polygon points="64,6 56,20 62,20 54,34 70,18 63,18 70,6" fill="#f39c12" class="acc-main-fill" />
                    </g>

                    <!-- Cape (Well Rounded) -->
                    <g class="acc-group" data-badge="well-rounded">
                        <path d="M36,60 Q30,80 28,110 L60,105 L92,110 Q90,80 84,60" fill="#cd7f32" opacity="0.7" class="acc-main-fill" />
                        <path d="M38,62 Q32,80 30,108 L60,103 L90,108 Q88,80 82,62" fill="#e6c17a" opacity="0.4" />
                    </g>
                </svg>
            </div>
            </div><!-- /pet-room -->
            <div class="pet-stage-name" id="petStageName">Egg</div>
            <div class="pet-label">Study Blob</div>
            <div class="pet-btns">
                <button class="pet-btn" onclick="openStore()">üè™ Store</button>
                <button class="pet-btn feed-btn" id="feedBtn" onclick="openStore('inventory')">üçΩÔ∏è Feed</button>
            </div>
        </div>

        <!-- Study Screen -->
        <div class="study-screen">
            <div class="card">
                <button class="btn back-btn" onclick="backToDecks()">‚Üê Back to Decks</button>
                
                <h2 id="deckTitle" style="text-align: center; color: #667eea; margin-bottom: 20px;"></h2>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="newCount">0</div>
                        <div class="stat-label">New</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="reviewCount">0</div>
                        <div class="stat-label">Review</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="studiedToday">0</div>
                        <div class="stat-label">Studied</div>
                    </div>
                </div>

                <div id="flashcardContainer">
                    <div class="loading">Loading cards...</div>
                </div>
            </div>
        </div>

        <!-- Guide Modal -->
        <div id="guide-screen" class="settings-screen">
            <div class="settings-panel" style="max-width: 560px; max-height: 90vh; overflow-y: auto;">
                <h2>üìñ How It Works</h2>
                <button class="cancel-settings" onclick="closeGuide()" style="position: absolute; top: 20px; right: 20px; width: auto; padding: 10px 20px;">Close</button>
                <div style="margin-top: 20px; font-size: 0.92em; color: #444; line-height: 1.7;">
                    <h3 style="color: #667eea; margin-bottom: 6px;">Spaced Repetition</h3>
                    <p>Cards are shown at increasing intervals based on how well you know them. The better you rate a card, the longer before you see it again &mdash; so you spend more time on what you find hard and less on what you already know.</p>

                    <h3 style="color: #667eea; margin-top: 18px; margin-bottom: 6px;">Studying a Card</h3>
                    <p>Tap a card to reveal the answer, then rate how well you knew it from 1&ndash;4:</p>
                    <ul style="margin: 6px 0 0 20px;">
                        <li><strong>Again (1)</strong> &ndash; Got it wrong, card resets</li>
                        <li><strong>Hard (2)</strong> &ndash; Struggled, shown again soon</li>
                        <li><strong>Good (3)</strong> &ndash; Got it right with some effort</li>
                        <li><strong>Easy (4)</strong> &ndash; Knew it instantly, longer interval</li>
                    </ul>
                    <p style="margin-top: 8px;">Your rating decides when you&rsquo;ll next see the card. Rating Good or Easy pushes the card further into the future; rating Again or Hard brings it back quickly.</p>

                    <details style="margin-top: 10px; cursor: pointer;">
                        <summary style="color: #667eea; font-weight: 600; font-size: 0.95em;">How the spacing algorithm works &rsaquo;</summary>
                        <div style="margin-top: 8px; padding: 12px; background: #f8f9fb; border-radius: 8px; font-size: 0.93em;">
                            <p>This app uses the <strong>SM-2 algorithm</strong>. Each card tracks an <em>interval</em> (days until next review) and an <em>easiness factor</em> that adapts to you.</p>
                            <ul style="margin: 6px 0 0 18px;">
                                <li><strong>Again</strong> or <strong>Hard</strong> &rarr; interval resets to 1 day</li>
                                <li><strong>Good</strong> or <strong>Easy</strong> (first time) &rarr; 1 day</li>
                                <li>Correct a second time &rarr; 6 days</li>
                                <li>After that, interval &times; easiness factor each time (starts at 2.5&times;)</li>
                            </ul>
                            <p style="margin-top: 8px;">Example with consistent Good ratings: 1d &rarr; 6d &rarr; 15d &rarr; 38d &rarr; 95d. Easy makes intervals grow faster; Hard slows them down.</p>
                        </div>
                    </details>

                    <h3 style="color: #667eea; margin-top: 18px; margin-bottom: 6px;">Card Stages</h3>
                    <p style="margin: 6px 0 0;">
                        <span style="color: #95a5a6;">&#9679;</span> <strong>Unseen</strong> &ndash; Not yet studied<br>
                        <span style="color: #ffd93d;">&#9679;</span> <strong>Learning</strong> &ndash; Review interval under 21 days<br>
                        <span style="color: #6bcf7f;">&#9679;</span> <strong>Mastered</strong> &ndash; Review interval 21+ days
                    </p>

                    <h3 style="color: #667eea; margin-top: 18px; margin-bottom: 6px;">Daily Study</h3>
                    <p>Each day you&rsquo;ll see cards due for review plus a batch of new cards (default 5 per deck, adjustable in Settings). Once all due cards are done, you can optionally study 5 more.</p>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-screen" class="settings-screen">
            <div class="settings-panel">
                <h2>‚öôÔ∏è Settings</h2>
                
                <div class="setting-item">
                    <label for="newCardsPerDay">New Cards Per Day (per deck)</label>
                    <input type="number" id="newCardsPerDay" min="1" max="100" value="5">
                    <div class="setting-description">Maximum new cards introduced each day in each deck</div>
                </div>

                <div class="setting-item">
                    <label>Reset All Progress</label>
                    <button class="reset-button" onclick="resetProgress()">‚ö†Ô∏è Reset Everything</button>
                    <div class="setting-description">Warning: This will delete all your study progress permanently</div>
                </div>

                <div class="settings-actions">
                    <button class="save-settings" onclick="saveSettings()">Save Settings</button>
                    <button class="cancel-settings" onclick="closeSettings()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Progress Screen -->
        <div id="progress-screen" class="settings-screen">
            <div class="settings-panel" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <h2>üìä Your Progress</h2>
                <button class="cancel-settings" onclick="closeProgress()" style="position: absolute; top: 20px; right: 20px; width: auto; padding: 10px 20px;">Close</button>
                <div style="margin-top: 40px;">
                    <div id="progressCharts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h3 id="overallChartTitle" style="text-align: center; margin-bottom: 15px;">Overall Progress - All Decks</h3>
                            <canvas id="overallChart" style="max-width: 100%;"></canvas>
                        </div>
                        <div>
                            <h3 style="text-align: center; margin-bottom: 15px;">By Deck (click to filter)</h3>
                            <canvas id="deckChart" style="max-width: 100%;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Users Screen -->
        <div id="users-screen" class="settings-screen">
            <div class="settings-panel" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <h2>üë• All Users</h2>
                <button class="cancel-settings" onclick="closeUsers()" style="position: absolute; top: 20px; right: 20px; width: auto; padding: 10px 20px;">Close</button>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="top-btn" onclick="exportAllData()" style="font-size: 0.8em;">üíæ Export Backup</button>
                    <button class="top-btn" onclick="document.getElementById('restoreFileInput').click()" style="font-size: 0.8em;">üìÇ Restore Backup</button>
                    <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="restoreFromFile(this)">
                </div>
                <div id="usersContent" style="margin-top: 20px;">
                    <div class="loading">Loading users...</div>
                </div>
            </div>
        </div>

        <!-- Store Modal -->
        <div id="store-screen" class="settings-screen">
            <div class="settings-panel" style="max-width: 520px; max-height: 90vh; overflow-y: auto;">
                <h2>üè™ Store</h2>
                <button class="cancel-settings" onclick="closeStore()" style="position: absolute; top: 20px; right: 20px; width: auto; padding: 10px 20px;">Close</button>
                <div class="store-balance" id="storeBalance">0 points</div>
                <div class="store-tabs">
                    <button class="store-tab active" onclick="switchStoreTab('food')">üçé Food</button>
                    <button class="store-tab" onclick="switchStoreTab('house')">üè† House</button>
                    <button class="store-tab" onclick="switchStoreTab('inventory')">üì¶ Inventory</button>
                </div>
                <div class="store-grid" id="storeContent"></div>
            </div>
        </div>
    </div>

    <!-- Libraries for parsing .apkg files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fzstd@0.1.1/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyARP2uokd2lPxXcpPwII3MfK6b_NzSmeO8",
            authDomain: "elevenstudents-76f31.firebaseapp.com",
            projectId: "elevenstudents-76f31",
            storageBucket: "elevenstudents-76f31.firebasestorage.app",
            messagingSenderId: "692298982954",
            appId: "1:692298982954:web:87168356e4206206f8c553",
            measurementId: "G-12TNV8DRZT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUser = null;
        let currentDeck = null;
        let currentCard = null;
        let isFlipped = false;
        let studyQueue = [];
        let userProgress = {};
        let settings = {
            newCardsPerDay: 5,
            lastStudyDate: null,
            newCardsToday: {}  // Track per deck: { deckId: count }
        };
        let petData = {
            streak: 0,
            lastStreakDate: null,
            points: 0,
            totalPoints: 0,
            fedToday: false,
            lastFedDate: null,
            inventory: [],
            equipped: { floor: null, background: null, roof: null, 'deco-left': null, 'deco-right': null }
        };
        let deckCards = {}; // Store all parsed cards by deck
        let deckMetadata = {
            biology: { name: 'IGCSE Biology', file: 'ANKI files/IGCSE__Biology_v2.apkg', cards: [] },
            chemistry: { name: 'IGCSE Chemistry', file: 'ANKI files/IGCSE__Chemistry_v3.apkg', cards: [] },
            physics: { name: 'IGCSE Physics', file: 'ANKI files/IGCSE__Physics_v1.apkg', cards: [] },
            'physics-eqns': { name: 'IGCSE Physics Equations', file: 'ANKI files/IGCSE__Physics-eqns_v1.apkg', cards: [] }
        };
        // Badge definitions - each has 3 levels (bronze/silver/gold)
        const BADGES = {
            'first-steps': {
                name: 'First Steps',
                icon: 'üë£',
                desc: 'cards studied',
                metric: 'studied',
                levels: [10, 50, 200]
            },
            'scholar': {
                name: 'Scholar',
                icon: 'üéì',
                desc: 'cards mastered',
                metric: 'mastered',
                levels: [10, 50, 200]
            },
            'biologist': {
                name: 'Biologist',
                icon: 'üß¨',
                desc: 'Biology mastered',
                metric: 'deck-mastered',
                deck: 'biology',
                levels: [10, 30, 75]
            },
            'chemist': {
                name: 'Chemist',
                icon: 'üß™',
                desc: 'Chemistry mastered',
                metric: 'deck-mastered',
                deck: 'chemistry',
                levels: [10, 30, 75]
            },
            'physicist': {
                name: 'Physicist',
                icon: '‚ö°',
                desc: 'Physics mastered',
                metric: 'deck-mastered',
                deck: 'physics',
                levels: [10, 30, 75]
            },
            'well-rounded': {
                name: 'Well Rounded',
                icon: 'üåü',
                desc: 'decks with mastered cards',
                metric: 'decks-touched',
                levels: [2, 3, 4]
            }
        };

        const LEVEL_NAMES = ['Bronze', 'Silver', 'Gold'];
        const LEVEL_CLASSES = ['badge-bronze', 'badge-silver', 'badge-gold'];

        // Compute badges from progress data (works with any progress object)
        function computeBadges(progressData) {
            const stats = { studied: 0, mastered: 0, deckMastered: {}, decksTouched: 0 };

            Object.keys(deckMetadata).forEach(deckId => {
                let mastered = 0;
                const cards = deckCards[deckId] || [];
                cards.forEach(card => {
                    const cardKey = `${deckId}_${card.id}`;
                    const p = progressData[cardKey];
                    if (!p || p.repetitions === 0) return;
                    stats.studied++;
                    if (p.interval >= 21) {
                        mastered++;
                        stats.mastered++;
                    }
                });
                stats.deckMastered[deckId] = mastered;
                if (mastered > 0) stats.decksTouched++;
            });

            const earned = [];
            Object.entries(BADGES).forEach(([id, badge]) => {
                let value;
                if (badge.metric === 'studied') value = stats.studied;
                else if (badge.metric === 'mastered') value = stats.mastered;
                else if (badge.metric === 'deck-mastered') value = stats.deckMastered[badge.deck] || 0;
                else if (badge.metric === 'decks-touched') value = stats.decksTouched;
                else return;

                let level = 0;
                badge.levels.forEach((threshold, i) => {
                    if (value >= threshold) level = i + 1;
                });

                if (level > 0) {
                    earned.push({ id, ...badge, level, threshold: badge.levels[level - 1], value });
                }
            });

            return { badges: earned, stats };
        }

        // Render badges into an element
        function renderBadges(badges, container, mini = false) {
            if (!container) return;
            if (badges.length === 0) {
                container.innerHTML = '';
                return;
            }
            container.innerHTML = badges.map(b => {
                const cls = mini ? 'mini-badge' : 'badge-chip';
                const levelCls = LEVEL_CLASSES[b.level - 1];
                if (mini) {
                    return `<span class="${cls} ${levelCls}">${b.icon}</span>`;
                }
                return `<span class="${cls} ${levelCls}">
                    <span class="badge-icon">${b.icon}</span>
                    ${b.name}
                    <span class="badge-tooltip">${LEVEL_NAMES[b.level - 1]} ‚Äî ${b.value}/${b.threshold} ${b.desc}</span>
                </span>`;
            }).join('');
        }

        // Update badge display on deck selector
        function updateBadgeDisplay() {
            const { badges } = computeBadges(userProgress);
            renderBadges(badges, document.getElementById('badgesRow'));
            updatePet(badges);
            updatePetHouseUI();
        }

        // Pet evolution stages
        const PET_STAGES = [
            { key: 'egg', name: 'Egg', minLevels: 0 },
            { key: 'hatchling', name: 'Hatchling', minLevels: 1 },
            { key: 'junior', name: 'Junior', minLevels: 4 },
            { key: 'teen', name: 'Teen', minLevels: 8 },
            { key: 'adult', name: 'Adult', minLevels: 12 },
            { key: 'master', name: 'Master', minLevels: 16 },
        ];

        // Accessory tier colors
        const TIER_FILLS = {
            1: { main: '#cd7f32', detail: '#cd7f32' },  // Bronze
            2: { main: '#a0a0a0', detail: '#808080' },  // Silver
            3: { main: '#daa520', detail: '#b8860b' },   // Gold
        };

        function updatePet(badges) {
            const petHouse = document.getElementById('petHouse');
            if (!petHouse) return;

            // Calculate total badge levels
            const totalLevels = badges.reduce((sum, b) => sum + b.level, 0);

            // Determine evolution stage
            let currentStage = PET_STAGES[0];
            for (const stage of PET_STAGES) {
                if (totalLevels >= stage.minLevels) currentStage = stage;
            }

            // Show correct stage, hide others
            petHouse.querySelectorAll('.pet-stage').forEach(el => el.classList.remove('active'));
            const stageEl = petHouse.querySelector(`.stage-${currentStage.key}`);
            if (stageEl) stageEl.classList.add('active');

            // Update stage name
            const nameEl = document.getElementById('petStageName');
            if (nameEl) nameEl.textContent = currentStage.name;

            // Toggle sparkles for master stage
            const petRoom = document.getElementById('petRoom');
            if (petRoom) petRoom.classList.toggle('show-sparkles', currentStage.key === 'master');

            // Update accessories
            petHouse.querySelectorAll('.acc-group').forEach(el => {
                const badgeId = el.getAttribute('data-badge');
                const badge = badges.find(b => b.id === badgeId);

                if (badge) {
                    el.classList.add('active');
                    el.classList.remove('tier-bronze', 'tier-silver', 'tier-gold');
                    el.classList.add(['', 'tier-bronze', 'tier-silver', 'tier-gold'][badge.level]);

                    // Update fill colors based on tier
                    const tierColor = TIER_FILLS[badge.level];
                    el.querySelectorAll('.acc-main-fill').forEach(f => f.setAttribute('fill', tierColor.main));
                    el.querySelectorAll('.acc-main-stroke').forEach(f => f.setAttribute('stroke', tierColor.main));
                    el.querySelectorAll('.acc-detail-fill').forEach(f => f.setAttribute('fill', tierColor.detail));
                    el.querySelectorAll('.acc-detail-stroke').forEach(f => f.setAttribute('stroke', tierColor.detail));
                } else {
                    el.classList.remove('active', 'tier-bronze', 'tier-silver', 'tier-gold');
                }
            });
        }

        // SM-2 Algorithm implementation
        class SM2 {
            static calculate(quality, repetitions, easiness, interval) {
                if (quality < 1 || quality > 4) quality = 1;
                
                let newEasiness = easiness + (0.1 - (4 - quality) * (0.08 + (4 - quality) * 0.02));
                if (newEasiness < 1.3) newEasiness = 1.3;

                let newRepetitions = repetitions;
                let newInterval = interval;

                if (quality < 3) {
                    // Failed recall
                    newRepetitions = 0;
                    newInterval = 1;
                } else {
                    newRepetitions++;
                    if (newRepetitions === 1) {
                        newInterval = 1;
                    } else if (newRepetitions === 2) {
                        newInterval = 6;
                    } else {
                        newInterval = Math.round(interval * newEasiness);
                    }
                }

                return {
                    easiness: newEasiness,
                    repetitions: newRepetitions,
                    interval: newInterval,
                    nextReview: Date.now() + (newInterval * 24 * 60 * 60 * 1000)
                };
            }
        }

        // Login with Google
        window.loginWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                currentUser = result.user;
                await initializeUser();
                showScreen('deck-selector');
                loadDecks();
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        };

        // Initialize user in Firestore
        async function initializeUser() {
            const userRef = doc(db, 'users', currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (!userDoc.exists()) {
                await setDoc(userRef, {
                    email: currentUser.email,
                    displayName: currentUser.displayName,
                    createdAt: Date.now(),
                    progress: {},
                    settings: {
                        newCardsPerDay: 5,
                        lastStudyDate: null,
                        newCardsToday: {}
                    },
                    petData: petData
                });
            }
            
            const userData = userDoc.data();
            userProgress = userData?.progress || {};
            settings = userData?.settings || {
                newCardsPerDay: 5,
                lastStudyDate: null,
                newCardsToday: {}
            };

            // Ensure newCardsToday is an object
            if (typeof settings.newCardsToday !== 'object' || settings.newCardsToday === null) {
                settings.newCardsToday = {};
            }

            // Load pet data
            const savedPet = userData?.petData;
            if (savedPet) {
                petData = { ...petData, ...savedPet };
                if (!petData.equipped) petData.equipped = { floor: null, background: null, roof: null, 'deco-left': null, 'deco-right': null };
                if (!Array.isArray(petData.inventory)) petData.inventory = [];
            }

            // Reset daily counters if new day
            const today = new Date().toDateString();
            if (settings.lastStudyDate !== today) {
                settings.lastStudyDate = today;
                settings.newCardsToday = {};
            }
            if (petData.lastFedDate !== today) {
                petData.fedToday = false;
            }
        }

        // Show specific screen
        function showScreen(screenName) {
            document.querySelectorAll('.login-screen, .deck-selector, .study-screen').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.${screenName}`).classList.add('active');

            if (screenName === 'deck-selector' && currentUser) {
                document.getElementById('userInfo').textContent = `Signed in as ${currentUser.email}`;
            }

            // Show pet house only on deck selector
            const petHouse = document.getElementById('petHouse');
            if (petHouse) {
                petHouse.classList.toggle('visible', screenName === 'deck-selector');
            }
        }

        // Calculate card categories
        function categorizeCard(cardKey) {
            const progress = userProgress[cardKey];
            
            if (!progress || progress.repetitions === 0) {
                return 'unseen';
            } else if (progress.interval < 21) {
                return 'learning';
            } else {
                return 'mastered';
            }
        }

        // Get deck statistics
        function getDeckStats(deckId) {
            const cards = deckCards[deckId] || [];
            let unseen = 0, learning = 0, mastered = 0;

            cards.forEach(card => {
                const cardKey = `${deckId}_${card.id}`;
                const category = categorizeCard(cardKey);
                if (category === 'unseen') unseen++;
                else if (category === 'learning') learning++;
                else mastered++;
            });

            return { unseen, learning, mastered, total: cards.length };
        }

        // Get count of cards due for study today
        function getDueCount(deckId) {
            const cards = deckCards[deckId] || [];
            const now = Date.now();
            const deckNewCardsToday = (settings.newCardsToday && settings.newCardsToday[deckId]) || 0;
            let newCardsCount = 0;
            let dueCount = 0;

            cards.forEach(card => {
                const cardKey = `${deckId}_${card.id}`;
                const progress = userProgress[cardKey];

                if (progress && progress.nextReview > now) return;

                const category = categorizeCard(cardKey);
                if (category !== 'unseen') {
                    dueCount++;
                } else if (deckNewCardsToday + newCardsCount < settings.newCardsPerDay) {
                    newCardsCount++;
                    dueCount++;
                }
            });

            return dueCount;
        }

        // Strip HTML tags from Anki cards
        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Process HTML with images pointing to media folder
        function processHtmlWithImages(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            
            // Find all img tags and update src to point to media folder
            const images = tmp.querySelectorAll('img');
            images.forEach(img => {
                const src = img.getAttribute('src');
                // If it's a local file reference (not http/https), prepend media/
                if (src && !src.startsWith('http://') && !src.startsWith('https://')) {
                    img.src = 'media/' + src;
                }
            });
            
            return tmp.innerHTML;
        }

        // Parse .apkg file - ONLY SOURCE OF CARDS
        async function parseApkgFile(filePath) {
            console.log(`[APKG] Attempting to load: ${filePath}`);
            try {
                const response = await fetch(encodeURI(filePath));
                console.log(`[APKG] Fetch response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const blob = await response.blob();
                console.log(`[APKG] Blob size: ${blob.size} bytes`);
                
                if (!window.JSZip) {
                    throw new Error('JSZip library not loaded');
                }
                
                const zip = await window.JSZip.loadAsync(blob);
                console.log(`[APKG] ZIP loaded, files: ${Object.keys(zip.files).join(', ')}`);
                
                // Try different database file names in order of preference
                let dbFile = zip.file('collection.anki21b') ||
                             zip.file('collection.anki21') || 
                             zip.file('collection.anki2');
                
                if (!dbFile) {
                    console.error('[APKG] Available files in ZIP:', Object.keys(zip.files));
                    throw new Error('No collection.anki* found in archive');
                }
                
                console.log(`[APKG] Found database: ${dbFile.name}`);
                let dbData = await dbFile.async('uint8array');
                console.log(`[APKG] Database size: ${dbData.length} bytes`);
                
                // Check if it's zstd compressed and decompress if needed
                if (dbData[0] === 0x28 && dbData[1] === 0xb5 && dbData[2] === 0x2f && dbData[3] === 0xfd) {
                    console.log('[APKG] Database is zstd compressed, decompressing...');
                    const decompressed = fzstd.decompress(dbData);
                    dbData = new Uint8Array(decompressed);
                    console.log(`[APKG] Decompressed database size: ${dbData.length} bytes`);
                }
                
                // Initialize SQL.js
                if (!window.initSqlJs) {
                    throw new Error('SQL.js library not loaded');
                }
                
                const SQL = await window.initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                const db = new SQL.Database(dbData);
                console.log('[APKG] SQLite database opened');
                
                // Get all cards
                const result = db.exec(`
                    SELECT notes.flds, cards.id
                    FROM cards
                    JOIN notes ON cards.nid = notes.id
                `);
                
                if (!result.length) {
                    console.error('[APKG] No results from query');
                    db.close();
                    return [];
                }
                
                console.log(`[APKG] Query returned ${result[0].values.length} cards`);
                
                const cards = [];
                result[0].values.forEach((row) => {
                    const fields = row[0].split('\x1f'); // Anki uses \x1f as field separator
                    const cardId = row[1];
                    
                    // Process HTML to point images to media folder
                    const front = processHtmlWithImages(fields[0]);
                    const back = processHtmlWithImages(fields[1]);
                    
                    cards.push({
                        id: cardId,
                        front: front,
                        back: back
                    });
                });
                
                db.close();
                console.log(`[APKG] Successfully extracted ${cards.length} cards`);
                return cards;
            } catch (error) {
                console.error(`[APKG] ERROR parsing ${filePath}:`, error);
                console.error('[APKG] Error details:', error.message, error.stack);
                return [];
            }
        }
        
        // Parse all deck files from .apkg ONLY
        async function parseAllDecks() {
            console.log('[DECKS] Starting to parse all .apkg files...');
            const promises = Object.keys(deckMetadata).map(async (deckId) => {
                const deck = deckMetadata[deckId];
                console.log(`[DECKS] Loading ${deckId} from ${deck.file}`);
                const cards = await parseApkgFile(deck.file);
                deckCards[deckId] = cards || [];
                deck.cardCount = deckCards[deckId].length;
                console.log(`[DECKS] ${deckId}: ${deck.cardCount} cards loaded`);
            });
            await Promise.all(promises);
            console.log('[DECKS] All decks parsed');
        }

        // Load available decks
        async function loadDecks() {
            const deckList = document.getElementById('deckList');
            
            // Parse all .apkg files
            try {
                await parseAllDecks();
            } catch (e) {
                console.error('[DECKS] Critical error during parsing:', e);
                alert('Failed to load flashcard decks. Check browser console for details.');
            }
            
            const decks = Object.keys(deckMetadata).map(id => ({
                id,
                name: deckMetadata[id].name,
                cardCount: deckMetadata[id].cardCount || 0
            }));

            if (decks.every(d => d.cardCount === 0)) {
                console.error('[DECKS] NO CARDS LOADED FROM ANY DECK!');
                deckList.innerHTML = `
                    <div style="padding: 20px; color: #e74c3c; background: #fee; border-radius: 8px; margin: 20px 0;">
                        <h3 style="color: #e74c3c;">‚ö†Ô∏è No Cards Loaded</h3>
                        <p>Unable to load cards from .apkg files. Check the browser console (F12) for error details.</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Common issues:</p>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>Files not found in 'ANKI files/' folder</li>
                            <li>Browser blocking file access</li>
                            <li>Corrupt .apkg files</li>
                        </ul>
                    </div>
                `;
                return;
            }

            const DECK_COLORS = { biology: '#27ae60', chemistry: '#e74c3c', physics: '#f39c12', 'physics-eqns': '#f39c12' };

            deckList.innerHTML = decks.map(deck => {
                const dueCount = getDueCount(deck.id);
                const deckColor = DECK_COLORS[deck.id] || '#667eea';
                const dueHTML = dueCount > 0
                    ? `<div style="font-size: 2.2em; font-weight: bold; color: ${deckColor}; line-height: 1;">${dueCount}</div>
                       <div style="font-size: 0.75em; color: #888;">due today</div>`
                    : `<div style="font-size: 0.85em; color: #95a5a6; line-height: 1.3;">None due</div>
                       <button class="study-more-btn" onclick="event.stopPropagation(); studyFiveMore('${deck.id}');">Study +5 more</button>`;
                return `
                <div class="deck-item deck-${deck.id}" onclick="selectDeck('${deck.id}')">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h3 style="margin: 0;">${deck.name}</h3>
                        <div style="text-align: center;">${dueHTML}</div>
                    </div>
                    <div class="progress-bar-container" id="progressBar_${deck.id}" style="margin-top: 10px;"></div>
                    <div class="progress-legend" id="progressLegend_${deck.id}" style="margin-top: 4px; font-size: 0.75em; color: #888; display: flex; gap: 12px;"></div>
                </div>
            `}).join('');

            // Update stats for each deck
            decks.forEach(deck => {
                updateDeckProgress(deck.id);
            });
            updateTotalDueToday();
            updateBadgeDisplay();
        }

        // Update progress display for a deck
        function updateDeckProgress(deckId) {
            const stats = getDeckStats(deckId);
            const progressBar = document.getElementById(`progressBar_${deckId}`);
            const legend = document.getElementById(`progressLegend_${deckId}`);

            if (!progressBar) return;

            const unseenPct = Math.round((stats.unseen / stats.total) * 100);
            const learningPct = Math.round((stats.learning / stats.total) * 100);
            const masteredPct = 100 - unseenPct - learningPct;

            let barHTML = '';
            if (masteredPct > 0) barHTML += `<div class="progress-segment progress-mastered" style="width: ${masteredPct}%"></div>`;
            if (learningPct > 0) barHTML += `<div class="progress-segment progress-learning" style="width: ${learningPct}%"></div>`;
            if (unseenPct > 0) barHTML += `<div class="progress-segment progress-unseen" style="width: ${unseenPct}%"></div>`;
            progressBar.innerHTML = barHTML;

            if (legend) {
                let legendHTML = '';
                if (masteredPct > 0) legendHTML += `<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#6bcf7f;margin-right:3px;"></span>${masteredPct}% mastered</span>`;
                if (learningPct > 0) legendHTML += `<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ffd93d;margin-right:3px;"></span>${learningPct}% learning</span>`;
                if (unseenPct > 0) legendHTML += `<span><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#95a5a6;margin-right:3px;"></span>${unseenPct}% unseen</span>`;
                legend.innerHTML = legendHTML;
            }
        }

        // Update total due today display
        function updateTotalDueToday() {
            let total = 0;
            Object.keys(deckMetadata).forEach(deckId => {
                total += getDueCount(deckId);
            });
            const el = document.getElementById('totalDueToday');
            const countEl = document.getElementById('totalDueCount');
            const timeEl = document.getElementById('totalDueTime');
            if (el && countEl) {
                countEl.textContent = total;
                el.style.display = 'block';
            }
            if (timeEl) {
                const mins = Math.round(total * 0.5);
                if (mins < 1) {
                    timeEl.textContent = '';
                } else if (mins < 60) {
                    timeEl.textContent = `~${mins} min`;
                } else {
                    const hrs = Math.floor(mins / 60);
                    const rem = mins % 60;
                    timeEl.textContent = rem > 0 ? `~${hrs}h ${rem}m` : `~${hrs}h`;
                }
            }
        }

        // Guide functions
        window.openGuide = function() {
            document.getElementById('guide-screen').style.display = 'flex';
        }
        window.closeGuide = function() {
            document.getElementById('guide-screen').style.display = 'none';
        }

        // Settings functions
        window.openSettings = function() {
            const settingsScreen = document.getElementById('settings-screen');
            const newCardsInput = document.getElementById('newCardsPerDay');
            
            newCardsInput.value = settings.newCardsPerDay;
            settingsScreen.style.display = 'flex';
        }

        window.closeSettings = function() {
            document.getElementById('settings-screen').style.display = 'none';
        }

        let overallChart = null;
        let deckChart = null;
        let selectedDeckId = null;

        function updateOverallChart(data) {
            if (overallChart) {
                overallChart.data.datasets[0].data = [data.unseen, data.learning, data.mastered];
                overallChart.update();
            }
        }

        window.openProgress = function() {
            const progressScreen = document.getElementById('progress-screen');
            progressScreen.style.display = 'flex';
            selectedDeckId = null;
            
            // Destroy old charts if they exist
            if (overallChart) overallChart.destroy();
            if (deckChart) deckChart.destroy();
            
            // Calculate stats
            let unseenTotal = 0, learningTotal = 0, masteredTotal = 0;
            const deckStats = {};
            
            Object.keys(deckMetadata).forEach(deckId => {
                const cards = deckCards[deckId] || [];
                let unseen = 0, learning = 0, mastered = 0;
                
                cards.forEach(card => {
                    const cardKey = `${deckId}_${card.id}`;
                    const category = categorizeCard(cardKey);
                    if (category === 'unseen') unseen++;
                    else if (category === 'learning') learning++;
                    else mastered++;
                });
                
                deckStats[deckId] = { unseen, learning, mastered, total: cards.length };
                unseenTotal += unseen;
                learningTotal += learning;
                masteredTotal += mastered;
            });
            
            // Draw overall progress pie chart
            const ctxOverall = document.getElementById('overallChart').getContext('2d');
            overallChart = new Chart(ctxOverall, {
                type: 'doughnut',
                data: {
                    labels: ['Unseen', 'Learning', 'Mastered'],
                    datasets: [{
                        data: [unseenTotal, learningTotal, masteredTotal],
                        backgroundColor: ['#95a5a6', '#f39c12', '#27ae60'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Draw deck breakdown bar chart
            const deckLabels = [];
            const masteredData = [];
            const learningData = [];
            const unseenData = [];
            
            Object.entries(deckStats).forEach(([deckId, stats]) => {
                const deckName = deckMetadata[deckId].name.split(' ').pop();
                deckLabels.push(deckName);
                masteredData.push(stats.mastered);
                learningData.push(stats.learning);
                unseenData.push(stats.unseen);
            });
            
            const ctxDeck = document.getElementById('deckChart').getContext('2d');
            deckChart = new Chart(ctxDeck, {
                type: 'bar',
                data: {
                    labels: deckLabels,
                    datasets: [
                        {
                            label: 'Mastered',
                            data: masteredData,
                            backgroundColor: '#27ae60'
                        },
                        {
                            label: 'Learning',
                            data: learningData,
                            backgroundColor: '#f39c12'
                        },
                        {
                            label: 'Unseen',
                            data: unseenData,
                            backgroundColor: '#95a5a6'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true
                        }
                    }
                }
            });
            
            // Update chart title
            document.getElementById('overallChartTitle').textContent = 'Overall Progress - All Decks';
        }

        window.selectDeck = function(deckId) {
            selectedDeckId = deckId;
            
            if (deckId === null) {
                // Show all decks
                let unseenTotal = 0, learningTotal = 0, masteredTotal = 0;
                
                Object.keys(deckMetadata).forEach(id => {
                    const cards = deckCards[id] || [];
                    cards.forEach(card => {
                        const cardKey = `${id}_${card.id}`;
                        const category = categorizeCard(cardKey);
                        if (category === 'unseen') unseenTotal++;
                        else if (category === 'learning') learningTotal++;
                        else masteredTotal++;
                    });
                });
                
                updateOverallChart({ unseen: unseenTotal, learning: learningTotal, mastered: masteredTotal });
                document.getElementById('overallChartTitle').textContent = 'Overall Progress - All Decks';
            } else {
                // Show only selected deck
                const cards = deckCards[deckId] || [];
                let unseen = 0, learning = 0, mastered = 0;
                
                cards.forEach(card => {
                    const cardKey = `${deckId}_${card.id}`;
                    const category = categorizeCard(cardKey);
                    if (category === 'unseen') unseen++;
                    else if (category === 'learning') learning++;
                    else mastered++;
                });
                
                updateOverallChart({ unseen, learning, mastered });
                const deckName = deckMetadata[deckId].name;
                document.getElementById('overallChartTitle').textContent = `Overall Progress - ${deckName}`;
            }
        }

        window.closeProgress = function() {
            document.getElementById('progress-screen').style.display = 'none';
            if (overallChart) overallChart.destroy();
            if (deckChart) deckChart.destroy();
        }

        // Users page
        window.openUsers = async function() {
            const screen = document.getElementById('users-screen');
            const content = document.getElementById('usersContent');
            screen.style.display = 'flex';
            content.innerHTML = '<div class="loading">Loading users...</div>';

            try {
                const usersSnap = await getDocs(collection(db, 'users'));
                const users = [];

                usersSnap.forEach(docSnap => {
                    const data = docSnap.data();
                    const progress = data.progress || {};

                    // Compute stats from progress data
                    let totalStudied = 0, totalMastered = 0, totalLearning = 0;
                    const deckBreakdown = {};

                    Object.keys(deckMetadata).forEach(deckId => {
                        let mastered = 0, learning = 0;
                        const cards = deckCards[deckId] || [];
                        cards.forEach(card => {
                            const cardKey = `${deckId}_${card.id}`;
                            const p = progress[cardKey];
                            if (!p || p.repetitions === 0) return;
                            if (p.interval >= 21) mastered++;
                            else learning++;
                        });
                        deckBreakdown[deckId] = { learning, mastered };
                        totalLearning += learning;
                        totalMastered += mastered;
                    });

                    totalStudied = totalLearning + totalMastered;

                    // Compute badges for this user
                    const { badges } = computeBadges(progress);

                    users.push({
                        name: data.displayName || data.email || 'Unknown',
                        email: data.email || '',
                        totalStudied,
                        totalLearning,
                        totalMastered,
                        deckBreakdown,
                        badges
                    });
                });

                // Sort by most studied
                users.sort((a, b) => b.totalStudied - a.totalStudied);

                if (users.length === 0) {
                    content.innerHTML = '<p style="color: #888; text-align: center;">No users found.</p>';
                    return;
                }

                let html = `<table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Studied</th>
                            <th>Learning</th>
                            <th>Mastered</th>
                            <th>Badges</th>
                        </tr>
                    </thead>
                    <tbody>`;

                users.forEach(u => {
                    const badgesHTML = u.badges.map(b =>
                        `<span class="mini-badge ${LEVEL_CLASSES[b.level - 1]}">${b.icon}</span>`
                    ).join('') || '<span style="color:#ccc;">‚Äî</span>';

                    html += `<tr>
                        <td>
                            <div style="font-weight: 600;">${u.name}</div>
                            <div style="font-size: 0.8em; color: #aaa;">${u.email}</div>
                        </td>
                        <td>${u.totalStudied}</td>
                        <td>${u.totalLearning}</td>
                        <td>${u.totalMastered}</td>
                        <td><div class="user-badges-cell">${badgesHTML}</div></td>
                    </tr>`;
                });

                html += '</tbody></table>';
                content.innerHTML = html;

            } catch (error) {
                console.error('Error loading users:', error);
                content.innerHTML = `<p style="color: #e74c3c; text-align: center;">Could not load users. You may need to update Firestore rules to allow reading all user profiles.</p>`;
            }
        }

        window.closeUsers = function() {
            document.getElementById('users-screen').style.display = 'none';
        }

        // === STORE, FEEDING & HOUSE SYSTEM ===

        const STORE_ITEMS = {
            // Food (consumable)
            'apple':        { emoji: 'üçé', name: 'Apple',        cost: 2,  type: 'food' },
            'banana':       { emoji: 'üçå', name: 'Banana',       cost: 3,  type: 'food' },
            'cookie':       { emoji: 'üç™', name: 'Cookie',       cost: 4,  type: 'food' },
            'ice-cream':    { emoji: 'üç¶', name: 'Ice Cream',    cost: 5,  type: 'food' },
            'pizza':        { emoji: 'üçï', name: 'Pizza',        cost: 6,  type: 'food' },
            'cake':         { emoji: 'üéÇ', name: 'Cake',         cost: 8,  type: 'food' },
            'sushi':        { emoji: 'üç£', name: 'Sushi',        cost: 10, type: 'food' },
            'golden-apple': { emoji: '‚ú®',  name: 'Golden Feast', cost: 20, type: 'food' },
            // House items (permanent, one per slot)
            'grass-floor':  { emoji: 'üå±', name: 'Grass',          cost: 5,  type: 'house', slot: 'floor' },
            'wood-floor':   { emoji: 'ü™µ', name: 'Wood Floor',     cost: 10, type: 'house', slot: 'floor' },
            'cloud-bg':     { emoji: '‚òÅÔ∏è',  name: 'Clouds',         cost: 8,  type: 'house', slot: 'background' },
            'stars-bg':     { emoji: '‚≠ê', name: 'Stars',          cost: 12, type: 'house', slot: 'background' },
            'night-bg':     { emoji: 'üåô', name: 'Night Sky',      cost: 18, type: 'house', slot: 'background' },
            'plant-l':      { emoji: 'ü™¥', name: 'Potted Plant',   cost: 8,  type: 'house', slot: 'deco-left' },
            'frame-l':      { emoji: 'üñºÔ∏è',  name: 'Picture Frame',  cost: 6,  type: 'house', slot: 'deco-left' },
            'books-r':      { emoji: 'üìö', name: 'Bookshelf',      cost: 12, type: 'house', slot: 'deco-right' },
            'lamp-r':       { emoji: 'üí°', name: 'Lamp',           cost: 10, type: 'house', slot: 'deco-right' },
            'basic-roof':   { emoji: 'üè†', name: 'Basic Roof',     cost: 10, type: 'house', slot: 'roof' },
            'tile-roof':    { emoji: 'üèõÔ∏è',  name: 'Tiled Roof',     cost: 20, type: 'house', slot: 'roof' },
            'royal-roof':   { emoji: 'üëë', name: 'Royal Roof',     cost: 35, type: 'house', slot: 'roof' },
        };

        // SVG Decoration Templates
        const DECOR_SVG = {
            // Roofs
            'basic-roof': `<svg viewBox="0 0 200 28" preserveAspectRatio="none">
                <polygon points="100,2 195,26 5,26" fill="#8B6C4A" stroke="#6B4C2A" stroke-width="1.5"/>
                <line x1="52" y1="14" x2="148" y2="14" stroke="#6B4C2A" stroke-width="0.7" opacity="0.5"/>
                <line x1="30" y1="20" x2="170" y2="20" stroke="#6B4C2A" stroke-width="0.7" opacity="0.5"/>
                <polygon points="100,2 103,2 103,0 100,0" fill="#6B4C2A"/>
            </svg>`,
            'tile-roof': `<svg viewBox="0 0 200 28" preserveAspectRatio="none">
                <path d="M5,26 Q100,-2 195,26" fill="#C75B39" stroke="#a04828" stroke-width="1"/>
                <path d="M25,23 Q48,16 71,23" fill="none" stroke="#a04828" stroke-width="0.7" opacity="0.5"/>
                <path d="M55,19 Q78,12 101,19" fill="none" stroke="#a04828" stroke-width="0.7" opacity="0.5"/>
                <path d="M85,19 Q108,12 131,19" fill="none" stroke="#a04828" stroke-width="0.7" opacity="0.5"/>
                <path d="M115,23 Q138,16 161,23" fill="none" stroke="#a04828" stroke-width="0.7" opacity="0.5"/>
                <line x1="5" y1="26" x2="195" y2="26" stroke="#a04828" stroke-width="1.3"/>
            </svg>`,
            'royal-roof': `<svg viewBox="0 0 200 32" preserveAspectRatio="none">
                <path d="M5,30 Q40,24 100,4 Q160,24 195,30" fill="#3D2B6B" stroke="#DAA520" stroke-width="1.3"/>
                <path d="M8,29 Q42,23 100,6 Q158,23 192,29" fill="none" stroke="#DAA520" stroke-width="0.5" opacity="0.5"/>
                <line x1="100" y1="4" x2="100" y2="-3" stroke="#DAA520" stroke-width="1.3"/>
                <polygon points="96,-3 100,-8 104,-3" fill="#e74c3c" stroke="#DAA520" stroke-width="0.4"/>
                <circle cx="40" cy="24" r="1.2" fill="#DAA520" opacity="0.6"/>
                <circle cx="70" cy="17" r="1.2" fill="#DAA520" opacity="0.6"/>
                <circle cx="130" cy="17" r="1.2" fill="#DAA520" opacity="0.6"/>
                <circle cx="160" cy="24" r="1.2" fill="#DAA520" opacity="0.6"/>
            </svg>`,

            // Left decorations
            'plant-l': `<svg viewBox="0 0 30 38">
                <path d="M12,36 L12,32 L18,32 L18,36 Z" fill="#c0784a"/>
                <path d="M11,32 L12,24 L18,24 L19,32 Z" fill="#d4915e"/>
                <line x1="15" y1="24" x2="15" y2="12" stroke="#3a7a2a" stroke-width="1.8"/>
                <ellipse cx="10" cy="14" rx="6" ry="4" fill="#3a9a2a" transform="rotate(-30,10,14)"/>
                <ellipse cx="20" cy="15" rx="5" ry="3.5" fill="#2ecc71" transform="rotate(25,20,15)"/>
                <ellipse cx="14" cy="9" rx="5" ry="3.8" fill="#4ab84a" transform="rotate(-15,14,9)"/>
                <path d="M10,14 L15,19" stroke="#2a6a1a" stroke-width="0.4" opacity="0.5"/>
                <path d="M20,15 L15,20" stroke="#2a6a1a" stroke-width="0.4" opacity="0.5"/>
            </svg>`,
            'frame-l': `<svg viewBox="0 0 30 38">
                <rect x="3" y="5" width="24" height="28" rx="1.5" fill="#8B6C4A" />
                <rect x="5" y="7" width="20" height="24" rx="0.8" fill="#a0845a" />
                <rect x="6.5" y="8.5" width="17" height="21" fill="#d4e8f0" />
                <rect x="6.5" y="19" width="17" height="11" fill="#7ab87a" />
                <path d="M6.5,19 Q12,16 17,19 Q22,17 23.5,19" fill="#8ac88a"/>
                <circle cx="18" cy="12" r="2.5" fill="#ffd93d" opacity="0.8"/>
            </svg>`,

            // Right decorations
            'books-r': `<svg viewBox="0 0 30 38">
                <rect x="2" y="32" width="26" height="2.5" rx="0.8" fill="#8B6C4A"/>
                <rect x="3" y="9" width="5" height="23" rx="0.8" fill="#e74c3c"/>
                <rect x="9" y="12" width="4" height="20" rx="0.8" fill="#3498db"/>
                <rect x="14" y="7" width="5" height="25" rx="0.8" fill="#27ae60"/>
                <rect x="20" y="10" width="4" height="22" rx="0.8" fill="#f39c12"/>
                <rect x="25" y="14" width="3" height="18" rx="0.8" fill="#9b59b6"/>
                <line x1="5.5" y1="11" x2="5.5" y2="15" stroke="white" stroke-width="0.5" opacity="0.5"/>
                <line x1="16.5" y1="9" x2="16.5" y2="13" stroke="white" stroke-width="0.5" opacity="0.5"/>
            </svg>`,
            'lamp-r': `<svg viewBox="0 0 30 38">
                <defs>
                    <radialGradient id="lampGlow"><stop offset="0%" stop-color="#ffd93d" stop-opacity="0.4"/><stop offset="100%" stop-color="#ffd93d" stop-opacity="0"/></radialGradient>
                </defs>
                <circle cx="18" cy="12" r="12" fill="url(#lampGlow)"/>
                <rect x="12" y="33" width="10" height="3.5" rx="1.5" fill="#666"/>
                <line x1="17" y1="33" x2="17" y2="24" stroke="#666" stroke-width="2.2" stroke-linecap="round"/>
                <line x1="17" y1="24" x2="20" y2="14" stroke="#666" stroke-width="2.2" stroke-linecap="round"/>
                <path d="M14,14 L26,14 L23,7 L17,7 Z" fill="#555"/>
                <path d="M17,7 L23,7" stroke="#ffd93d" stroke-width="0.8" opacity="0.7"/>
                <ellipse cx="20" cy="14" rx="6" ry="1.2" fill="#ffd93d" opacity="0.3"/>
            </svg>`,

            // Floor overlays
            'grass-floor': `<svg viewBox="0 0 180 24" preserveAspectRatio="none">
                <path d="M9,24 L10.5,14 L12,24" fill="#3a8a2a"/>
                <path d="M22,24 L23.5,17 L25,24" fill="#4a9a3a"/>
                <path d="M36,24 L38,12 L40,24" fill="#2a7a1a"/>
                <path d="M52,24 L53.5,15 L55,24" fill="#4aaa3a"/>
                <path d="M68,24 L69.5,10 L71,24" fill="#3a9a2a"/>
                <path d="M82,24 L83.5,17 L85,24" fill="#2a8a1a"/>
                <path d="M98,24 L100,13 L102,24" fill="#4a9a3a"/>
                <path d="M115,24 L116.5,15 L118,24" fill="#3a7a2a"/>
                <path d="M130,24 L132,11 L134,24" fill="#5aaa4a"/>
                <path d="M145,24 L146.5,17 L148,24" fill="#3a9a2a"/>
                <path d="M160,24 L162,14 L164,24" fill="#2a8a1a"/>
                <path d="M45,24 L46,19 L47,24" fill="#5aaa4a" opacity="0.7"/>
                <path d="M92,24 L93,20 L94,24" fill="#5aaa4a" opacity="0.7"/>
                <path d="M138,24 L139,19 L140,24" fill="#3a9a3a" opacity="0.7"/>
            </svg>`,
            'wood-floor': `<svg viewBox="0 0 180 24" preserveAspectRatio="none">
                <line x1="0" y1="7" x2="180" y2="7" stroke="#9a6b3a" stroke-width="0.7" opacity="0.4"/>
                <line x1="0" y1="15" x2="180" y2="15" stroke="#9a6b3a" stroke-width="0.7" opacity="0.4"/>
                <line x1="0" y1="22" x2="180" y2="22" stroke="#9a6b3a" stroke-width="0.7" opacity="0.3"/>
                <line x1="40" y1="0" x2="40" y2="7" stroke="#9a6b3a" stroke-width="0.4" opacity="0.3"/>
                <line x1="105" y1="7" x2="105" y2="15" stroke="#9a6b3a" stroke-width="0.4" opacity="0.3"/>
                <line x1="70" y1="15" x2="70" y2="22" stroke="#9a6b3a" stroke-width="0.4" opacity="0.3"/>
                <line x1="140" y1="0" x2="140" y2="7" stroke="#9a6b3a" stroke-width="0.4" opacity="0.3"/>
                <circle cx="78" cy="10" r="2.5" fill="none" stroke="#9a6b3a" stroke-width="0.4" opacity="0.3"/>
                <circle cx="78" cy="10" r="1.2" fill="none" stroke="#9a6b3a" stroke-width="0.3" opacity="0.3"/>
            </svg>`,
        };

        let currentStoreTab = 'food';

        window.openStore = function(tab) {
            currentStoreTab = tab || 'food';
            document.getElementById('store-screen').style.display = 'flex';
            renderStore();
        }

        window.closeStore = function() {
            document.getElementById('store-screen').style.display = 'none';
        }

        window.switchStoreTab = function(tab) {
            currentStoreTab = tab;
            renderStore();
        }

        function renderStore() {
            const content = document.getElementById('storeContent');
            const balance = document.getElementById('storeBalance');
            balance.textContent = `${petData.points} points`;

            // Update tab active state
            document.querySelectorAll('.store-tab').forEach((t, i) => {
                const tabs = ['food', 'house', 'inventory'];
                t.classList.toggle('active', tabs[i] === currentStoreTab);
            });

            if (currentStoreTab === 'inventory') {
                renderInventory(content);
                return;
            }

            const items = Object.entries(STORE_ITEMS).filter(([, item]) => item.type === currentStoreTab);
            content.innerHTML = items.map(([id, item]) => {
                const owned = item.type === 'house' && petData.inventory.includes(id);
                const canAfford = petData.points >= item.cost;
                const equipped = item.slot && petData.equipped[item.slot] === id;

                let btnHTML;
                if (owned) {
                    btnHTML = `<button class="equip-btn ${equipped ? 'equipped' : ''}" onclick="event.stopPropagation(); toggleEquip('${id}')">${equipped ? 'Equipped' : 'Equip'}</button>`;
                } else {
                    btnHTML = `<button class="buy-btn" ${!canAfford ? 'disabled' : ''} onclick="event.stopPropagation(); buyItem('${id}')">Buy ¬∑ ${item.cost}pts</button>`;
                }

                return `<div class="store-item">
                    <div class="item-emoji">${item.emoji}</div>
                    <div class="item-name">${item.name}</div>
                    ${item.slot ? `<div style="font-size:0.65em;color:#aaa;">${item.slot}</div>` : ''}
                    ${btnHTML}
                </div>`;
            }).join('');
        }

        function renderInventory(content) {
            // Count food items
            const foodCounts = {};
            petData.inventory.forEach(id => {
                if (STORE_ITEMS[id] && STORE_ITEMS[id].type === 'food') {
                    foodCounts[id] = (foodCounts[id] || 0) + 1;
                }
            });

            // Get owned house items
            const houseItems = [...new Set(petData.inventory.filter(id => STORE_ITEMS[id] && STORE_ITEMS[id].type === 'house'))];

            const foodHTML = Object.entries(foodCounts).map(([id, count]) => {
                const item = STORE_ITEMS[id];
                const canFeed = !petData.fedToday;
                return `<div class="store-item">
                    <div class="item-emoji">${item.emoji}</div>
                    <div class="item-name">${item.name} <span class="inv-food-count">√ó${count}</span></div>
                    <button class="buy-btn" ${!canFeed ? 'disabled' : ''} onclick="event.stopPropagation(); feedBlob('${id}')">${canFeed ? 'üçΩÔ∏è Feed' : '‚úì Fed'}</button>
                </div>`;
            }).join('');

            const houseHTML = houseItems.map(id => {
                const item = STORE_ITEMS[id];
                const equipped = petData.equipped[item.slot] === id;
                return `<div class="store-item">
                    <div class="item-emoji">${item.emoji}</div>
                    <div class="item-name">${item.name}</div>
                    <div style="font-size:0.65em;color:#aaa;">${item.slot}</div>
                    <button class="equip-btn ${equipped ? 'equipped' : ''}" onclick="event.stopPropagation(); toggleEquip('${id}')">${equipped ? 'Equipped' : 'Equip'}</button>
                </div>`;
            }).join('');

            if (!foodHTML && !houseHTML) {
                content.innerHTML = '<p style="color:#aaa; text-align:center; grid-column:1/-1; padding:20px;">No items yet. Buy some from the store!</p>';
                return;
            }

            content.innerHTML = foodHTML + houseHTML;
        }

        window.buyItem = async function(itemId) {
            const item = STORE_ITEMS[itemId];
            if (!item || petData.points < item.cost) return;

            // House items can only be bought once
            if (item.type === 'house' && petData.inventory.includes(itemId)) return;

            petData.points -= item.cost;
            petData.inventory.push(itemId);

            await savePetData();
            renderStore();
            updatePetHouseUI();
        }

        window.toggleEquip = async function(itemId) {
            const item = STORE_ITEMS[itemId];
            if (!item || !item.slot) return;

            if (petData.equipped[item.slot] === itemId) {
                petData.equipped[item.slot] = null;
            } else {
                petData.equipped[item.slot] = itemId;
            }

            await savePetData();
            renderStore();
            renderHouseDecor();
        }

        window.feedBlob = async function(itemId) {
            if (petData.fedToday) return;
            const idx = petData.inventory.indexOf(itemId);
            if (idx === -1) return;

            const item = STORE_ITEMS[itemId];

            // Consume food
            petData.inventory.splice(idx, 1);
            petData.fedToday = true;
            petData.lastFedDate = new Date().toDateString();

            // Play feed animation
            const petHouse = document.getElementById('petHouse');
            petHouse.classList.remove('blob-hungry');
            const feedBtn = document.getElementById('feedBtn');
            if (feedBtn) { feedBtn.classList.add('fed'); feedBtn.textContent = '‚úì Fed'; }

            // Float emoji
            const floater = document.createElement('div');
            floater.className = 'feed-float';
            floater.textContent = item.emoji;
            floater.style.left = '50%';
            floater.style.top = '40%';
            petHouse.appendChild(floater);
            setTimeout(() => floater.remove(), 1000);

            await savePetData();
            renderStore();
        }

        async function savePetData() {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { 'petData': petData });
        }

        // Update pet house UI elements (points, streak, mood, decorations)
        function updatePetHouseUI() {
            const pointsEl = document.getElementById('petPoints');
            const streakEl = document.getElementById('petStreak');
            const feedBtn = document.getElementById('feedBtn');
            const petHouse = document.getElementById('petHouse');

            if (pointsEl) pointsEl.textContent = petData.points;
            if (streakEl) streakEl.textContent = petData.streak;

            if (petHouse) {
                petHouse.classList.toggle('blob-hungry', !petData.fedToday);
            }

            if (feedBtn) {
                if (petData.fedToday) {
                    feedBtn.classList.add('fed');
                    feedBtn.textContent = '‚úì Fed';
                } else {
                    feedBtn.classList.remove('fed');
                    feedBtn.textContent = 'üçΩÔ∏è Feed';
                }
            }

            renderHouseDecor();
        }

        // Render house decorations based on equipped items
        function renderHouseDecor() {
            const room = document.getElementById('petRoom');
            const decoLeft = document.getElementById('petDecoLeft');
            const decoRight = document.getElementById('petDecoRight');
            const roof = document.getElementById('petRoof');
            const floorOverlay = document.getElementById('floorOverlay');
            if (!room) return;

            // Floor CSS classes
            room.classList.remove('floor-grass', 'floor-wood');
            if (petData.equipped.floor === 'grass-floor') room.classList.add('floor-grass');
            else if (petData.equipped.floor === 'wood-floor') room.classList.add('floor-wood');

            // Floor SVG overlay
            if (floorOverlay) {
                const floorId = petData.equipped.floor;
                floorOverlay.innerHTML = floorId && DECOR_SVG[floorId] ? DECOR_SVG[floorId] : '';
            }

            // Background CSS classes
            room.classList.remove('bg-clouds', 'bg-stars', 'bg-night');
            if (petData.equipped.background === 'cloud-bg') room.classList.add('bg-clouds');
            else if (petData.equipped.background === 'stars-bg') room.classList.add('bg-stars');
            else if (petData.equipped.background === 'night-bg') room.classList.add('bg-night');

            // Left decoration SVG
            if (decoLeft) {
                const leftId = petData.equipped['deco-left'];
                decoLeft.innerHTML = leftId && DECOR_SVG[leftId] ? DECOR_SVG[leftId] : '';
            }

            // Right decoration SVG
            if (decoRight) {
                const rightId = petData.equipped['deco-right'];
                decoRight.innerHTML = rightId && DECOR_SVG[rightId] ? DECOR_SVG[rightId] : '';
            }

            // Roof SVG
            if (roof) {
                const roofId = petData.equipped.roof;
                roof.innerHTML = roofId && DECOR_SVG[roofId] ? DECOR_SVG[roofId] : '';
            }
        }

        // Export all user data as JSON backup
        window.exportAllData = async function() {
            try {
                const usersSnap = await getDocs(collection(db, 'users'));
                const backup = {
                    exportedAt: new Date().toISOString(),
                    version: 1,
                    users: {}
                };

                usersSnap.forEach(docSnap => {
                    backup.users[docSnap.id] = docSnap.data();
                });

                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0, 10);
                a.download = `flashcards-backup-${date}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed. Check browser console for details.');
            }
        }

        // Restore user data from a JSON backup file
        window.restoreFromFile = function(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    if (!backup.users || typeof backup.users !== 'object') {
                        alert('Invalid backup file ‚Äî no user data found.');
                        return;
                    }

                    const userCount = Object.keys(backup.users).length;
                    const exportDate = backup.exportedAt ? new Date(backup.exportedAt).toLocaleDateString() : 'unknown date';

                    if (!confirm(`Restore backup from ${exportDate}?\n\nThis contains ${userCount} user(s) and will overwrite their current data in Firestore.\n\nThis cannot be undone.`)) {
                        input.value = '';
                        return;
                    }

                    let restored = 0;
                    for (const [uid, userData] of Object.entries(backup.users)) {
                        await setDoc(doc(db, 'users', uid), userData);
                        restored++;
                    }

                    alert(`Restored ${restored} user(s) successfully.`);

                    // Reload current user's data if they were in the backup
                    if (currentUser && backup.users[currentUser.uid]) {
                        const userData = backup.users[currentUser.uid];
                        userProgress = userData.progress || {};
                        settings = userData.settings || { newCardsPerDay: 5, lastStudyDate: null, newCardsToday: {} };
                        loadDecks();
                    }

                } catch (error) {
                    console.error('Restore failed:', error);
                    alert('Restore failed: ' + error.message);
                }
                input.value = '';
            };
            reader.readAsText(file);
        }

        window.saveSettings = async function() {
            const newCardsInput = document.getElementById('newCardsPerDay');
            settings.newCardsPerDay = parseInt(newCardsInput.value) || 5;

            // Save to Firestore
            if (currentUser) {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    'settings': settings
                });
            }

            closeSettings();
            alert('Settings saved!');
        }

        window.resetProgress = async function() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to reset ALL your progress? This cannot be undone!')) {
                return;
            }

            if (!confirm('Really delete everything? Last chance!')) {
                return;
            }

            // Reset local state
            userProgress = {};
            settings.newCardsToday = {};
            settings.lastStudyDate = new Date().toDateString();

            // Reset in Firestore
            if (currentUser) {
                await updateDoc(doc(db, 'users', currentUser.uid), {
                    'progress': {},
                    'settings': settings
                });
            }

            // Refresh all deck stats
            const decks = ['biology', 'chemistry', 'physics', 'physics-eqns'];
            decks.forEach(deckId => updateDeckProgress(deckId));

            closeSettings();
            alert('‚úÖ All progress has been reset!');
        }

        // Select and start studying a deck
        window.selectDeck = async function(deckId, bypassLimit = false) {
            currentDeck = deckId;
            showScreen('study-screen');
            await loadDeckCards(deckId, bypassLimit);
            showNextCard();
        };

        // Study 5 more cards (bypass daily limit)
        window.studyFiveMore = async function(deckId) {
            await selectDeck(deckId, true);
        };

        // Load cards for a deck (placeholder - will parse .apkg next)
        async function loadDeckCards(deckId, bypassLimit = false) {
            const allCards = deckCards[deckId] || [];
            const now = Date.now();
            
            // Get deck-specific counter
            const deckNewCardsToday = settings.newCardsToday[deckId] || 0;
            
            // Filter cards based on new cards limit
            let newCardsCount = 0;
            studyQueue = allCards.filter(card => {
                const cardKey = `${deckId}_${card.id}`;
                const progress = userProgress[cardKey];
                
                // Check if card is due for review
                if (progress && progress.nextReview > now) {
                    return false; // Not due yet
                }
                
                const category = categorizeCard(cardKey);
                
                // Always include learning/mastered cards
                if (category !== 'unseen') {
                    return true;
                }
                
                // Limit new cards per day (unless bypassing)
                const limit = bypassLimit ? (deckNewCardsToday + 5) : settings.newCardsPerDay;
                if (deckNewCardsToday + newCardsCount < limit) {
                    newCardsCount++;
                    return true;
                }
                
                return false;
            });

            updateStats();
        }

        // Show next card
        function showNextCard() {
            if (studyQueue.length === 0) {
                document.getElementById('flashcardContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2 style="color: #667eea;">üéâ All done for today!</h2>
                        <p style="color: #666; margin-top: 20px;">Great work! Come back tomorrow for more reviews.</p>
                        <button class="btn" onclick="backToDecks()">Back to Decks</button>
                    </div>
                `;
                return;
            }
updateDeckProgress(currentDeck);
            
            currentCard = studyQueue[0];
            isFlipped = false;

            document.getElementById('flashcardContainer').innerHTML = `
                <div class="flashcard" onclick="flipCard()">
                    <div id="cardContent">${currentCard.front}</div>
                </div>
                <div class="hint">Click card or press SPACE to flip</div>
                <div id="ratingButtons" style="display: none;">
                    <div class="rating-buttons">
                        <button class="rating-btn rating-btn-1" onclick="rateCard(1)">
                            <div style="font-size: 1.5em;">1</div>
                            Again
                        </button>
                        <button class="rating-btn rating-btn-2" onclick="rateCard(2)">
                            <div style="font-size: 1.5em;">2</div>
                            Hard
                        </button>
                        <button class="rating-btn rating-btn-3" onclick="rateCard(3)">
                            <div style="font-size: 1.5em;">3</div>
                            Good
                        </button>
                        <button class="rating-btn rating-btn-4" onclick="rateCard(4)">
                            <div style="font-size: 1.5em;">4</div>
                            Easy
                        </button>
                    </div>
                    <div class="hint">Press 1-4 to rate</div>
                </div>
            `;
        }

        // Flip card
        window.flipCard = function() {
            if (isFlipped) return;
            isFlipped = true;
            
            document.getElementById('cardContent').innerHTML = currentCard.back;
            document.querySelector('.flashcard').classList.add('flipped');
            document.getElementById('ratingButtons').style.display = 'block';
        };

        // Rate card
        window.rateCard = async function(quality) {
            if (!isFlipped) return;

            // If rating is 0, re-add card to end of queue
            if (quality === 0) {
                studyQueue.push(studyQueue.shift());
                isFlipped = false;
                showCard();
                return;
            }

            // Get current card progress
            const cardKey = `${currentDeck}_${currentCard.id}`;
            const oldProgress = userProgress[cardKey];
            const wasUnseen = !oldProgress || oldProgress.repetitions === 0;
            
            const progress = oldProgress || {
                easiness: 2.5,
                repetitions: 0,
                interval: 0,
                nextReview: Date.now()
            };

            // Calculate new values using SM-2
            const newProgress = SM2.calculate(quality, progress.repetitions, progress.easiness, progress.interval);
            userProgress[cardKey] = newProgress;

            // Increment new cards counter if this was unseen
            if (wasUnseen) {
                if (!settings.newCardsToday[currentDeck]) {
                    settings.newCardsToday[currentDeck] = 0;
                }
                settings.newCardsToday[currentDeck]++;
            }

            // Award streak points on first card of the day
            const todayStr = new Date().toDateString();
            if (petData.lastStreakDate !== todayStr) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (petData.lastStreakDate === yesterday.toDateString()) {
                    petData.streak++;
                } else {
                    petData.streak = 1;
                }
                petData.points += petData.streak;
                petData.totalPoints += petData.streak;
                petData.lastStreakDate = todayStr;
                updatePetHouseUI();
            }

            // Save to Firestore
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, {
                [`progress.${cardKey}`]: newProgress,
                'settings': settings,
                'petData': petData
            });

            // Remove from queue and show next
            studyQueue.shift();
            updateStats();
            updateBadgeDisplay();
            showNextCard();
        };

        // Update stats
        function updateStats() {
            document.getElementById('newCount').textContent = studyQueue.length;
            document.getElementById('reviewCount').textContent = '0';
            document.getElementById('studiedToday').textContent = '0';
        }

        // Back to decks
        window.backToDecks = function() {
            showScreen('deck-selector');
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && !isFlipped) {
                e.preventDefault();
                flipCard();
            } else if (['1', '2', '3', '4'].includes(e.key) && isFlipped) {
                e.preventDefault();
                rateCard(parseInt(e.key));
            }
        });

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initializeUser().then(() => {
                    showScreen('deck-selector');
                    loadDecks();
                });
            } else {
                showScreen('login-screen');
            }
        });
    </script>
</body>
</html>
